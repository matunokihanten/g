<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>æ£’äººé–“ã‚«ã‚¦ãƒ³ãƒˆãƒã‚¹ã‚¿ãƒ¼</title>
  <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@500;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #6C5CE7;
      --secondary: #A29BFE;
      --accent: #FD79A8;
      --bg-gradient: linear-gradient(135deg, #74EBD5 0%, #9FACE6 100%);
      --surface: rgba(255, 255, 255, 0.85);
      --text: #2D3436;
    }

    * { box-sizing: border-box; touch-action: manipulation; }

    body {
      margin: 0; padding: 15px;
      background: var(--bg-gradient);
      font-family: 'M PLUS Rounded 1c', sans-serif;
      color: var(--text);
      display: flex; flex-direction: column; align-items: center;
      min-height: 100vh;
    }

    h1 {
      text-align: center; color: #fff; font-size: 1.8rem;
      text-shadow: 0 2px 4px rgba(0,0,0,0.2); margin: 5px 0 15px;
    }

    /* ã‚°ãƒ©ã‚¹ãƒ¢ãƒ¼ãƒ•ã‚£ã‚ºãƒ èª¿ã®ã‚³ãƒ³ãƒ†ãƒŠ */
    .glass-panel {
      background: var(--surface);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.5);
      padding: 15px; width: 100%; max-width: 800px;
      margin-bottom: 15px;
    }

    /* æƒ…å ±ãƒ˜ãƒƒãƒ€ãƒ¼ */
    #gameInfo {
      display: flex; justify-content: space-between; font-weight: bold;
      font-size: 1.1rem; color: var(--primary);
    }

    /* Canvas (é«˜ç”»è³ªå¯¾å¿œã®ãŸã‚å¹…100%æŒ‡å®š) */
    canvas {
      width: 100%; max-width: 800px; aspect-ratio: 4/3;
      background: #fff; border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
      display: block; cursor: crosshair; margin: 0 auto;
    }

    /* ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«å‘¨ã‚Š */
    .controls-row {
      display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; margin-top: 15px;
    }

    button {
      padding: 10px 20px; font-size: 1rem; font-family: inherit; font-weight: bold;
      background: var(--primary); color: #fff; border: none; border-radius: 8px;
      cursor: pointer; transition: transform 0.1s, background 0.2s, box-shadow 0.2s;
      box-shadow: 0 4px 6px rgba(108, 92, 231, 0.3);
    }

    button:hover { background: #5A4BCC; transform: translateY(-2px); box-shadow: 0 6px 12px rgba(108, 92, 231, 0.4); }
    button:active { transform: translateY(0); box-shadow: 0 2px 4px rgba(108, 92, 231, 0.3); }
    button.danger { background: var(--accent); box-shadow: 0 4px 6px rgba(253, 121, 168, 0.3); }
    button.danger:hover { background: #E84393; }

    /* å›ç­”ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
    #answerSection {
      display: flex; align-items: center; justify-content: center; gap: 10px;
    }
    
    #answerInput {
      width: 80px; padding: 10px; font-size: 1.2rem; font-family: inherit;
      border: 2px solid var(--secondary); border-radius: 8px; text-align: center;
      outline: none; transition: border-color 0.3s;
    }
    #answerInput:focus { border-color: var(--primary); }

    /* ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é ˜åŸŸ */
    #resultMessage {
      text-align: center; font-size: 1.2rem; font-weight: bold; min-height: 1.8rem;
      margin-top: 10px; transition: color 0.3s;
    }

    /* é›»å“é¢¨ã‚­ãƒ¼ãƒ‘ãƒƒãƒ‰ */
    #keypad {
      display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px;
      max-width: 250px; margin: 15px auto 0;
    }

    .key-btn {
      padding: 15px; font-size: 1.3rem; background: #fff; color: var(--text);
      border: 1px solid #E2E8F0; box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    .key-btn:hover { background: #F8FAFC; color: var(--primary); }
    .key-enter { grid-column: span 2; background: var(--secondary); color: white; border: none; }
    .key-enter:hover { background: var(--primary); }

    /* ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ç”»é¢ */
    #overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(5px);
      display: none; justify-content: center; align-items: center; z-index: 100;
    }
    .overlay-content {
      background: #fff; padding: 30px; border-radius: 16px; text-align: center;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2); animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    @keyframes popIn { 0% { transform: scale(0.8); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }

    .hidden { display: none !important; }
  </style>
</head>
<body>

  <h1>æ£’äººé–“ã‚«ã‚¦ãƒ³ãƒˆãƒã‚¹ã‚¿ãƒ¼</h1>

  <div class="glass-panel">
    <div id="gameInfo">
      <span id="scoreDisplay">ã‚¹ã‚³ã‚¢: 0</span>
      <span id="timeDisplay">æ™‚é–“: 30s</span>
      <span id="highScoreDisplay">ãƒã‚¤ã‚¹ã‚³ã‚¢: 0</span>
    </div>
  </div>

  <canvas id="gameCanvas"></canvas>

  <div id="startControls" class="controls-row">
    <button id="btnNormal">â± é€šå¸¸ãƒ¢ãƒ¼ãƒ‰</button>
    <button id="btnRelax">â˜• ãƒªãƒ©ãƒƒã‚¯ã‚¹ãƒ¢ãƒ¼ãƒ‰</button>
  </div>

  <div id="playControls" class="glass-panel hidden">
    <div id="answerSection">
      <input type="number" id="answerInput" placeholder="ä½•äººï¼Ÿ" readonly>
      <button id="btnSubmit">å›ç­”</button>
    </div>
    <div id="resultMessage"></div>

    <div id="keypad">
      <button class="key-btn" data-val="7">7</button>
      <button class="key-btn" data-val="8">8</button>
      <button class="key-btn" data-val="9">9</button>
      <button class="key-btn" data-val="4">4</button>
      <button class="key-btn" data-val="5">5</button>
      <button class="key-btn" data-val="6">6</button>
      <button class="key-btn" data-val="1">1</button>
      <button class="key-btn" data-val="2">2</button>
      <button class="key-btn" data-val="3">3</button>
      <button class="key-btn" data-val="C">C</button>
      <button class="key-btn" data-val="0">0</button>
      <button class="key-btn" data-val="<">âŒ«</button>
    </div>
    
    <div class="controls-row" style="margin-top: 15px;">
      <button id="btnEndGame" class="danger">ã‚²ãƒ¼ãƒ çµ‚äº†</button>
    </div>
  </div>

  <div id="overlay">
    <div class="overlay-content">
      <h2 style="margin-top:0;">ã‚²ãƒ¼ãƒ çµ‚äº†ï¼</h2>
      <p style="font-size:1.2rem;">æœ€çµ‚ã‚¹ã‚³ã‚¢: <strong id="finalScore" style="color:var(--primary); font-size:1.5rem;">0</strong></p>
      <button id="btnRestart" style="margin-top: 15px;">ã‚‚ã†ä¸€åº¦ãƒ—ãƒ¬ã‚¤</button>
    </div>
  </div>

  <script>
    // ==========================================
    // éŸ³å£°ã‚¢ã‚»ãƒƒãƒˆ (å…ƒã®URLã‚’æ´»ç”¨)
    // ==========================================
    const sounds = {
      correct: new Audio('https://www.soundeffect-labo.info/sound/button/mp3/button-touch1.mp3'),
      incorrect: new Audio('https://www.soundeffect-labo.info/sound/kanetuki/mp3/kanetuki-usudokoro.mp3'),
      gameOver: new Audio('https://www.soundeffect-labo.info/sound/se/mp3/se_maoudamashii_system23.mp3'),
      start: new Audio('https://www.soundeffect-labo.info/sound/se/mp3/se_maoudamashii_system33.mp3')
    };

    // ==========================================
    // ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«ã‚·ã‚¹ãƒ†ãƒ ï¼ˆã‚¨ãƒ•ã‚§ã‚¯ãƒˆæ¼”å‡ºï¼‰
    // ==========================================
    class Particle {
      constructor(x, y, color) {
        this.x = x; this.y = y;
        const angle = Math.random() * Math.PI * 2;
        const speed = Math.random() * 4 + 2;
        this.vx = Math.cos(angle) * speed;
        this.vy = Math.sin(angle) * speed;
        this.life = 1.0; // å¯¿å‘½
        this.color = color;
      }
      update(dt) {
        this.x += this.vx;
        this.y += this.vy;
        this.vy += 0.1; // ã‚†ã‚‹ã‚„ã‹ãªé‡åŠ›
        this.life -= dt * 1.5;
      }
      draw(ctx) {
        ctx.globalAlpha = Math.max(0, this.life);
        ctx.fillStyle = this.color;
        ctx.beginPath();
        ctx.arc(this.x, this.y, 3, 0, Math.PI * 2);
        ctx.fill();
        ctx.globalAlpha = 1.0;
      }
    }

    // ==========================================
    // æ£’äººé–“ã‚¯ãƒ©ã‚¹
    // ==========================================
    class StickFigure {
      constructor(canvasWidth, canvasHeight) {
        this.x = 20 + Math.random() * (canvasWidth - 40);
        this.y = 20 + Math.random() * (canvasHeight - 40);
        const speed = 40 + Math.random() * 40;
        const angle = Math.random() * Math.PI * 2;
        this.vx = Math.cos(angle) * speed;
        this.vy = Math.sin(angle) * speed;
        
        this.phase = Math.random() * Math.PI * 2; // æ­©è¡Œã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚ºãƒ¬
        this.isMarked = false; // ã‚¯ãƒªãƒƒã‚¯ã§æ•°ãˆãŸã‹ã©ã†ã‹ã®ãƒ•ãƒ©ã‚°
        this.color = '#2D3436';
        this.hitRadius = 25; // ã‚¯ãƒªãƒƒã‚¯åˆ¤å®šã®åºƒã•
      }

      update(dt, canvasWidth, canvasHeight) {
        this.x += this.vx * dt;
        this.y += this.vy * dt;

        // å£ã§ã®ãƒã‚¦ãƒ³ãƒ‰
        if (this.x < 15 || this.x > canvasWidth - 15) { this.vx *= -1; this.x = Math.max(15, Math.min(this.x, canvasWidth - 15)); }
        if (this.y < 30 || this.y > canvasHeight - 30) { this.vy *= -1; this.y = Math.max(30, Math.min(this.y, canvasHeight - 30)); }
      }

      draw(ctx, time) {
        const t = (time / 1000) * 10 + this.phase;
        const swing = Math.sin(t) * (Math.PI / 5);

        ctx.strokeStyle = this.isMarked ? '#FD79A8' : this.color;
        ctx.fillStyle = this.isMarked ? '#FD79A8' : this.color;
        ctx.lineWidth = 2;
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';

        // é ­
        ctx.beginPath();
        ctx.arc(this.x, this.y - 15, 6, 0, Math.PI * 2);
        ctx.fill();

        // èƒ´ä½“
        ctx.beginPath();
        ctx.moveTo(this.x, this.y - 9);
        ctx.lineTo(this.x, this.y + 10);
        ctx.stroke();

        // è…•ã¨è„šã®æç”»è£œåŠ©é–¢æ•°
        const drawLimb = (startX, startY, length, angle) => {
          ctx.beginPath();
          ctx.moveTo(startX, startY);
          ctx.lineTo(startX + Math.cos(angle) * length, startY + Math.sin(angle) * length);
          ctx.stroke();
        };

        // è…• (è‚©ã‹ã‚‰)
        drawLimb(this.x, this.y - 5, 12, Math.PI / 2 + swing);
        drawLimb(this.x, this.y - 5, 12, Math.PI / 2 - swing);

        // è„š (è…°ã‹ã‚‰)
        drawLimb(this.x, this.y + 10, 15, Math.PI / 2 + swing);
        drawLimb(this.x, this.y + 10, 15, Math.PI / 2 - swing);

        // ãƒãƒ¼ã‚¯æ¸ˆã¿ãªã‚‰é ­ã®ä¸Šã«ãƒã‚§ãƒƒã‚¯ãƒãƒ¼ã‚¯ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³æ¼”å‡ºï¼‰
        if (this.isMarked) {
          ctx.font = '12px Arial';
          ctx.fillStyle = '#FD79A8';
          ctx.fillText('âœ“', this.x - 5, this.y - 25);
        }
      }

      // ã‚¯ãƒªãƒƒã‚¯åˆ¤å®š (ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹ã®ä»£ã‚ã‚Šã«å††å½¢åˆ¤å®šã§ã‚·ãƒ³ãƒ—ãƒ«ã«)
      isHit(clickX, clickY) {
        const dx = this.x - clickX;
        const dy = (this.y - 5) - clickY; // ä¸­å¿ƒã‚’å°‘ã—ä¸Šã«
        return Math.sqrt(dx * dx + dy * dy) < this.hitRadius;
      }
    }

    // ==========================================
    // ãƒ¡ã‚¤ãƒ³ã‚·ã‚¹ãƒ†ãƒ ï¼ˆã‚²ãƒ¼ãƒ ç®¡ç†ï¼‰
    // ==========================================
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    
    // é«˜ç”»è³ª(Retina)å¯¾å¿œå‡¦ç†
    function resizeCanvas() {
      const rect = canvas.getBoundingClientRect();
      const dpr = window.devicePixelRatio || 1;
      canvas.width = rect.width * dpr;
      canvas.height = rect.height * dpr;
      ctx.scale(dpr, dpr);
      return { w: rect.width, h: rect.height };
    }

    const GameState = {
      figures: [],
      particles: [],
      actualCount: 0,
      score: 0,
      highScore: parseInt(localStorage.getItem('stickHeroHighScore')) || 0,
      timeLeft: 30,
      mode: 'normal', // 'normal' or 'relax'
      isRunning: false,
      isAnswering: false,
      lastTime: 0,
      timerId: null,
      canvasSize: { w: 800, h: 600 }
    };

    // UIè¦ç´ ã®å–å¾—
    const UI = {
      score: document.getElementById('scoreDisplay'),
      time: document.getElementById('timeDisplay'),
      highScore: document.getElementById('highScoreDisplay'),
      startControls: document.getElementById('startControls'),
      playControls: document.getElementById('playControls'),
      input: document.getElementById('answerInput'),
      msg: document.getElementById('resultMessage'),
      overlay: document.getElementById('overlay')
    };

    UI.highScore.textContent = `ãƒã‚¤ã‚¹ã‚³ã‚¢: ${GameState.highScore}`;

    // --- ã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ— ---
    function animate(now) {
      if (!GameState.isRunning) return;
      const dt = (now - GameState.lastTime) / 1000;
      GameState.lastTime = now;

      // ç”»é¢ã‚¯ãƒªã‚¢
      ctx.clearRect(0, 0, GameState.canvasSize.w, GameState.canvasSize.h);

      // æ£’äººé–“ã®æ›´æ–°ã¨æç”»
      GameState.figures.forEach(fig => {
        fig.update(dt, GameState.canvasSize.w, GameState.canvasSize.h);
        fig.draw(ctx, now);
      });

      // ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«ã®æ›´æ–°ã¨æç”»
      for (let i = GameState.particles.length - 1; i >= 0; i--) {
        const p = GameState.particles[i];
        p.update(dt);
        p.draw(ctx);
        if (p.life <= 0) GameState.particles.splice(i, 1);
      }

      requestAnimationFrame(animate);
    }

    // --- ã‚²ãƒ¼ãƒ æ“ä½œ ---
    function spawnParticles(x, y, color, count) {
      for (let i = 0; i < count; i++) {
        GameState.particles.push(new Particle(x, y, color));
      }
    }

    function generateQuestion() {
      GameState.canvasSize = resizeCanvas();
      GameState.actualCount = Math.floor(Math.random() * 15) + 3; // 3ã€œ17äºº
      GameState.figures = [];
      for (let i = 0; i < GameState.actualCount; i++) {
        GameState.figures.push(new StickFigure(GameState.canvasSize.w, GameState.canvasSize.h));
      }
      
      UI.input.value = '';
      UI.msg.textContent = '';
      GameState.isAnswering = false;
    }

    function startGame(mode) {
      sounds.start.play().catch(()=>{});
      GameState.mode = mode;
      GameState.score = 0;
      GameState.timeLeft = 30;
      GameState.isRunning = true;
      GameState.particles = [];
      
      UI.score.textContent = `ã‚¹ã‚³ã‚¢: 0`;
      UI.startControls.classList.add('hidden');
      UI.playControls.classList.remove('hidden');
      UI.overlay.style.display = 'none';

      if (mode === 'relax') {
        UI.time.textContent = `æ™‚é–“: ç„¡åˆ¶é™`;
      } else {
        updateTimerDisplay();
        GameState.timerId = setInterval(() => {
          GameState.timeLeft--;
          updateTimerDisplay();
          if (GameState.timeLeft <= 0) endGame();
        }, 1000);
      }

      generateQuestion();
      GameState.lastTime = performance.now();
      requestAnimationFrame(animate);
    }

    function updateTimerDisplay() {
      UI.time.textContent = `æ™‚é–“: ${GameState.timeLeft}s`;
      UI.time.style.color = GameState.timeLeft <= 5 ? 'var(--accent)' : 'var(--primary)';
    }

    function endGame() {
      sounds.gameOver.play().catch(()=>{});
      GameState.isRunning = false;
      clearInterval(GameState.timerId);
      
      document.getElementById('finalScore').textContent = GameState.score;
      UI.overlay.style.display = 'flex';
      UI.playControls.classList.add('hidden');
      UI.startControls.classList.remove('hidden');
    }

    function checkAnswer() {
      if (GameState.isAnswering || !GameState.isRunning || UI.input.value === '') return;
      GameState.isAnswering = true;
      const ans = parseInt(UI.input.value);

      if (ans === GameState.actualCount) {
        sounds.correct.play().catch(()=>{});
        UI.msg.textContent = `å¤§æ­£è§£ï¼ğŸ‰ (${GameState.actualCount}äºº)`;
        UI.msg.style.color = 'var(--primary)';
        GameState.score += GameState.actualCount * 10;
        
        // ç”»é¢ä¸­å¤®ã§æ­£è§£ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«
        spawnParticles(GameState.canvasSize.w/2, GameState.canvasSize.h/2, '#FDCB6E', 50);

        if (GameState.mode === 'normal') {
          GameState.timeLeft = Math.min(30, GameState.timeLeft + 3); // ãƒœãƒ¼ãƒŠã‚¹æ™‚é–“
          updateTimerDisplay();
        }
      } else {
        sounds.incorrect.play().catch(()=>{});
        UI.msg.textContent = `æ®‹å¿µâ€¦æ­£è§£ã¯ ${GameState.actualCount}äºº ã§ã—ãŸ`;
        UI.msg.style.color = 'var(--accent)';
      }

      UI.score.textContent = `ã‚¹ã‚³ã‚¢: ${GameState.score}`;
      if (GameState.score > GameState.highScore) {
        GameState.highScore = GameState.score;
        localStorage.setItem('stickHeroHighScore', GameState.highScore);
        UI.highScore.textContent = `ãƒã‚¤ã‚¹ã‚³ã‚¢: ${GameState.highScore}`;
      }

      setTimeout(() => {
        if (GameState.isRunning) generateQuestion();
      }, 1500);
    }

    // --- ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ ---
    document.getElementById('btnNormal').addEventListener('click', () => startGame('normal'));
    document.getElementById('btnRelax').addEventListener('click', () => startGame('relax'));
    document.getElementById('btnEndGame').addEventListener('click', endGame);
    document.getElementById('btnRestart').addEventListener('click', () => UI.overlay.style.display = 'none');
    document.getElementById('btnSubmit').addEventListener('click', checkAnswer);

    // Canvasã‚¯ãƒªãƒƒã‚¯ã§ã®ãƒãƒ¼ã‚­ãƒ³ã‚°
    canvas.addEventListener('pointerdown', (e) => {
      if (!GameState.isRunning || GameState.isAnswering) return;
      const rect = canvas.getBoundingClientRect();
      const scaleX = canvas.width / rect.width / (window.devicePixelRatio || 1);
      const scaleY = canvas.height / rect.height / (window.devicePixelRatio || 1);
      
      const clickX = (e.clientX - rect.left) * scaleX;
      const clickY = (e.clientY - rect.top) * scaleY;

      // å¾Œã‚ã‹ã‚‰åˆ¤å®šï¼ˆæ‰‹å‰ã«æç”»ã•ã‚Œã¦ã„ã‚‹ã‚‚ã®ã‚’å„ªå…ˆï¼‰
      for (let i = GameState.figures.length - 1; i >= 0; i--) {
        const fig = GameState.figures[i];
        if (!fig.isMarked && fig.isHit(clickX, clickY)) {
          fig.isMarked = true;
          spawnParticles(fig.x, fig.y, '#FD79A8', 10); // ã‚¯ãƒªãƒƒã‚¯ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
          break; // 1å›ã®ã‚¯ãƒªãƒƒã‚¯ã§1ä½“ã ã‘ãƒãƒ¼ã‚¯
        }
      }
    });

    // ã‚­ãƒ¼ãƒ‘ãƒƒãƒ‰ã®å…¥åŠ›åˆ¶å¾¡
    document.querySelectorAll('.key-btn').addEventListener = function() {}; // ignore
    document.getElementById('keypad').addEventListener('click', (e) => {
      if (!e.target.classList.contains('key-btn') || GameState.isAnswering) return;
      const val = e.target.getAttribute('data-val');
      
      if (val === 'C') UI.input.value = '';
      else if (val === '<') UI.input.value = UI.input.value.slice(0, -1);
      else UI.input.value += val;
    });

    // ãƒªã‚µã‚¤ã‚ºæ™‚ã®å†è¨ˆç®—
    window.addEventListener('resize', () => {
      if (GameState.isRunning) GameState.canvasSize = resizeCanvas();
    });

    // åˆæœŸåŒ–
    resizeCanvas();
  </script>
</body>
</html>
