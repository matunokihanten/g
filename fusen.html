<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>付箋掲示板（日本語ボード＋検索・進化版）</title>
  <style>
    html, body {
      margin: 0; padding: 0;
      width: 100%; height: 100%;
      overflow: hidden;
      font-family: sans-serif;
    }
    /* ツールバー */
    #toolbar {
      position: fixed; top: 0; left: 0;
      width: 100%; height: 40px;
      background: #333; color: #fff;
      display: flex; align-items: center;
      padding: 0 10px; box-sizing: border-box;
      z-index: 2000;
    }
    #toolbar select,
    #toolbar button,
    #toolbar input[type="text"] {
      margin-right: 8px;
      padding: 4px 8px;
      font-size: 14px;
      border: none; border-radius: 4px;
      cursor: pointer;
    }
    #toolbar select,
    #toolbar input[type="text"] {
      background: #555; color: #fff;
    }
    #toolbar button {
      background: #007acc; color: #fff;
    }
    /* パン・ズーム用ラッパー */
    #wrapper {
      position: absolute;
      top: 40px; bottom: 0; left: 0; right: 0;
      overflow: hidden;
      background: #f0f0f0;
      cursor: grab;
    }
    /* 付箋ボード */
    #board {
      position: absolute;
      top: 0; left: 0;
      transform-origin: 0 0;
    }
    /* 付箋スタイル */
    .note {
      position: absolute;
      padding: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.3);
      border: 1px solid #ccc;
      white-space: pre-wrap;
      resize: both;
      overflow: auto;
      cursor: move;
      background: #fffa65;
    }
    .close-btn {
      position: absolute;
      top: 2px; right: 4px;
      font-size: 14px; color: #333;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div id="toolbar">
    <select id="boardSelect"></select>
    <button id="arrangeBtn">整列</button>
    <input type="text" id="searchInput" placeholder="検索ワード">
    <button id="exportBtn">エクスポート</button>
    <button id="importBtn">インポート</button>
    <input type="file" id="importFile" accept=".json" style="display:none">
    <button id="addBtn">付箋を追加</button>
  </div>

  <div id="wrapper">
    <div id="board"></div>
  </div>

  <script>
  (function(){
    const boards = ['デフォルト', '仕事用', 'プライベート', 'アイデア'];
    let currentBoard = boards[0];
    let notes = [];
    let scale = 1, translateX = 0, translateY = 0;
    let isPanning = false, panStartX = 0, panStartY = 0, panInitX = 0, panInitY = 0;

    const wrapper    = document.getElementById('wrapper');
    const board      = document.getElementById('board');
    const sel        = document.getElementById('boardSelect');
    const addBtn     = document.getElementById('addBtn');
    const arrBtn     = document.getElementById('arrangeBtn');
    const expBtn     = document.getElementById('exportBtn');
    const impBtn     = document.getElementById('importBtn');
    const impFile    = document.getElementById('importFile');
    const searchInput= document.getElementById('searchInput');

    function init(){
      // ボード選択肢セット
      boards.forEach(name => {
        const opt = document.createElement('option');
        opt.value = name; opt.innerText = name;
        sel.appendChild(opt);
      });
      sel.onchange = switchBoard;

      // パン&ズーム
      wrapper.addEventListener('mousedown', startPan);
      document.addEventListener('mousemove', doPan);
      document.addEventListener('mouseup', endPan);
      wrapper.addEventListener('wheel', doZoom, { passive: false });

      // ボタンクリック
      addBtn.onclick     = addNote;
      arrBtn.onclick     = arrangeNotes;
      expBtn.onclick     = exportNotes;
      impBtn.onclick     = ()=> impFile.click();
      impFile.onchange   = importNotes;
      searchInput.oninput= filterNotes;

      switchBoard();
    }

    function switchBoard(){
      currentBoard = sel.value;
      searchInput.value = '';
      notes = loadNotes();
      renderAll();
    }

    function loadNotes(){
      return JSON.parse(localStorage.getItem('stickynotes_' + currentBoard) || '[]');
    }

    function saveNotes(){
      localStorage.setItem('stickynotes_' + currentBoard, JSON.stringify(notes));
    }

    function renderAll(){
      board.innerHTML = '';
      notes.forEach(renderNote);
      filterNotes();
    }

    function renderNote(n){
      const el = document.createElement('div');
      el.className = 'note';
      el.dataset.id = n.id;
      applyStyle(el, n);
      el.innerText = n.content;

      const btn = document.createElement('span');
      btn.className = 'close-btn';
      btn.innerText = '✕';
      btn.onclick = () => deleteNote(n.id, el);
      el.appendChild(btn);

      makeDraggable(el);
      makeEditable(el);
      observeResize(el);

      board.appendChild(el);
    }

    function applyStyle(el, n){
      el.style.left       = n.x + 'px';
      el.style.top        = n.y + 'px';
      el.style.width      = n.width  + 'px';
      el.style.height     = n.height + 'px';
      el.style.background = n.color;
      el.style.zIndex     = n.zIndex || 1;
    }

    function addNote(){
      const text = prompt('メモ内容を入力');
      if (!text) return;
      const cols = ['#fffa65','#ff9ff3','#feca57','#48dbfb','#1dd1a1'];
      const color= cols[Math.floor(Math.random()*cols.length)];
      const note = {
        id:      Date.now() + '' + Math.floor(Math.random()*999),
        content: text, x:20, y:20,
        width:200, height:150, color:color,
        zIndex:1
      };
      notes.push(note);
      saveNotes();
      renderNote(note);
      filterNotes();
    }

    function makeDraggable(el){
      let ox, oy, sx, sy;
      el.onmousedown = e => {
        if (e.target !== el) return;
        // z-index 前面
        notes.forEach(n=>{ if(n.id==el.dataset.id) n.zIndex = ++n.zIndex; });
        el.style.zIndex = notes.find(n=>n.id==el.dataset.id).zIndex;
        saveNotes();

        ox = e.clientX; oy = e.clientY;
        sx = parseInt(el.style.left); sy = parseInt(el.style.top);
        document.onmousemove = move;
        document.onmouseup   = drop;
      };
      function move(e){
        el.style.left = sx + (e.clientX-ox) + 'px';
        el.style.top  = sy + (e.clientY-oy) + 'px';
      }
      function drop(){
        document.onmousemove = null; document.onmouseup = null;
        updateNote(el, {
          x: parseInt(el.style.left),
          y: parseInt(el.style.top)
        });
      }
    }

    function makeEditable(el){
      el.ondblclick = ()=>{
        el.contentEditable = true;
        el.focus();
      };
      el.onblur = ()=>{
        if (!el.contentEditable) return;
        el.contentEditable = false;
        updateNote(el, { content: el.innerText });
        filterNotes();
      };
    }

    function observeResize(el){
      new ResizeObserver(entries=>{
        entries.forEach(en=>{
          updateNote(el,{
            width: Math.round(en.contentRect.width),
            height:Math.round(en.contentRect.height)
          });
        });
      }).observe(el);
    }

    function updateNote(el, props){
      const id = el.dataset.id;
      const note = notes.find(n=>n.id===id);
      if (!note) return;
      Object.assign(note, props);
      saveNotes();
    }

    function deleteNote(id, el){
      if (!confirm('本当に削除しますか？')) return;
      notes = notes.filter(n=>n.id!==id);
      saveNotes();
      board.removeChild(el);
    }

    function arrangeNotes(){
      const margin = 20;
      const cellW = 250, cellH = 200;
      const wrapW = wrapper.clientWidth;
      const cols  = Math.max(1, Math.floor(wrapW / cellW));
      notes.forEach((n,i)=>{
        n.x = margin + (i % cols) * cellW;
        n.y = margin + Math.floor(i/cols) * cellH;
      });
      saveNotes();
      renderAll();
    }

    function filterNotes(){
      const term = searchInput.value.trim().toLowerCase();
      board.querySelectorAll('.note').forEach(el=>{
        const note = notes.find(n=>n.id===el.dataset.id);
        el.style.display = note.content.toLowerCase().includes(term) ? '' : 'none';
      });
    }

    function exportNotes(){
      const data = JSON.stringify(notes, null, 2);
      const blob = new Blob([data], { type:'application/json' });
      const url  = URL.createObjectURL(blob);
      const a    = document.createElement('a');
      a.href       = url;
      a.download   = `stickynotes_${currentBoard}.json`;
      a.click();
      URL.revokeObjectURL(url);
    }

    function importNotes(e){
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = ev => {
        try {
          const arr = JSON.parse(ev.target.result);
          if (!Array.isArray(arr)) throw '';
          notes = arr;
          saveNotes();
          renderAll();
        } catch {
          alert('JSON形式が不正です');
        }
      };
      reader.readAsText(file);
      impFile.value = '';
    }

    function startPan(e){
      if(e.target !== wrapper) return;
      isPanning = true;
      panStartX = e.clientX; panStartY = e.clientY;
      panInitX  = translateX; panInitY  = translateY;
      wrapper.style.cursor = 'grabbing';
    }
    function doPan(e){
      if (!isPanning) return;
      translateX = panInitX + (e.clientX - panStartX);
      translateY = panInitY + (e.clientY - panStartY);
      updateTransform();
    }
    function endPan(){
      if (!isPanning) return;
      isPanning = false;
      wrapper.style.cursor = 'grab';
    }
    function doZoom(e){
      if (!e.ctrlKey) return;
      e.preventDefault();
      const factor = e.deltaY > 0 ? 0.9 : 1.1;
      scale = Math.min(3, Math.max(0.3, scale * factor));
      updateTransform();
    }
    function updateTransform(){
      board.style.transform =
        `translate(${translateX}px,${translateY}px) scale(${scale})`;
    }

    init();
  })();
  </script>
</body>
</html>
