<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç©¶æ¥µã®ãƒ’ãƒƒãƒˆã‚¢ãƒ³ãƒ‰ãƒ–ãƒ­ãƒ¼ã‚²ãƒ¼ãƒ </title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    /* CSSã‚«ã‚¹ã‚¿ãƒ ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ */
    :root {
      --primary-color: #4CAF50; /* ç·‘ */
      --primary-dark-color: #388E3C; /* æ¿ƒã„ç·‘ */
      --secondary-color: #2196F3; /* é’ */
      --secondary-dark-color: #1976D2; /* æ¿ƒã„é’ */
      --accent-color: #FFC107; /* é»„ */
      --text-color: #333;
      --light-bg: #f9f9f9;
      --dark-bg: #e0e0e0;
      --border-color: #ddd;
      --error-color: #EF5350; /* èµ¤ */
      --success-color: #66BB6A; /* ç·‘ */
      --shadow-light: 0 4px 12px rgba(0, 0, 0, 0.1);
      --shadow-medium: 0 6px 16px rgba(0, 0, 0, 0.15);
      --shadow-deep: 0 8px 20px rgba(0, 0, 0, 0.2);
    }

    body {
      font-family: 'Roboto', sans-serif;
      background: linear-gradient(135deg, #A8CABA 0%, #5D4157 100%); /* è±ªè¯ãªã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ */
      margin: 0;
      padding: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      color: var(--text-color);
      overflow-y: auto; /* ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãŒã¯ã¿å‡ºãŸå ´åˆã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ« */
    }

    .container {
      background: var(--light-bg);
      padding: 30px 40px;
      box-shadow: var(--shadow-medium);
      border-radius: 12px;
      text-align: center;
      width: 100%;
      max-width: 400px; /* æœ€å¤§å¹…ã‚’èª¿æ•´ */
      position: relative;
      overflow: hidden; /* ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã®ãŸã‚ã®è¨­å®š */
    }

    h2 {
      margin-bottom: 25px;
      color: var(--primary-dark-color);
      font-family: 'Montserrat', sans-serif;
      font-size: 2em;
      letter-spacing: 1px;
    }

    .digit-select {
      margin-bottom: 20px;
      background: var(--dark-bg);
      padding: 10px 15px;
      border-radius: 8px;
      box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.05);
    }
    .digit-select p {
      margin: 0 0 10px;
      font-weight: bold;
      color: var(--text-color);
    }
    .digit-select label {
      margin: 0 8px;
      font-size: 17px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
    }
    .digit-select input[type="radio"] {
      margin-right: 5px;
      transform: scale(1.2); /* ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã‚’å¤§ãã */
      accent-color: var(--primary-color); /* ãƒã‚§ãƒƒã‚¯è‰²ã‚’å¤‰æ›´ */
    }

    .info-text {
      color: var(--text-color);
      margin-bottom: 10px; /* èª¿æ•´ */
      font-size: 1.1em;
    }

    #result { /* ã“ã“ã‚’inputãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ã™ãä¸Šã«ç§»å‹•ã—ãŸã®ã§ã€margin-bottomã‚’èª¿æ•´ */
      font-size: 24px;
      color: var(--primary-dark-color);
      min-height: 30px;
      margin-bottom: 10px; /* inputãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¨ã®é–“éš”ã‚’èª¿æ•´ */
      font-weight: bold;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
    }

    input[type="text"] {
      width: calc(100% - 20px); /* Paddingè€ƒæ…® */
      padding: 12px;
      margin-bottom: 0px; /* èª¿æ•´: ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¨ã®é–“éš” */
      border: 2px solid var(--border-color);
      border-radius: 8px;
      font-size: 20px;
      text-align: center;
      font-weight: bold;
      letter-spacing: 2px;
      transition: border-color 0.3s ease, box-shadow 0.3s ease;
      background-color: #fff;
    }
    input[type="text"]:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.2);
    }
    /* å…¥åŠ›ã‚¨ãƒ©ãƒ¼æ™‚ã®ã‚¹ã‚¿ã‚¤ãƒ«ã¨ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
    input[type="text"].input-error {
      border-color: var(--error-color);
      box-shadow: 0 0 0 3px rgba(239, 83, 80, 0.2);
      animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both;
      transform: translate3d(0, 0, 0);
      backface-visibility: hidden;
      perspective: 1000px;
    }
    @keyframes shake {
      10%, 90% { transform: translate3d(-1px, 0, 0); }
      20%, 80% { transform: translate3d(2px, 0, 0); }
      30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
      40%, 60% { transform: translate3d(4px, 0, 0); }
    }

    .error-message {
      color: var(--error-color);
      font-size: 15px;
      min-height: 20px;
      margin-bottom: 10px; /* èª¿æ•´: ã‚­ãƒ¼ãƒ‘ãƒƒãƒ‰ã¨ã®é–“éš” */
      font-weight: bold;
    }

    /* æ•°å­—ã‚­ãƒ¼ãƒ‘ãƒƒãƒ‰ */
    .keypad {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-top: 10px; /* èª¿æ•´: å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰/ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¨ã®é–“éš” */
      margin-bottom: 20px; /* èª¿æ•´: ä»–ã®ãƒœã‚¿ãƒ³ã¨ã®é–“éš” */
    }
    .keypad button {
      background-color: var(--secondary-color);
      color: white;
      font-size: 24px;
      padding: 15px 0;
      border-radius: 8px;
      box-shadow: var(--shadow-light);
      /* ã‚­ãƒ¼ãƒ‘ãƒƒãƒ‰ãƒœã‚¿ãƒ³ã«å›ºæœ‰ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’é©ç”¨ã™ã‚‹ãŸã‚ã€
         æ±ç”¨ã®buttonã‚¹ã‚¿ã‚¤ãƒ«ã‚’ä¸€éƒ¨ä¸Šæ›¸ã */
      min-width: unset; /* æ±ç”¨buttonã®min-widthã‚’è§£é™¤ */
    }
    .keypad button:hover:not(:disabled) {
      background-color: var(--secondary-dark-color);
    }
    .keypad button.key-clear {
      background-color: #FF5722; /* ã‚ªãƒ¬ãƒ³ã‚¸ */
    }
    .keypad button.key-clear:hover:not(:disabled) {
      background-color: #E64A19;
    }
    .keypad button.key-back {
      background-color: #607D8B; /* ã‚°ãƒ¬ã‚¤ */
    }
    .keypad button.key-back:hover:not(:disabled) {
      background-color: #455A64;
    }
    .keypad button:disabled {
      background-color: var(--dark-bg);
      color: #999;
    }

    .buttons {
      display: grid; /* ã‚°ãƒªãƒƒãƒ‰ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã«å¤‰æ›´ */
      grid-template-columns: repeat(2, 1fr); /* 2åˆ— */
      gap: 12px; /* ãƒœã‚¿ãƒ³é–“ã®ã‚¹ãƒšãƒ¼ã‚¹ */
      margin-bottom: 20px;
    }
    button {
      padding: 12px 18px;
      font-size: 17px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      background-color: var(--primary-color);
      color: #fff;
      transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
      font-weight: bold;
      display: flex; /* ã‚¢ã‚¤ã‚³ãƒ³ã¨ãƒ†ã‚­ã‚¹ãƒˆã‚’ä¸­å¤®æƒãˆ */
      align-items: center;
      justify-content: center;
      gap: 8px; /* ã‚¢ã‚¤ã‚³ãƒ³ã¨ãƒ†ã‚­ã‚¹ãƒˆã®é–“éš” */
      box-shadow: var(--shadow-light);
    }
    button i {
        font-size: 1.1em;
    }
    button:hover:not(:disabled) {
      background-color: var(--primary-dark-color);
      transform: translateY(-2px);
      box-shadow: var(--shadow-medium);
    }
    button:active:not(:disabled) {
      transform: translateY(0);
      box-shadow: var(--shadow-light);
    }
    button:disabled {
      background-color: var(--dark-bg);
      color: #999;
      cursor: not-allowed;
      opacity: 0.7;
      box-shadow: none;
    }

    /* ç‰¹å®šã®ãƒœã‚¿ãƒ³ã®è‰²åˆ†ã‘ */
    #numericHintButton, #digitHighlightButton,
    #revealDigitHintButton, #parityHintButton, #rangeHintButton {
      background-color: var(--secondary-color);
    }
    #numericHintButton:hover:not(:disabled), #digitHighlightButton:hover:not(:disabled),
    #revealDigitHintButton:hover:not(:disabled), #parityHintButton:hover:not(:disabled), #rangeHintButton:hover:not(:disabled) {
      background-color: var(--secondary-dark-color);
    }
    #showAnswerButton {
      background-color: var(--error-color);
    }
    #showAnswerButton:hover:not(:disabled) {
      background-color: #C62828; /* æ¿ƒã„èµ¤ */
    }

    /* å‹åˆ©æ™‚ã®çµæœãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
    .win-message {
      animation: pulse 1.5s infinite;
      color: var(--success-color) !important;
      font-size: 28px !important;
    }
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }

    h3 {
      color: var(--text-color);
      margin-top: 30px;
      margin-bottom: 15px;
      font-family: 'Montserrat', sans-serif;
      font-size: 1.6em;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 15px;
      box-shadow: var(--shadow-light);
      border-radius: 8px;
      overflow: hidden; /* è§’ä¸¸ã‚’é©ç”¨ */
    }
    th, td {
      border: 1px solid var(--border-color);
      padding: 10px;
      text-align: center;
      font-size: 15px;
    }
    th {
      background-color: var(--dark-bg);
      color: var(--text-color);
      font-weight: bold;
    }
    td {
      background-color: #fff;
    }
    td span.highlight-green {
      color: var(--success-color);
      font-weight: bold;
    }
    td span.highlight-red {
      color: var(--error-color);
      font-weight: bold;
    }

    /* ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
    .game-over-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 2em;
      font-weight: bold;
      border-radius: 12px;
      z-index: 10;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.5s ease, visibility 0.5s ease;
    }
    .game-over-overlay.show {
      opacity: 1;
      visibility: visible;
    }
    .game-over-overlay p {
      margin-bottom: 20px;
      font-size: 1.2em;
      color: white;
    }
    .game-over-overlay button {
      background-color: var(--success-color);
      color: white;
      font-size: 1.2em;
      padding: 10px 20px;
    }
    .game-over-overlay button:hover {
      background-color: var(--primary-dark-color);
    }
  </style>
</head>
<body>
  <div class="container">
    <h2><i class="fas fa-bullseye"></i> ãƒ’ãƒƒãƒˆ&ãƒ–ãƒ­ãƒ¼ <i class="fas fa-bullseye"></i></h2>
    <div class="digit-select">
      <p>æ¡æ•°é¸æŠ:</p>
      <label><input type="radio" name="digitCount" value="3"> 3æ¡</label>
      <label><input type="radio" name="digitCount" value="4" checked> 4æ¡</label>
      <label><input type="radio" name="digitCount" value="5"> 5æ¡</label>
      <label><input type="radio" name="digitCount" value="6"> 6æ¡</label>
    </div>
    <p class="info-text">æ•°å­—ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚ï¼ˆå„æ¡ã¯é‡è¤‡ã—ãªã„ï¼‰</p>

    <p id="result" aria-live="polite"></p>

    <input type="text" id="guess" maxlength="4" placeholder="ä¾‹ï¼š1234" inputmode="none">
    <div id="input-error-message" class="error-message"></div>

    <div class="keypad">
      <button class="keypad-btn">1</button>
      <button class="keypad-btn">2</button>
      <button class="keypad-btn">3</button>
      <button class="keypad-btn">4</button>
      <button class="keypad-btn">5</button>
      <button class="keypad-btn">6</button>
      <button class="keypad-btn">7</button>
      <button class="keypad-btn">8</button>
      <button class="keypad-btn">9</button>
      <button class="keypad-btn key-clear"><i class="fas fa-eraser"></i> ã‚¯ãƒªã‚¢</button>
      <button class="keypad-btn">0</button>
      <button class="keypad-btn key-back"><i class="fas fa-backspace"></i> æˆ»ã‚‹</button>
    </div>

    <div class="buttons">
      <button id="checkButton"><i class="fas fa-check"></i> ãƒã‚§ãƒƒã‚¯</button>
      <button id="numericHintButton"><i class="fas fa-sort-numeric-up-alt"></i> æ•°å€¤ãƒ’ãƒ³ãƒˆ</button>
      <button id="digitHighlightButton"><i class="fas fa-highlighter"></i> æ•°å­—ãƒã‚¤ãƒ©ã‚¤ãƒˆ</button>
      <button id="revealDigitHintButton" title="ç­”ãˆã«å«ã¾ã‚Œã‚‹æ•°å­—ã‚’ä¸€ã¤è¡¨ç¤ºã—ã¾ã™ (1å›é™ã‚Š)"><i class="fas fa-lightbulb"></i> æ•°å­—1ã¤ãƒ’ãƒ³ãƒˆ</button>
      <button id="parityHintButton" title="ç­”ãˆå…¨ä½“ãŒå¶æ•°ã‹å¥‡æ•°ã‹ã‚’æ•™ãˆã¾ã™ (1å›é™ã‚Š)"><i class="fas fa-question"></i> å¶å¥‡ãƒ’ãƒ³ãƒˆ</button>
      <button id="rangeHintButton" title="ç­”ãˆãŒæŒ‡å®šç¯„å›²å†…ã«ã‚ã‚‹ã‹æ•™ãˆã¾ã™ (1å›é™ã‚Š)"><i class="fas fa-chart-bar"></i> ç¯„å›²ãƒ’ãƒ³ãƒˆ</button>
      <button id="showAnswerButton"><i class="fas fa-eye"></i> ç­”ãˆ</button>
    </div>
    
    <div>
      <h3><i class="fas fa-history"></i> äºˆæƒ³å±¥æ­´</h3>
      <table id="historyTable">
        <thead>
          <tr>
            <th>è©¦è¡Œ</th>
            <th>äºˆæƒ³</th>
            <th>ãƒ’ãƒƒãƒˆ</th>
            <th>ãƒ–ãƒ­ãƒ¼</th>
          </tr>
        </thead>
        <tbody id="history"></tbody>
      </table>
    </div>

    <div class="game-over-overlay" id="gameOverOverlay">
      <p id="gameOverMessage"></p>
      <button id="playAgainButton"><i class="fas fa-redo"></i> ã‚‚ã†ä¸€åº¦ãƒ—ãƒ¬ã‚¤</button>
    </div>
  </div>

  <script>
    "use strict"; // å³æ ¼ãƒ¢ãƒ¼ãƒ‰ã®æœ‰åŠ¹åŒ–

    // DOMè¦ç´ ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥
    const guessField = document.getElementById("guess");
    const resultDisplay = document.getElementById("result");
    const historyBody = document.getElementById("history");
    const inputErrorMessage = document.getElementById("input-error-message");
    const checkButton = document.getElementById("checkButton");
    const numericHintButton = document.getElementById("numericHintButton");
    const digitHighlightButton = document.getElementById("digitHighlightButton");
    const revealDigitHintButton = document.getElementById("revealDigitHintButton");
    const parityHintButton = document.getElementById("parityHintButton");
    const rangeHintButton = document.getElementById("rangeHintButton");
    const showAnswerButton = document.getElementById("showAnswerButton");
    const digitCountRadios = document.querySelectorAll('input[name="digitCount"]');
    const keypadButtons = document.querySelectorAll('.keypad-btn');
    const gameOverOverlay = document.getElementById("gameOverOverlay");
    const gameOverMessage = document.getElementById("gameOverMessage");
    const playAgainButton = document.getElementById("playAgainButton");

    // ã‚²ãƒ¼ãƒ ã®çŠ¶æ…‹ã‚’ç®¡ç†ã™ã‚‹å¤‰æ•°
    let currentDigitCount = 4;
    let answer = [];
    let guessHistory = [];
    let isGameActive = true;
    let isDigitHighlightActive = false;
    let hintUsed = {
      revealDigit: false,
      parity: false,
      range: false,
    };
    let revealedDigitsInHint = new Set();

    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å®šæ•°
    const MESSAGES = {
      INPUT_LENGTH_ERROR: (count) => `${count}æ¡ã®åŠè§’æ•°å­—ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚`,
      INPUT_DUPLICATE_ERROR: "å„æ¡ã¯é‡è¤‡ã—ãªã„æ•°å­—ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚",
      CORRECT_ANSWER: (ans) => `æ­£è§£ï¼ç­”ãˆã¯ ${ans} ã§ã—ãŸï¼ğŸ‰`,
      HINT_HIGH: "ã‚ãªãŸã®äºˆæƒ³ã¯ç­”ãˆã‚ˆã‚Šå¤§ãã„ã§ã™ã€‚",
      HINT_LOW: "ã‚ãªãŸã®äºˆæƒ³ã¯ç­”ãˆã‚ˆã‚Šå°ã•ã„ã§ã™ã€‚",
      HINT_EQUAL: "ã‚ãªãŸã®äºˆæƒ³ã¯ã¡ã‚‡ã†ã©ç­”ãˆã¨åŒã˜æ•°å€¤ã§ã™ï¼ï¼ˆæ¡ã¨ä½ç½®ã¯è€ƒæ…®ã›ãšï¼‰",
      ANSWER_IS: (ans) => `ç­”ãˆã¯ ${ans} ã§ã™ã€‚`,
      HIT_BLOW: (hit, blow) => `ãƒ’ãƒƒãƒˆï¼š${hit}ã€ãƒ–ãƒ­ãƒ¼ï¼š${blow}`,
      DEFAULT_PLACEHOLDER: (count) => "ä¾‹ï¼š" + "123456".substring(0, count),
      REVEAL_DIGIT_HINT: (digit) => `ç­”ãˆã«å«ã¾ã‚Œã‚‹æ•°å­—ã®ä¸€ã¤ã¯ã€Œ${digit}ã€ã§ã™ã€‚`,
      NO_NEW_DIGIT_TO_REVEAL: "ã“ã‚Œä»¥ä¸Šã€æ–°ã—ã„æ•°å­—ã®ãƒ’ãƒ³ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“ã€‚",
      PARITY_HINT: (isEven) => `ç­”ãˆã¯${isEven ? 'å¶æ•°' : 'å¥‡æ•°'}ã§ã™ã€‚`,
      RANGE_HINT_ABOVE: (boundary) => `ç­”ãˆã¯ ${boundary} ä»¥ä¸Šã§ã™ã€‚`,
      RANGE_HINT_BELOW: (boundary) => `ç­”ãˆã¯ ${boundary} æœªæº€ã§ã™ã€‚`,
      HINT_ALREADY_USED: "ã“ã®ãƒ’ãƒ³ãƒˆã¯ã™ã§ã«ä½¿ç”¨æ¸ˆã¿ã§ã™ï¼",
      GAME_OVER_WIN: "ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼",
      GAME_OVER_LOSE: "ã‚²ãƒ¼ãƒ çµ‚äº†...",
    };

    /**
     * é‡è¤‡ã—ãªã„æŒ‡å®šæ¡æ•°ã®æ•°å­—ã‚’ç”Ÿæˆã™ã‚‹é–¢æ•°
     * @param {number} count - ç”Ÿæˆã™ã‚‹æ¡æ•°
     * @returns {number[]} ç”Ÿæˆã•ã‚ŒãŸæ•°å­—ã®é…åˆ—
     */
    function generateAnswer(count) {
      const digits = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9];
      let answerArray = [];
      for (let i = 0; i < count; i++) {
        const index = Math.floor(Math.random() * digits.length);
        answerArray.push(digits[index]);
        digits.splice(index, 1);
      }
      return answerArray;
    }

    /**
     * ã‚²ãƒ¼ãƒ ã®çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆã—ã€æ–°ã—ã„ã‚²ãƒ¼ãƒ ã‚’é–‹å§‹ã™ã‚‹
     */
    function resetGame() {
      const selectedRadio = document.querySelector('input[name="digitCount"]:checked');
      currentDigitCount = parseInt(selectedRadio.value, 10);

      answer = generateAnswer(currentDigitCount);
      // ãƒ‡ãƒãƒƒã‚°ç”¨: console.log("ç­”ãˆ(ãƒ‡ãƒãƒƒã‚°ç”¨):", answer.join(''));

      guessHistory = [];
      isGameActive = true;
      isDigitHighlightActive = false;
      hintUsed = {
        revealDigit: false,
        parity: false,
        range: false,
      };
      revealedDigitsInHint.clear();

      updateHistory();
      clearMessages();
      resetInputField();
      setButtonState(true);
      digitHighlightButton.textContent = "æ•°å­—ãƒã‚¤ãƒ©ã‚¤ãƒˆ";
      gameOverOverlay.classList.remove("show"); // ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’éš ã™
      resultDisplay.classList.remove("win-message"); // å‹åˆ©ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¹ã‚¿ã‚¤ãƒ«ã‚’è§£é™¤
    }

    /**
     * å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆã™ã‚‹
     */
    function resetInputField() {
      guessField.value = "";
      guessField.classList.remove("input-error");
      guessField.setAttribute("maxlength", currentDigitCount);
      guessField.setAttribute("placeholder", MESSAGES.DEFAULT_PLACEHOLDER(currentDigitCount));
    }

    /**
     * çµæœè¡¨ç¤ºã¨ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚¯ãƒªã‚¢ã™ã‚‹
     */
    function clearMessages() {
      resultDisplay.textContent = "";
      inputErrorMessage.textContent = "";
    }

    /**
     * ãƒœã‚¿ãƒ³ã®æœ‰åŠ¹/ç„¡åŠ¹çŠ¶æ…‹ã‚’è¨­å®šã™ã‚‹
     * @param {boolean} enable - trueã§æœ‰åŠ¹ã€falseã§ç„¡åŠ¹
     */
    function setButtonState(enable) {
      checkButton.disabled = !enable;
      numericHintButton.disabled = !enable;
      digitHighlightButton.disabled = !enable;
      revealDigitHintButton.disabled = !enable || hintUsed.revealDigit;
      parityHintButton.disabled = !enable || hintUsed.parity;
      rangeHintButton.disabled = !enable || hintUsed.range;
      showAnswerButton.disabled = !enable;
    }

    /**
     * å±¥æ­´ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æ›´æ–°ã™ã‚‹
     */
    function updateHistory() {
      historyBody.innerHTML = "";
      guessHistory.forEach((entry, index) => {
        const row = document.createElement("tr");

        const cellAttempt = document.createElement("td");
        cellAttempt.textContent = index + 1;

        const cellGuess = document.createElement("td");
        if (isDigitHighlightActive) {
          let highlighted = "";
          for (let d of entry.guess) {
            if (answer.includes(parseInt(d, 10))) {
              highlighted += `<span class="highlight-green">${d}</span>`;
            } else {
              highlighted += `<span class="highlight-red">${d}</span>`;
            }
          }
          cellGuess.innerHTML = highlighted;
        } else {
          cellGuess.textContent = entry.guess;
        }

        const cellHit = document.createElement("td");
        cellHit.textContent = entry.hit;
        const cellBlow = document.createElement("td");
        cellBlow.textContent = entry.blow;

        row.appendChild(cellAttempt);
        row.appendChild(cellGuess);
        row.appendChild(cellHit);
        row.appendChild(cellBlow);
        historyBody.appendChild(row);
      });
    }

    /**
     * ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ã‚’æ¤œè¨¼ã™ã‚‹
     * @param {string} guessStr - ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®äºˆæƒ³æ–‡å­—åˆ—
     * @param {number} digitCount - æœŸå¾…ã•ã‚Œã‚‹æ¡æ•°
     * @returns {boolean} å…¥åŠ›ãŒæœ‰åŠ¹ãªå ´åˆã¯trueã€ãã†ã§ãªã„å ´åˆã¯false
     */
    function validateGuess(guessStr, digitCount) {
      clearMessages();
      guessField.classList.remove("input-error");

      if (guessStr.length !== digitCount || !/^\d+$/.test(guessStr)) {
        inputErrorMessage.textContent = MESSAGES.INPUT_LENGTH_ERROR(digitCount);
        guessField.classList.add("input-error");
        return false;
      }

      if (new Set(guessStr.split('')).size !== digitCount) {
        inputErrorMessage.textContent = MESSAGES.INPUT_DUPLICATE_ERROR;
        guessField.classList.add("input-error");
        return false;
      }
      return true;
    }

    /**
     * ã‚²ãƒ¼ãƒ çµ‚äº†æ™‚ã®å‡¦ç†
     * @param {boolean} isWin - å‹åˆ©ã—ãŸå ´åˆã¯trueã€ãã†ã§ãªã„å ´åˆã¯false
     */
    function endGame(isWin) {
      isGameActive = false;
      setButtonState(false);
      gameOverMessage.textContent = isWin ? MESSAGES.GAME_OVER_WIN : MESSAGES.GAME_OVER_LOSE;
      gameOverOverlay.classList.add("show");
    }

    /**
     * ã€Œãƒã‚§ãƒƒã‚¯ã€ãƒœã‚¿ãƒ³æŠ¼ä¸‹æ™‚ã®å‡¦ç†
     */
    function handleCheckGuess() {
      if (!isGameActive) return;

      const guessStr = guessField.value.trim();

      if (!validateGuess(guessStr, currentDigitCount)) {
        return;
      }

      const guessDigits = guessStr.split('').map(Number);
      let hit = 0;
      let blow = 0;

      for (let i = 0; i < currentDigitCount; i++) {
        if (guessDigits[i] === answer[i]) {
          hit++;
        } else if (answer.includes(guessDigits[i])) {
          blow++;
        }
      }

      if (hit === currentDigitCount) {
        resultDisplay.textContent = MESSAGES.CORRECT_ANSWER(answer.join(''));
        resultDisplay.classList.add("win-message");
        endGame(true);
      } else {
        resultDisplay.textContent = MESSAGES.HIT_BLOW(hit, blow);
      }

      guessHistory.push({ guess: guessStr, hit: hit, blow: blow });
      updateHistory();
      guessField.value = "";
    }

    /**
     * ã€Œæ•°å€¤ãƒ’ãƒ³ãƒˆã€ãƒœã‚¿ãƒ³æŠ¼ä¸‹æ™‚ã®å‡¦ç†
     */
    function handleNumericHint() {
      if (!isGameActive) return;

      const guessStr = guessField.value.trim();

      if (guessStr.length === 0) {
          inputErrorMessage.textContent = "ãƒ’ãƒ³ãƒˆã‚’å¾—ã‚‹ã«ã¯æ•°å­—ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚";
          guessField.classList.add("input-error");
          return;
      }

      if (guessStr.length !== currentDigitCount || !/^\d+$/.test(guessStr)) {
        inputErrorMessage.textContent = MESSAGES.INPUT_LENGTH_ERROR(currentDigitCount);
        guessField.classList.add("input-error");
        return;
      }
      clearMessages();

      const guessInt = parseInt(guessStr, 10);
      const answerInt = parseInt(answer.join(""), 10);

      if (guessInt > answerInt) {
        resultDisplay.textContent = MESSAGES.HINT_HIGH;
      } else if (guessInt < answerInt) {
        resultDisplay.textContent = MESSAGES.HINT_LOW;
      } else {
        resultDisplay.textContent = MESSAGES.HINT_EQUAL;
      }
    }

    /**
     * ã€Œæ•°å­—ãƒã‚¤ãƒ©ã‚¤ãƒˆã€ãƒœã‚¿ãƒ³æŠ¼ä¸‹æ™‚ã®å‡¦ç†
     */
    function handleDigitHighlight() {
      if (!isGameActive) return;

      isDigitHighlightActive = !isDigitHighlightActive;
      digitHighlightButton.textContent = isDigitHighlightActive ? "ãƒã‚¤ãƒ©ã‚¤ãƒˆOFF" : "æ•°å­—ãƒã‚¤ãƒ©ã‚¤ãƒˆ";
      updateHistory();
      resultDisplay.textContent = `æ•°å­—ãƒã‚¤ãƒ©ã‚¤ãƒˆ ${isDigitHighlightActive ? 'ON' : 'OFF'} ã«ã—ã¾ã—ãŸã€‚`;
    }

    /**
     * ã€Œæ•°å­—1ã¤ãƒ’ãƒ³ãƒˆã€ãƒœã‚¿ãƒ³æŠ¼ä¸‹æ™‚ã®å‡¦ç†
     */
    function handleRevealDigitHint() {
      if (!isGameActive) return;
      if (hintUsed.revealDigit) {
        resultDisplay.textContent = MESSAGES.HINT_ALREADY_USED;
        return;
      }

      clearMessages();

      const unrevealedDigits = answer.filter(digit => !revealedDigitsInHint.has(digit));

      if (unrevealedDigits.length > 0) {
        const randomIndex = Math.floor(Math.random() * unrevealedDigits.length);
        const revealedDigit = unrevealedDigits[randomIndex];
        revealedDigitsInHint.add(revealedDigit);

        resultDisplay.textContent = MESSAGES.REVEAL_DIGIT_HINT(revealedDigit);
        hintUsed.revealDigit = true;
        setButtonState(isGameActive);
      } else {
        resultDisplay.textContent = MESSAGES.NO_NEW_DIGIT_TO_REVEAL;
      }
    }

    /**
     * ã€Œå¶å¥‡ãƒ’ãƒ³ãƒˆã€ãƒœã‚¿ãƒ³æŠ¼ä¸‹æ™‚ã®å‡¦ç†
     */
    function handleParityHint() {
      if (!isGameActive) return;
      if (hintUsed.parity) {
        resultDisplay.textContent = MESSAGES.HINT_ALREADY_USED;
        return;
      }

      clearMessages();

      const answerInt = parseInt(answer.join(""), 10);
      const isEven = answerInt % 2 === 0;
      resultDisplay.textContent = MESSAGES.PARITY_HINT(isEven);

      hintUsed.parity = true;
      setButtonState(isGameActive);
    }

    /**
     * ã€Œç¯„å›²ãƒ’ãƒ³ãƒˆã€ãƒœã‚¿ãƒ³æŠ¼ä¸‹æ™‚ã®å‡¦ç†
     */
    function handleRangeHint() {
      if (!isGameActive) return;
      if (hintUsed.range) {
        resultDisplay.textContent = MESSAGES.HINT_ALREADY_USED;
        return;
      }

      clearMessages();

      const answerInt = parseInt(answer.join(""), 10);
      let boundary;

      switch (currentDigitCount) {
        case 3: boundary = 500; break;
        case 4: boundary = 5000; break;
        case 5: boundary = 50000; break;
        case 6: boundary = 500000; break;
        default: boundary = 500;
      }

      if (answerInt >= boundary) {
        resultDisplay.textContent = MESSAGES.RANGE_HINT_ABOVE(boundary);
      } else {
        resultDisplay.textContent = MESSAGES.RANGE_HINT_BELOW(boundary);
      }

      hintUsed.range = true;
      setButtonState(isGameActive);
    }

    /**
     * ã€Œç­”ãˆã€ãƒœã‚¿ãƒ³æŠ¼ä¸‹æ™‚ã®å‡¦ç†
     */
    function handleShowAnswer() {
      resultDisplay.textContent = MESSAGES.ANSWER_IS(answer.join(''));
      endGame(false);
    }

    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
    document.addEventListener("DOMContentLoaded", () => {
      digitCountRadios.forEach((elem) => {
        elem.addEventListener("change", resetGame);
      });

      checkButton.addEventListener("click", handleCheckGuess);
      numericHintButton.addEventListener("click", handleNumericHint);
      digitHighlightButton.addEventListener("click", handleDigitHighlight);
      revealDigitHintButton.addEventListener("click", handleRevealDigitHint);
      parityHintButton.addEventListener("click", handleParityHint);
      rangeHintButton.addEventListener("click", handleRangeHint);
      showAnswerButton.addEventListener("click", handleShowAnswer);
      playAgainButton.addEventListener("click", resetGame);

      // å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã§Enterã‚­ãƒ¼ãŒæŠ¼ã•ã‚ŒãŸã‚‰ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œ
      guessField.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          handleCheckGuess();
        }
      });

      // ã‚­ãƒ¼ãƒ‘ãƒƒãƒ‰ã®ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
      keypadButtons.forEach(button => {
        button.addEventListener('click', () => {
          if (!isGameActive) return;

          const currentInput = guessField.value;
          const buttonText = button.textContent.trim(); // ã‚¢ã‚¤ã‚³ãƒ³ãŒã‚ã‚‹ã®ã§trim()

          if (button.classList.contains('key-clear')) {
            guessField.value = '';
            clearMessages(); // ã‚¯ãƒªã‚¢æ™‚ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚‚æ¶ˆã™
            guessField.classList.remove("input-error"); // ã‚¨ãƒ©ãƒ¼ã‚¯ãƒ©ã‚¹ã‚‚æ¶ˆã™
          } else if (button.classList.contains('key-back')) {
            guessField.value = currentInput.slice(0, -1);
            clearMessages(); // æˆ»ã‚‹æ™‚ã‚‚ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ¶ˆã™
            guessField.classList.remove("input-error"); // ã‚¨ãƒ©ãƒ¼ã‚¯ãƒ©ã‚¹ã‚‚æ¶ˆã™
          } else {
            const newDigit = buttonText;
            if (currentInput.length < currentDigitCount) {
              if (!currentInput.includes(newDigit)) {
                guessField.value += newDigit;
                clearMessages(); // æœ‰åŠ¹ãªå…¥åŠ›æ™‚ã¯ã‚¨ãƒ©ãƒ¼ã‚’ã‚¯ãƒªã‚¢
                guessField.classList.remove("input-error");
              } else {
                inputErrorMessage.textContent = "ã“ã®æ•°å­—ã¯æ—¢ã«å…¥åŠ›ã•ã‚Œã¦ã„ã¾ã™ã€‚";
                guessField.classList.add("input-error");
                // setTimeoutã‚’å‰Šé™¤ã—ã€ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç¶™ç¶šè¡¨ç¤º
              }
            } else {
                inputErrorMessage.textContent = `${currentDigitCount}æ¡ã‚’è¶…ãˆã¦ã„ã¾ã™ã€‚`;
                guessField.classList.add("input-error");
                // setTimeoutã‚’å‰Šé™¤ã—ã€ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç¶™ç¶šè¡¨ç¤º
            }
          }
        });
      });

      // ç›´æ¥å…¥åŠ›æ™‚ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã¨ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
      guessField.addEventListener('input', (e) => {
          let inputValue = e.target.value;
          let cleanedValue = inputValue.replace(/[^0-9]/g, ''); // æ•°å­—ä»¥å¤–ã®æ–‡å­—ã‚’å‰Šé™¤

          // é‡è¤‡ã™ã‚‹æ•°å­—ã®ãƒã‚§ãƒƒã‚¯ã¨è‡ªå‹•ä¿®æ­£
          const uniqueDigits = new Set();
          let finalValue = '';
          for (const char of cleanedValue) {
              if (!uniqueDigits.has(char)) {
                  uniqueDigits.add(char);
                  finalValue += char;
              } else {
                  inputErrorMessage.textContent = "å„æ¡ã¯é‡è¤‡ã—ãªã„æ•°å­—ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚";
                  guessField.classList.add("input-error");
                  e.target.value = finalValue; // é‡è¤‡æ–‡å­—ã‚’é™¤ã„ãŸéƒ¨åˆ†ã‚’ã‚»ãƒƒãƒˆ
                  return; // ã“ã®å…¥åŠ›ã‚¤ãƒ™ãƒ³ãƒˆã®å‡¦ç†ã‚’çµ‚äº†
              }
          }

          // æ¡æ•°åˆ¶é™
          if (finalValue.length > currentDigitCount) {
              finalValue = finalValue.slice(0, currentDigitCount);
              inputErrorMessage.textContent = `${currentDigitCount}æ¡ã‚’è¶…ãˆã¦ã„ã¾ã™ã€‚`;
              guessField.classList.add("input-error");
          } else if (inputErrorMessage.textContent === `${currentDigitCount}æ¡ã‚’è¶…ãˆã¦ã„ã¾ã™ã€‚` && finalValue.length <= currentDigitCount) {
              // æ¡æ•°è¶…éã‚¨ãƒ©ãƒ¼ãŒä»¥å‰å‡ºã¦ã„ã¦ã€æ¡æ•°ãŒé©æ­£ã«æˆ»ã£ãŸå ´åˆã€ã‚¨ãƒ©ãƒ¼ã‚’ã‚¯ãƒªã‚¢
              clearMessages();
              guessField.classList.remove("input-error");
          }

          // å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å€¤ã‚’æ›´æ–°
          if (e.target.value !== finalValue) {
              e.target.value = finalValue;
          }

          // å…¨ã¦ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é€šéã—ãŸå ´åˆã€ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚¯ãƒªã‚¢
          if (finalValue.length === currentDigitCount && uniqueDigits.size === currentDigitCount) {
              clearMessages();
              guessField.classList.remove("input-error");
          }
      });

      // åˆæœŸåŒ–
      resetGame();
    });
  </script>
</body>
</html>
