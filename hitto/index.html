<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ヒットアンドブローゲーム</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f0f0f5;
      margin: 0;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
    }
    .container {
      background: #fff;
      padding: 30px 40px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      border-radius: 8px;
      text-align: center;
      width: 320px;
    }
    h2 {
      margin-bottom: 20px;
      color: #333;
    }
    .digit-select {
      margin-bottom: 15px;
    }
    .digit-select p {
      margin: 0 0 8px;
      font-weight: bold;
    }
    .digit-select label {
      margin-right: 10px;
      font-size: 16px;
      cursor: pointer;
    }
    p {
      color: #555;
      margin-bottom: 15px;
    }
    input[type="text"] {
      width: 100%;
      padding: 10px;
      margin-bottom: 5px; /* エラーメッセージとの隙間調整 */
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 16px;
      box-sizing: border-box; /* paddingを含めてwidthを計算 */
    }
    /* 入力エラー時のスタイル */
    input[type="text"].input-error {
      border-color: #dc3545; /* 赤色 */
      box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
    }
    .error-message {
      color: #dc3545;
      font-size: 14px;
      min-height: 20px; /* メッセージがないときも高さを確保 */
      margin-bottom: 10px;
    }
    input[type="text"]::-webkit-outer-spin-button,
    input[type="text"]::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    input[type="text"] {
      -moz-appearance: textfield;
    }
    .buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
      margin-bottom: 15px;
    }
    button {
      padding: 10px 15px;
      font-size: 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      background-color: #28a745;
      color: #fff;
      transition: background-color 0.2s, opacity 0.2s;
      min-width: 90px;
    }
    button:hover:not(:disabled) {
      background-color: #218838;
    }
    button:disabled {
      background-color: #6c757d;
      cursor: not-allowed;
      opacity: 0.6;
    }
    #result {
      font-size: 18px;
      color: #222;
      min-height: 24px;
      margin-bottom: 20px;
      font-weight: bold;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 20px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: center;
    }
    th {
      background-color: #f2f2f2;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>ヒットアンドブローゲーム</h2>
    <div class="digit-select">
      <p>桁数選択:</p>
      <label><input type="radio" name="digitCount" value="3"> 3桁</label>
      <label><input type="radio" name="digitCount" value="4" checked> 4桁</label>
      <label><input type="radio" name="digitCount" value="5"> 5桁</label>
      <label><input type="radio" name="digitCount" value="6"> 6桁</label>
    </div>
    <p>数字を入力してください。（各桁は重複しない）</p>
    <input type="text" id="guess" maxlength="4" placeholder="例：1234" inputmode="numeric" pattern="\d*">
    <div id="input-error-message" class="error-message"></div>
    <div class="buttons">
      <button id="checkButton">チェック</button>
      <button id="numericHintButton">数値ヒント</button>
      <button id="digitHighlightButton">数字ハイライト</button>
      <button id="showAnswerButton">答え</button>
    </div>
    <p id="result" aria-live="polite"></p>
    <div>
      <h3>予想履歴</h3>
      <table id="historyTable">
        <thead>
          <tr>
            <th>試行</th>
            <th>予想</th>
            <th>ヒット</th>
            <th>ブロー</th>
          </tr>
        </thead>
        <tbody id="history"></tbody>
      </table>
    </div>
  </div>

  <script>
    // DOM要素のキャッシュ
    const guessField = document.getElementById("guess");
    const resultDisplay = document.getElementById("result");
    const historyBody = document.getElementById("history");
    const inputErrorMessage = document.getElementById("input-error-message");
    const checkButton = document.getElementById("checkButton");
    const numericHintButton = document.getElementById("numericHintButton");
    const digitHighlightButton = document.getElementById("digitHighlightButton");
    const showAnswerButton = document.getElementById("showAnswerButton");
    const digitCountRadios = document.querySelectorAll('input[name="digitCount"]');

    // ゲームの状態を管理する変数
    let currentDigitCount = 4;
    let answer = [];
    let guessHistory = [];
    let isGameActive = true; // ゲームが進行中かどうかのフラグ
    let isDigitHighlightActive = false; // 数字ハイライト機能が有効かどうかのフラグ

    // メッセージ定数
    const MESSAGES = {
      INPUT_LENGTH_ERROR: (count) => `${count}桁の半角数字を正しく入力してください。`,
      INPUT_DUPLICATE_ERROR: "各桁は重複しない数字で入力してください。",
      CORRECT_ANSWER: (ans) => `正解です！答えは ${ans} でした。おめでとうございます！`,
      HINT_HIGH: "あなたの予想は答えより大きいです。",
      HINT_LOW: "あなたの予想は答えより小さいです。",
      HINT_EQUAL: "あなたの予想はちょうど答えと同じ数値です！（桁と位置は考慮せず）",
      ANSWER_IS: (ans) => `答えは ${ans} です。`,
      HIT_BLOW: (hit, blow) => `ヒット：${hit}、ブロー：${blow}`,
      DEFAULT_PLACEHOLDER: (count) => "例：" + "123456".substring(0, count)
    };

    /**
     * 重複しない指定桁数の数字を生成する関数
     * @param {number} count - 生成する桁数
     * @returns {number[]} 生成された数字の配列
     */
    function generateAnswer(count) {
      const digits = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9];
      let answerArray = [];
      for (let i = 0; i < count; i++) {
        const index = Math.floor(Math.random() * digits.length);
        answerArray.push(digits[index]);
        digits.splice(index, 1);
      }
      return answerArray;
    }

    /**
     * ゲームの状態をリセットし、新しいゲームを開始する
     */
    function resetGame() {
      const selectedRadio = document.querySelector('input[name="digitCount"]:checked');
      currentDigitCount = parseInt(selectedRadio.value, 10);

      answer = generateAnswer(currentDigitCount);
      console.log("答え(デバッグ用):", answer.join('')); // デバッグ用

      guessHistory = [];
      isGameActive = true;
      isDigitHighlightActive = false; // ヒントフラグのリセット

      updateHistory();
      clearMessages();
      resetInputField();
      setButtonState(true); // ボタンを有効化
    }

    /**
     * 入力フィールドの状態をリセットする
     */
    function resetInputField() {
      guessField.value = "";
      guessField.classList.remove("input-error");
      guessField.setAttribute("maxlength", currentDigitCount);
      guessField.setAttribute("placeholder", MESSAGES.DEFAULT_PLACEHOLDER(currentDigitCount));
    }

    /**
     * 結果表示とエラーメッセージをクリアする
     */
    function clearMessages() {
      resultDisplay.textContent = "";
      inputErrorMessage.textContent = "";
    }

    /**
     * ボタンの有効/無効状態を設定する
     * @param {boolean} enable - trueで有効、falseで無効
     */
    function setButtonState(enable) {
      checkButton.disabled = !enable;
      numericHintButton.disabled = !enable;
      digitHighlightButton.disabled = !enable;
      // 答えボタンはゲーム終了後も押せるようにしたい場合、この行をコメントアウト
      // showAnswerButton.disabled = !enable;
    }

    /**
     * 履歴テーブルを更新する
     */
    function updateHistory() {
      historyBody.innerHTML = "";
      guessHistory.forEach((entry, index) => {
        const row = document.createElement("tr");

        const cellAttempt = document.createElement("td");
        cellAttempt.textContent = index + 1;

        const cellGuess = document.createElement("td");
        if (isDigitHighlightActive) {
          let highlighted = "";
          for (let d of entry.guess) {
            if (answer.includes(parseInt(d, 10))) {
              highlighted += `<span style="color: green; font-weight: bold;">${d}</span>`;
            } else {
              highlighted += `<span style="color: red; font-weight: bold;">${d}</span>`;
            }
          }
          cellGuess.innerHTML = highlighted;
        } else {
          cellGuess.textContent = entry.guess;
        }

        const cellHit = document.createElement("td");
        cellHit.textContent = entry.hit;
        const cellBlow = document.createElement("td");
        cellBlow.textContent = entry.blow;

        row.appendChild(cellAttempt);
        row.appendChild(cellGuess);
        row.appendChild(cellHit);
        row.appendChild(cellBlow);
        historyBody.appendChild(row);
      });
    }

    /**
     * ユーザー入力を検証する
     * @param {string} guessStr - ユーザーの予想文字列
     * @param {number} digitCount - 期待される桁数
     * @returns {boolean} 入力が有効な場合はtrue、そうでない場合はfalse
     */
    function validateGuess(guessStr, digitCount) {
      clearMessages(); // まずエラーメッセージをクリア
      guessField.classList.remove("input-error");

      // 桁数と数字のみのチェック
      if (guessStr.length !== digitCount || !/^\d+$/.test(guessStr)) {
        inputErrorMessage.textContent = MESSAGES.INPUT_LENGTH_ERROR(digitCount);
        guessField.classList.add("input-error");
        return false;
      }

      // 重複チェック
      if (new Set(guessStr.split('')).size !== digitCount) {
        inputErrorMessage.textContent = MESSAGES.INPUT_DUPLICATE_ERROR;
        guessField.classList.add("input-error");
        return false;
      }
      return true;
    }

    /**
     * 「チェック」ボタン押下時の処理
     */
    function handleCheckGuess() {
      if (!isGameActive) return; // ゲームが非アクティブなら何もしない

      const guessStr = guessField.value.trim();

      if (!validateGuess(guessStr, currentDigitCount)) {
        return; // バリデーション失敗
      }

      const guessDigits = guessStr.split('').map(Number);
      let hit = 0;
      let blow = 0;

      for (let i = 0; i < currentDigitCount; i++) {
        if (guessDigits[i] === answer[i]) {
          hit++;
        } else if (answer.includes(guessDigits[i])) {
          blow++;
        }
      }

      if (hit === currentDigitCount) {
        resultDisplay.textContent = MESSAGES.CORRECT_ANSWER(answer.join(''));
        isGameActive = false; // ゲーム終了
        setButtonState(false); // ボタンを無効化
      } else {
        resultDisplay.textContent = MESSAGES.HIT_BLOW(hit, blow);
      }

      guessHistory.push({ guess: guessStr, hit: hit, blow: blow });
      updateHistory();
      guessField.value = ""; // 入力欄をクリア
    }

    /**
     * 「数値ヒント」ボタン押下時の処理
     */
    function handleNumericHint() {
      if (!isGameActive) return;

      const guessStr = guessField.value.trim();

      // 数字ハイライト機能の影響を受けないよう、個別にバリデーション
      if (guessStr.length !== currentDigitCount || !/^\d+$/.test(guessStr)) {
        inputErrorMessage.textContent = MESSAGES.INPUT_LENGTH_ERROR(currentDigitCount);
        guessField.classList.add("input-error");
        return;
      }
      clearMessages(); // エラー表示を消す

      const guessInt = parseInt(guessStr, 10);
      const answerInt = parseInt(answer.join(""), 10);

      if (guessInt > answerInt) {
        resultDisplay.textContent = MESSAGES.HINT_HIGH;
      } else if (guessInt < answerInt) {
        resultDisplay.textContent = MESSAGES.HINT_LOW;
      } else {
        resultDisplay.textContent = MESSAGES.HINT_EQUAL;
      }
    }

    /**
     * 「数字ハイライト」ボタン押下時の処理
     */
    function handleDigitHighlight() {
      if (!isGameActive) return;

      // 数字ハイライトの有効/無効を切り替える
      isDigitHighlightActive = !isDigitHighlightActive;
      digitHighlightButton.textContent = isDigitHighlightActive ? "ハイライトOFF" : "数字ハイライト";
      updateHistory(); // 履歴を再描画してハイライトを適用/解除
      resultDisplay.textContent = `数字ハイライト ${isDigitHighlightActive ? 'ON' : 'OFF'} にしました。`;
    }

    /**
     * 「答え」ボタン押下時の処理
     */
    function handleShowAnswer() {
      resultDisplay.textContent = MESSAGES.ANSWER_IS(answer.join(''));
      isGameActive = false; // ゲーム終了
      setButtonState(false); // ボタンを無効化
    }

    // イベントリスナーの設定
    document.addEventListener("DOMContentLoaded", () => {
      // ラジオボタンの変更時にゲームリセット
      digitCountRadios.forEach((elem) => {
        elem.addEventListener("change", resetGame);
      });

      // 各ボタンにイベントリスナーを設定
      checkButton.addEventListener("click", handleCheckGuess);
      numericHintButton.addEventListener("click", handleNumericHint);
      digitHighlightButton.addEventListener("click", handleDigitHighlight);
      showAnswerButton.addEventListener("click", handleShowAnswer);

      // 入力フィールドでEnterキーが押されたらチェックを実行
      guessField.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          e.preventDefault(); // Enterキーによるフォーム送信を防止
          handleCheckGuess();
        }
      });

      // 入力中に半角数字以外の文字を削除する
      guessField.addEventListener('input', (e) => {
        e.target.value = e.target.value.replace(/[^0-9]/g, '');
        // 入力がある程度正しくなったらエラー表示を消す
        if (e.target.value.length === currentDigitCount && new Set(e.target.value.split('')).size === currentDigitCount) {
            clearMessages();
            guessField.classList.remove("input-error");
        }
      });

      // 初期化
      resetGame();
    });
  </script>
</body>
</html>
