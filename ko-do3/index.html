<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>スマートHTMLエディター</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/theme/dracula.min.css" />
    <style>
        :root {
            --header-bg: #2c3e50;
            --btn-normal: #ecf0f1;
            --btn-primary: #3498db;
            --btn-danger: #e74c3c;
            --btn-success: #2ecc71;
        }

        body {
            margin: 0;
            font-family: 'Segoe UI', sans-serif;
            display: flex;
            flex-direction: column;
            height: 100vh;
            background-color: #1e1e1e;
        }

        /* 操作パネルの改良 */
        .controls {
            padding: 10px;
            background-color: var(--header-bg);
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            z-index: 100;
        }

        .controls button {
            padding: 8px 14px;
            cursor: pointer;
            border: none;
            border-radius: 6px;
            background-color: var(--btn-normal);
            font-weight: bold;
            transition: all 0.2s;
            font-size: 13px;
        }

        /* ボタンの色分け */
        button#runBtn { background-color: var(--btn-success); color: white; }
        button#saveBtn, button#saveTxtBtn { background-color: var(--btn-primary); color: white; }
        button#clearAllBtn { background-color: var(--btn-danger); color: white; }
        
        .controls button:active { transform: scale(0.95); }

        /* エディター領域 */
        .editor { flex: 1; overflow: hidden; }
        .CodeMirror { height: 100%; font-size: 16px; } /* スマホでズームしないよう16px推奨 */

        /* メッセージエリアの改良 */
        #messageArea {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 10px 20px;
            border-radius: 30px;
            color: white;
            font-size: 14px;
            font-weight: bold;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 1000;
        }
        #messageArea.show { opacity: 1; }
        .bg-info { background: rgba(52, 152, 219, 0.9); }
        .bg-success { background: rgba(46, 204, 113, 0.9); }

        @media (max-width: 600px) {
            .controls { padding: 5px; gap: 4px; }
            .controls button { padding: 10px 8px; flex-grow: 1; font-size: 12px; }
        }
    </style>
</head>
<body>

<div class="controls" id="controlsPanel">
    <button id="undoBtn">元に戻す</button>
    <button id="selectAllBtn">全選択</button>
    <button id="copyBtn">コピー</button>
    <button id="pasteBtn">貼付け</button>
    <button id="openFileBtn">開く</button>
    <button id="saveBtn">HTML保存</button>
    <button id="saveTxtBtn">TXT保存</button>
    <button id="clearAllBtn">全削除</button>
    <button id="runBtn">▶ 実行</button>
    <input type="file" id="fileInput" accept=".html" style="display:none">
</div>

<div id="messageArea"></div>

<div class="editor">
    <textarea id="htmlCode"></textarea>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/htmlmixed/htmlmixed.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/xml/xml.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/javascript/javascript.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/css/css.min.js"></script>

<script>
    // エディターの初期化（ダークテーマ 'dracula' を適用）
    var cm = CodeMirror.fromTextArea(document.getElementById('htmlCode'), {
        mode: "htmlmixed",
        lineNumbers: true,
        theme: "dracula",
        lineWrapping: true, // 右端で折り返す設定
        tabSize: 2
    });

    // データの復元
    const savedCode = localStorage.getItem("htmlCode");
    if (savedCode) cm.setValue(savedCode);

    // 保存処理
    cm.on("change", () => {
        localStorage.setItem("htmlCode", cm.getValue());
    });

    // メッセージ表示機能
    function showMsg(text, type = 'info') {
        const area = document.getElementById('messageArea');
        area.textContent = text;
        area.className = `show bg-${type}`;
        setTimeout(() => area.className = '', 2000);
    }

    // --- ボタンアクション ---

    // 元に戻す (Undo)
    document.getElementById('undoBtn').addEventListener('click', () => {
        cm.undo();
        cm.focus();
    });

    // コピー
    document.getElementById('copyBtn').addEventListener('click', () => {
        const text = cm.getValue();
        navigator.clipboard.writeText(text).then(() => showMsg("コピー完了", "success"));
    });

    // 貼り付け (ブラウザのセキュリティ制限により、一部制限される場合があります)
    document.getElementById('pasteBtn').addEventListener('click', async () => {
        try {
            const text = await navigator.clipboard.readText();
            cm.replaceSelection(text);
            showMsg("貼り付けました", "success");
        } catch (err) {
            showMsg("クリップボードへのアクセスが拒否されました", "info");
        }
    });

    // 全選択
    document.getElementById('selectAllBtn').addEventListener('click', () => {
        cm.setSelection({line: 0, ch: 0}, {line: cm.lineCount(), ch: 0});
        cm.focus();
    });

    // 全削除
    document.getElementById('clearAllBtn').addEventListener('click', () => {
        if(confirm("すべて削除しますか？")) {
            cm.setValue("");
            showMsg("クリアしました");
        }
    });

    // 実行 (Run)
    document.getElementById('runBtn').addEventListener('click', () => {
        const blob = new Blob([cm.getValue()], { type: "text/html" });
        const url = URL.createObjectURL(blob);
        window.open(url, "_blank");
    });

    // 保存 (HTML)
    document.getElementById('saveBtn').addEventListener('click', () => {
        const blob = new Blob([cm.getValue()], { type: "text/html" });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = "index.html";
        a.click();
        showMsg("HTMLを保存しました", "success");
    });

    // ファイルを開く
    document.getElementById('openFileBtn').addEventListener('click', () => {
        document.getElementById('fileInput').click();
    });

    document.getElementById('fileInput').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (evt) => {
            cm.setValue(evt.target.result);
            showMsg(file.name + " を読み込みました");
        };
        reader.readAsText(file);
    });
</script>
</body>
</html>
