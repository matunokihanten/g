<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Âõ≥ÂΩ¢Â∑ÆÂàÜ„Ç≤„Éº„É†</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      color: #333;
      position: relative;
      overflow-x: hidden;
    }
    
    /* „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ËÉåÊôØ */
    .background-shapes {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
      pointer-events: none;
      z-index: -1;
    }
    
    .bg-shape {
      position: absolute;
      opacity: 0.1;
      animation: float 8s infinite ease-in-out;
    }
    
    @keyframes float {
      0%, 100% { transform: translateY(0px) rotate(0deg); }
      50% { transform: translateY(-20px) rotate(180deg); }
    }
    
    .game-container {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 30px;
      margin: 20px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      max-width: 900px;
      width: 100%;
      text-align: center;
    }
    
    h1 {
      font-size: 2.5em;
      margin-bottom: 30px;
      background: linear-gradient(45deg, #667eea, #764ba2);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    .stats-container {
      display: flex;
      justify-content: center;
      gap: 40px;
      margin-bottom: 30px;
    }
    
    .stat-box {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      padding: 15px 25px;
      border-radius: 15px;
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
      min-width: 120px;
      transform: perspective(1000px) rotateX(0deg);
      transition: transform 0.3s ease;
    }
    
    .stat-box:hover {
      transform: perspective(1000px) rotateX(10deg) translateY(-5px);
    }
    
    .stat-label {
      font-size: 0.9em;
      margin-bottom: 5px;
    }
    
    .stat-value {
      font-size: 2em;
      font-weight: bold;
    }
    
    .controls {
      background: rgba(255, 255, 255, 0.8);
      padding: 20px;
      border-radius: 15px;
      margin-bottom: 30px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    
    .grid-select {
      margin-bottom: 20px;
    }
    
    .grid-select label {
      display: inline-block;
      margin: 0 10px;
      padding: 10px 20px;
      background: #f8f9fa;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    
    .grid-select label::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.8), transparent);
      transition: left 0.5s ease;
    }
    
    .grid-select label:hover::before {
      left: 100%;
    }
    
    .grid-select label:hover {
      background: #e9ecef;
      transform: translateY(-2px);
    }
    
    .grid-select input[type="radio"] {
      display: none;
    }
    
    .grid-select input[type="radio"]:checked + span {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
    }
    
    .grid-select input[type="radio"]:checked + span::after {
      content: '‚úì';
      position: absolute;
      top: 5px;
      right: 5px;
      font-size: 12px;
    }
    
    .button {
      padding: 12px 24px;
      font-size: 1.1em;
      margin: 0 8px;
      border: none;
      border-radius: 25px;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      transform: translateY(0);
    }
    
    .button:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
    }
    
    .button:active {
      transform: translateY(1px);
    }
    
    .button-primary {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
    }
    
    .button-secondary {
      background: linear-gradient(135deg, #ffeaa7, #fab1a0);
      color: #333;
    }
    
    .button-danger {
      background: linear-gradient(135deg, #fd79a8, #e84393);
      color: white;
    }
    
    .button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }
    
    .button:disabled:hover {
      transform: none;
      box-shadow: none;
    }
    
    .game-grid {
      display: grid;
      grid-gap: 20px;
      justify-content: center;
      margin: 30px auto;
      perspective: 1000px;
    }
    
    .cell {
      width: 140px;
      height: 140px;
      background: linear-gradient(135deg, #ffffff, #f8f9fa);
      border: 3px solid #e9ecef;
      border-radius: 15px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      position: relative;
      transition: all 0.3s ease;
      transform: rotateY(0deg);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    
    .cell:hover {
      transform: rotateY(5deg) translateY(-5px);
      box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15);
      border-color: #667eea;
    }
    
    .cell.correct {
      animation: correctPulse 0.6s ease;
      border-color: #2ecc71;
      background: linear-gradient(135deg, #d4edda, #c3e6cb);
    }
    
    .cell.incorrect {
      animation: incorrectShake 0.6s ease;
      border-color: #e74c3c;
      background: linear-gradient(135deg, #f8d7da, #f1b0b7);
    }
    
    @keyframes correctPulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }
    
    @keyframes incorrectShake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-5px); }
      75% { transform: translateX(5px); }
    }
    
    .cell svg {
      transition: all 0.3s ease;
      filter: drop-shadow(2px 2px 4px rgba(0, 0, 0, 0.1));
    }
    
    .cell:hover svg {
      transform: scale(1.05);
    }
    
    .hint-highlight {
      animation: hintPulse 1s ease-in-out;
      border-color: #f39c12 !important;
      box-shadow: 0 0 20px rgba(243, 156, 18, 0.5) !important;
    }
    
    @keyframes hintPulse {
      0%, 100% { border-color: #f39c12; box-shadow: 0 0 20px rgba(243, 156, 18, 0.5); }
      50% { border-color: #e67e22; box-shadow: 0 0 30px rgba(230, 126, 34, 0.8); }
    }
    
    .diff-overlay {
      position: absolute;
      top: 10px;
      right: 10px;
      width: 20px;
      height: 20px;
      background: rgba(231, 76, 60, 0.8);
      border-radius: 50%;
      pointer-events: none;
      animation: overlayPulse 1s infinite;
    }
    
    @keyframes overlayPulse {
      0%, 100% { opacity: 0.8; transform: scale(1); }
      50% { opacity: 1; transform: scale(1.2); }
    }
    
    .message {
      margin-top: 20px;
      font-size: 1.3em;
      padding: 15px;
      border-radius: 10px;
      min-height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }
    
    .message.success {
      background: linear-gradient(135deg, #d4edda, #c3e6cb);
      color: #155724;
      border: 2px solid #2ecc71;
    }
    
    .message.error {
      background: linear-gradient(135deg, #f8d7da, #f1b0b7);
      color: #721c24;
      border: 2px solid #e74c3c;
    }
    
    .message.info {
      background: linear-gradient(135deg, #d1ecf1, #bee5eb);
      color: #0c5460;
      border: 2px solid #17a2b8;
    }
    
    .difficulty-indicator {
      display: inline-block;
      margin-left: 10px;
      padding: 4px 8px;
      border-radius: 15px;
      font-size: 0.8em;
      font-weight: bold;
    }
    
    .difficulty-easy {
      background: #2ecc71;
      color: white;
    }
    
    .difficulty-medium {
      background: #f39c12;
      color: white;
    }
    
    .difficulty-hard {
      background: #e74c3c;
      color: white;
    }
    
    .progress-bar {
      width: 100%;
      height: 8px;
      background: #e9ecef;
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 20px;
    }
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #667eea, #764ba2);
      width: 0%;
      transition: width 0.3s ease;
    }
    
    @media (max-width: 768px) {
      .game-container {
        margin: 10px;
        padding: 20px;
      }
      
      h1 {
        font-size: 2em;
      }
      
      .stats-container {
        flex-direction: column;
        gap: 20px;
      }
      
      .cell {
        width: 80px;
        height: 80px;
      }
      
      .game-grid {
        grid-gap: 10px;
      }
    }
  </style>
</head>
<body>
  <div class="background-shapes"></div>
  
  <div class="game-container">
    <h1>üéØ Âõ≥ÂΩ¢Â∑ÆÂàÜ„Ç≤„Éº„É†</h1>
    
    <div class="progress-bar">
      <div class="progress-fill" id="progressFill"></div>
    </div>
    
    <div class="stats-container">
      <div class="stat-box">
        <div class="stat-label">„É©„Ç¶„É≥„Éâ</div>
        <div class="stat-value" id="roundDisplay">0</div>
      </div>
      <div class="stat-box">
        <div class="stat-label">ÂæóÁÇπ</div>
        <div class="stat-value" id="scoreDisplay">0</div>
      </div>
      <div class="stat-box">
        <div class="stat-label">ÈÄ£Á∂öÊ≠£Ëß£</div>
        <div class="stat-value" id="streakDisplay">0</div>
      </div>
    </div>
    
    <div class="controls">
      <div class="grid-select">
        <strong>Èõ£ÊòìÂ∫¶„ÇíÈÅ∏ÊäûÔºö</strong>
        <label>
          <input type="radio" name="gridCount" value="4">
          <span>Á∞°Âçò (4ÂÄã)<span class="difficulty-indicator difficulty-easy">EASY</span></span>
        </label>
        <label>
          <input type="radio" name="gridCount" value="9">
          <span>ÊôÆÈÄö (9ÂÄã)<span class="difficulty-indicator difficulty-medium">MEDIUM</span></span>
        </label>
        <label>
          <input type="radio" name="gridCount" value="16" checked>
          <span>Èõ£„Åó„ÅÑ (16ÂÄã)<span class="difficulty-indicator difficulty-hard">HARD</span></span>
        </label>
        <label>
          <input type="radio" name="gridCount" value="25">
          <span>Ë∂ÖÈõ£„Åó„ÅÑ (25ÂÄã)<span class="difficulty-indicator difficulty-hard">EXTREME</span></span>
        </label>
      </div>
      
      <div class="button-group">
        <button id="startButton" class="button button-primary">üéÆ „Ç≤„Éº„É†ÈñãÂßã</button>
        <button id="hintButton" class="button button-secondary" disabled>üí° „Éí„É≥„Éà</button>
        <button id="answerButton" class="button button-secondary" disabled>üëÅÔ∏è Á≠î„Åà„ÇíË¶ã„Çã</button>
        <button id="nextButton" class="button button-primary hidden" disabled>‚û°Ô∏è Ê¨°„ÅÆÂïèÈ°å</button> 
        <button id="endButton" class="button button-danger" disabled>üèÅ ÁµÇ‰∫Ü</button>
      </div>
    </div>
    
    <div id="gameGrid" class="game-grid"></div>
    <div id="message" class="message"></div>
  </div>
  
  <script>
    // „Ç´„É©„Éº„Éë„É¨„ÉÉ„ÉàÔºà„Çà„ÇäÈÆÆ„ÇÑ„Åã„ÅßÁæé„Åó„ÅÑËâ≤Ôºâ
    const colors = [
      '#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7',
      '#DDA0DD', '#98D8C8', '#F7DC6F', '#BB8FCE', '#82E0AA'
    ];
    
    const shapeTypes = ["star", "square", "triangle", "ellipse", "hexagon", "diamond"];
    
    // „Ç≤„Éº„É†Áä∂ÊÖã
    let round = 0;
    let score = 0;
    let streak = 0;
    let gameActive = false;
    let currentCorrectCell = null;
    let hintUsed = false;
    let currentShapeType = null;
    let gridCount = 16;
    let messageTimeoutId = null; // „É°„ÉÉ„Çª„Éº„Ç∏Ë°®Á§∫Áî®„ÅÆ„Çø„Ç§„Éû„ÉºID
    let nextRoundTimeoutId = null; // Ê¨°„ÅÆ„É©„Ç¶„É≥„Éâ„Å∏„ÅÆËá™ÂãïÈÅ∑ÁßªÁî®„Çø„Ç§„Éû„ÉºID
    
    // DOMË¶ÅÁ¥†
    const roundDisplay = document.getElementById("roundDisplay");
    const scoreDisplay = document.getElementById("scoreDisplay");
    const streakDisplay = document.getElementById("streakDisplay");
    const progressFill = document.getElementById("progressFill");
    const gameGrid = document.getElementById("gameGrid");
    const messageDiv = document.getElementById("message");
    const startButton = document.getElementById("startButton");
    const hintButton = document.getElementById("hintButton");
    const answerButton = document.getElementById("answerButton");
    const nextButton = document.getElementById("nextButton"); // „Åì„ÅÆ„Éú„Çø„É≥„ÅØ‰Ωø„Çè„Çå„Å™„ÅÑ„Åå„ÄÅID„ÅØÊÆã„Åó„Å¶„Åä„Åè
    const endButton = document.getElementById("endButton");
    const gridRadios = document.querySelectorAll("input[name='gridCount']");
    
    // ËÉåÊôØ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥
    function createBackgroundShapes() {
      const container = document.querySelector('.background-shapes');
      const shapes = ['‚≠ê', 'üî∂', 'üî∑', 'üî∏', 'üîπ', '‚¨¢', '‚¨ü'];
      
      for (let i = 0; i < 15; i++) {
        const shape = document.createElement('div');
        shape.className = 'bg-shape';
        shape.textContent = shapes[Math.floor(Math.random() * shapes.length)];
        shape.style.left = Math.random() * 100 + '%';
        shape.style.top = Math.random() * 100 + '%';
        shape.style.fontSize = (Math.random() * 30 + 20) + 'px';
        shape.style.animationDelay = Math.random() * 8 + 's';
        shape.style.animationDuration = (Math.random() * 4 + 6) + 's';
        container.appendChild(shape);
      }
    }
    
    // Áµ±Ë®àÊõ¥Êñ∞
    function updateStats() {
      roundDisplay.textContent = round;
      scoreDisplay.textContent = score;
      streakDisplay.textContent = streak;
      
      // ÈÄ≤Êçó„Éê„ÉºÊõ¥Êñ∞ÔºàÊúÄÂ§ß„É©„Ç¶„É≥„Éâ20„Å®„Åó„Å¶Ôºâ
      const progress = Math.min((round / 20) * 100, 100);
      progressFill.style.width = progress + '%';
    }
    
    // „É©„É≥„ÉÄ„É†„Ç™„Éï„Çª„ÉÉ„Éà
    function getRandomOffset() {
      return Math.floor(Math.random() * 21) - 10;
    }
    
    // Âõ≥ÂΩ¢ÁîüÊàêÈñ¢Êï∞Áæ§
    function createStarPoints(sides, outer, innerFactor, rotation = 0) {
      let pts = "";
      for (let i = 0; i < 2 * sides; i++) {
        const isOuter = i % 2 === 0;
        const r = isOuter ? outer : outer * innerFactor;
        const angle = (Math.PI * i) / sides - Math.PI/2 + rotation;
        const x = outer + r * Math.cos(angle);
        const y = outer + r * Math.sin(angle);
        pts += `${x},${y} `;
      }
      return pts.trim();
    }
    
    function createStarSVG(isDiff, delta, fillColor) {
      const outer = 50;
      const sides = 5;
      const baseInnerFactor = 0.5;
      const innerFactor = isDiff ? baseInnerFactor + delta : baseInnerFactor;
      const svgNS = "http://www.w3.org/2000/svg";
      const svg = document.createElementNS(svgNS, "svg");
      svg.setAttribute("width", outer * 2);
      svg.setAttribute("height", outer * 2);
      const polygon = document.createElementNS(svgNS, "polygon");
      polygon.setAttribute("points", createStarPoints(sides, outer, innerFactor, 0));
      polygon.setAttribute("fill", fillColor);
      polygon.setAttribute("stroke", "rgba(0,0,0,0.3)");
      polygon.setAttribute("stroke-width", "2");
      svg.appendChild(polygon);
      return svg;
    }
    
    function createSquareSVG(isDiff, fillColor) {
      const size = 100;
      const svgNS = "http://www.w3.org/2000/svg";
      const svg = document.createElementNS(svgNS, "svg");
      svg.setAttribute("width", size);
      svg.setAttribute("height", size);
      const rect = document.createElementNS(svgNS, "rect");
      rect.setAttribute("x", "5");
      rect.setAttribute("y", "5");
      rect.setAttribute("width", isDiff ? size - 15 : size - 10);
      rect.setAttribute("height", isDiff ? size - 15 : size - 10);
      rect.setAttribute("fill", fillColor);
      rect.setAttribute("stroke", "rgba(0,0,0,0.3)");
      rect.setAttribute("stroke-width", "2");
      rect.setAttribute("rx", "5");
      svg.appendChild(rect);
      return svg;
    }
    
    function createTriangleSVG(isDiff, fillColor) {
      const size = 100;
      const svgNS = "http://www.w3.org/2000/svg";
      const svg = document.createElementNS(svgNS, "svg");
      svg.setAttribute("width", size);
      svg.setAttribute("height", size);
      const polygon = document.createElementNS(svgNS, "polygon");
      const offset = isDiff ? 8 : 0;
      polygon.setAttribute("points", `${size/2},10 ${size-10},${size-10} ${10+offset},${size-10}`);
      polygon.setAttribute("fill", fillColor);
      polygon.setAttribute("stroke", "rgba(0,0,0,0.3)");
      polygon.setAttribute("stroke-width", "2");
      svg.appendChild(polygon);
      return svg;
    }
    
    function createEllipseSVG(isDiff, fillColor) {
      const width = 100, height = 70;
      const svgNS = "http://www.w3.org/2000/svg";
      const svg = document.createElementNS(svgNS, "svg");
      svg.setAttribute("width", width);
      svg.setAttribute("height", height);
      const ellipse = document.createElementNS(svgNS, "ellipse");
      ellipse.setAttribute("cx", width/2);
      ellipse.setAttribute("cy", height/2);
      ellipse.setAttribute("rx", (width/2 - 10) * (isDiff ? 0.85 : 1));
      ellipse.setAttribute("ry", height/2 - 10);
      ellipse.setAttribute("fill", fillColor);
      ellipse.setAttribute("stroke", "rgba(0,0,0,0.3)");
      ellipse.setAttribute("stroke-width", "2");
      svg.appendChild(ellipse);
      return svg;
    }
    
    function createHexagonSVG(isDiff, fillColor) {
      const outer = 45;
      const sides = 6;
      const svgNS = "http://www.w3.org/2000/svg";
      const svg = document.createElementNS(svgNS, "svg");
      svg.setAttribute("width", outer * 2 + 10);
      svg.setAttribute("height", outer * 2 + 10);
      const polygon = document.createElementNS(svgNS, "polygon");
      let pts = "";
      for (let i = 0; i < sides; i++) {
        let r = outer;
        if (isDiff && i === 2) r = outer * 0.8;
        const angle = (2 * Math.PI * i) / sides - Math.PI/2;
        const x = outer + 5 + r * Math.cos(angle);
        const y = outer + 5 + r * Math.sin(angle);
        pts += `${x},${y} `;
      }
      polygon.setAttribute("points", pts.trim());
      polygon.setAttribute("fill", fillColor);
      polygon.setAttribute("stroke", "rgba(0,0,0,0.3)");
      polygon.setAttribute("stroke-width", "2");
      svg.appendChild(polygon);
      return svg;
    }
    
    function createDiamondSVG(isDiff, fillColor) {
      const size = 100;
      const svgNS = "http://www.w3.org/2000/svg";
      const svg = document.createElementNS(svgNS, "svg");
      svg.setAttribute("width", size);
      svg.setAttribute("height", size);
      const polygon = document.createElementNS(svgNS, "polygon");
      const offset = isDiff ? 8 : 0;
      polygon.setAttribute("points", `${size/2},10 ${size-10},${size/2} ${size/2-offset},${size-10} 10,${size/2}`);
      polygon.setAttribute("fill", fillColor);
      polygon.setAttribute("stroke", "rgba(0,0,0,0.3)");
      polygon.setAttribute("stroke-width", "2");
      svg.appendChild(polygon);
      return svg;
    }
    
    function createShapeSVG(type, isDiff, fillColor, delta) {
      switch (type) {
        case "star": return createStarSVG(isDiff, delta, fillColor);
        case "square": return createSquareSVG(isDiff, fillColor);
        case "triangle": return createTriangleSVG(isDiff, fillColor);
        case "ellipse": return createEllipseSVG(isDiff, fillColor);
        case "hexagon": return createHexagonSVG(isDiff, fillColor);
        case "diamond": return createDiamondSVG(isDiff, fillColor);
        default: return createStarSVG(isDiff, delta, fillColor);
      }
    }
    
    function showMessage(text, type = 'info') {
      messageDiv.textContent = text;
      messageDiv.className = `message ${type}`;
      messageDiv.style.opacity = '0';
      messageDiv.style.transform = 'translateY(20px)';
      if (messageTimeoutId) clearTimeout(messageTimeoutId); // Clear previous timeout for messages
      messageTimeoutId = setTimeout(() => {
        messageDiv.style.opacity = '1';
        messageDiv.style.transform = 'translateY(0)';
      }, 100);
    }
    
    // „Ç≤„Éº„É†ÂÜÖ„ÅÆ„Çª„É´„Å∏„ÅÆ„Ç§„É≥„Çø„É©„ÇØ„Ç∑„Éß„É≥„ÇíÊúâÂäπ/ÁÑ°Âäπ„Å´„Åô„Çã
    function enableGameInteraction(enable) {
        document.querySelectorAll('.cell').forEach(c => {
            c.style.pointerEvents = enable ? 'auto' : 'none';
            c.classList.remove('correct', 'incorrect', 'hint-highlight'); // „Çπ„Çø„Ç§„É´„Çí„ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„Éó
            const overlay = c.querySelector('.diff-overlay'); // „Ç™„Éº„Éê„Éº„É¨„Ç§„ÇíÂâäÈô§
            if (overlay) overlay.remove();
        });
        hintButton.disabled = !enable;
        answerButton.disabled = !enable;
    }
    
    function setupGame() {
      if (messageTimeoutId) clearTimeout(messageTimeoutId);
      if (nextRoundTimeoutId) clearTimeout(nextRoundTimeoutId); // ÂâçÂõû„ÅÆËá™ÂãïÈÅ∑Áßª„Çø„Ç§„Éû„Éº„Çí„ÇØ„É™„Ç¢
      
      const selectedGridRadio = document.querySelector("input[name='gridCount']:checked");
      gridCount = parseInt(selectedGridRadio.value, 10);
      
      gameGrid.innerHTML = "";
      messageDiv.textContent = "";
      hintUsed = false;
      currentCorrectCell = null;
      // nextButton„ÅØÊ≠£Ëß£ÊôÇ„Å´‰Ωø„Çè„Å™„ÅÑ„ÅÆ„Åß„ÄÅÂ∏∏„Å´Èö†„Åó„Å¶„Åä„Åè
      nextButton.classList.add('hidden'); 
      nextButton.disabled = true; 
      
      const nCols = Math.sqrt(gridCount);
      gameGrid.style.gridTemplateColumns = `repeat(${nCols}, 140px)`;
      
      currentShapeType = shapeTypes[Math.floor(Math.random() * shapeTypes.length)];
      
      let delta = 0;
      if (currentShapeType === "star") {
        delta = Math.max(0.25 - 0.01 * round, 0.05); // „É©„Ç¶„É≥„Éâ„Å´Âøú„Åò„Å¶Èõ£ÊòìÂ∫¶„ÇíË™øÊï¥
      }
      
      const diffIndex = Math.floor(Math.random() * gridCount);
      
      for (let i = 0; i < gridCount; i++) {
        const cell = document.createElement("div");
        cell.className = "cell";
        
        const offsetX = getRandomOffset() + "px";
        const offsetY = getRandomOffset() + "px";
        
        const fillColor = colors[Math.floor(Math.random() * colors.length)];
        const shapeSVG = createShapeSVG(currentShapeType, i === diffIndex, fillColor, delta);
        
        shapeSVG.style.transform = `translate(${offsetX}, ${offsetY})`;
        cell.appendChild(shapeSVG);
        
        if (i === diffIndex) {
          currentCorrectCell = cell;
        }
        
        cell.addEventListener("click", () => {
          if (!gameActive) return; // „Ç≤„Éº„É†„Åå„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Åß„Å™„ÅÑÂ†¥Âêà„ÅØ„ÇØ„É™„ÉÉ„ÇØ„ÇíÁÑ°Ë¶ñ
          
          enableGameInteraction(false); // Êõ¥„Å™„Çã„ÇØ„É™„ÉÉ„ÇØ„Çí„Åô„Åê„Å´ÁÑ°ÂäπÂåñ
          
          if (i === diffIndex) {
            cell.classList.add('correct');
            showMessage("üéâ Ê≠£Ëß£ÔºÅÁ¥†Êô¥„Çâ„Åó„ÅÑÔºÅ", 'success');
            score += 10 + streak * 2;
            streak++;
            round++;
            
            updateStats();
            hintButton.disabled = true;
            answerButton.disabled = true;
            
            // Ê≠£Ëß£Âæå„ÄÅÁü≠„ÅÑÈÅÖÂª∂„ÅÆÂæå„Å´Ê¨°„ÅÆÂïèÈ°å„Å∏Ëá™ÂãïÈÅ∑Áßª
            nextRoundTimeoutId = setTimeout(() => {
                if (gameActive) { // „Ç≤„Éº„É†„ÅåÁµÇ‰∫Ü„Åó„Å¶„ÅÑ„Å™„ÅÑÂ†¥Âêà„ÅÆ„ÅøÊ¨°„Å∏ÈÄ≤„ÇÄ
                    enableGameInteraction(true); // Ê¨°„ÅÆ„É©„Ç¶„É≥„Éâ„ÅÆ„Åü„ÇÅ„Å´„ÇØ„É™„ÉÉ„ÇØ„ÇíÊúâÂäπÂåñ
                    setupGame();
                }
            }, 1000); // 1ÁßíÂæå„Å´Ê¨°„ÅÆÂïèÈ°å„Å∏
            
          } else {
            cell.classList.add('incorrect');
            showMessage("‚ùå ‰∏çÊ≠£Ëß£ÔºÅÊ≠£Ëß£„ÅØËµ§„ÅÑÂç∞„ÅßÁ§∫„Åï„Çå„Å¶„ÅÑ„Åæ„Åô", 'error');
            
            if (currentCorrectCell) {
              const overlay = document.createElement("div");
              overlay.className = "diff-overlay";
              currentCorrectCell.appendChild(overlay);
            }
            
            streak = 0;
            round = Math.max(round - 1, 1); // „É©„Ç¶„É≥„Éâ„Åå1Êú™Ê∫Ä„Å´„Å™„Çâ„Å™„ÅÑ„Çà„ÅÜ„Å´„Åô„Çã
            
            updateStats();
            hintButton.disabled = true;
            answerButton.disabled = true;
            
            // ‰∏çÊ≠£Ëß£Âæå„ÄÅÁü≠„ÅÑÈÅÖÂª∂„ÅÆÂæå„Å´Ê¨°„ÅÆÂïèÈ°å„Å∏Ëá™ÂãïÈÅ∑ÁßªÔºà„Åæ„Åü„ÅØ„É¶„Éº„Ç∂„Éº„Åå„ÄåÊ¨°„ÅÆÂïèÈ°å„Äç„ÇíÊäº„Åô„Åæ„ÅßÂæÖÊ©üÔºâ
            // Ëá™ÂãïÈÅ∑Áßª„Åï„Åõ„ÇãÂ†¥Âêà:
            nextRoundTimeoutId = setTimeout(() => {
                if (gameActive) { // „Ç≤„Éº„É†„ÅåÁµÇ‰∫Ü„Åó„Å¶„ÅÑ„Å™„ÅÑÂ†¥Âêà„ÅÆ„ÅøÊ¨°„Å∏ÈÄ≤„ÇÄ
                    enableGameInteraction(true); // Ê¨°„ÅÆ„É©„Ç¶„É≥„Éâ„ÅÆ„Åü„ÇÅ„Å´„ÇØ„É™„ÉÉ„ÇØ„ÇíÊúâÂäπÂåñ
                    setupGame();
                }
            }, 2000); // ‰∏çÊ≠£Ëß£„ÅÆÂ†¥Âêà„ÅØÂ∞ë„ÅóÈï∑„ÇÅ„Å´ÂæÖ„Å§
            
            // Ëá™ÂãïÈÅ∑Áßª„Åï„Åõ„Åö„Å´„É¶„Éº„Ç∂„Éº„Å´„ÄåÊ¨°„ÅÆÂïèÈ°å„Äç„Éú„Çø„É≥„ÇíÊäº„Åï„Åõ„ÇãÂ†¥ÂêàÔºàÂâç„ÅÆ„Éê„Éº„Ç∏„Éß„É≥„Å´Êàª„ÅôÂ†¥ÂêàÔºâ„ÅØ„ÄÅ
            // ‰∏äË®ò„ÅÆsetTimeout„ÇíÂâäÈô§„Åó„ÄÅ‰ª•‰∏ã„ÅÆ2Ë°å„ÇíÊúâÂäπ„Å´„Åô„Çã:
            // nextButton.classList.remove('hidden');
            // nextButton.disabled = false;
          }
        });
        
        gameGrid.appendChild(cell);
      }
      
      enableGameInteraction(true); // Êñ∞„Åó„ÅÑ„É©„Ç¶„É≥„Éâ„ÅÆ„Åü„ÇÅ„Å´„Ç§„É≥„Çø„É©„ÇØ„Ç∑„Éß„É≥„ÇíÊúâÂäπÂåñ
      hintButton.disabled = false;
      answerButton.disabled = false;
      showMessage(`„É©„Ç¶„É≥„Éâ ${round}: ÈÅï„ÅÑ„ÇíË¶ã„Å§„Åë„Å¶„Åè„Å†„Åï„ÅÑÔºÅ`, 'info');
    }
    
    function resetGame() {
        if (messageTimeoutId) clearTimeout(messageTimeoutId);
        if (nextRoundTimeoutId) clearTimeout(nextRoundTimeoutId);
        
        round = 0;
        score = 0;
        streak = 0;
        gameActive = false;
        updateStats();
        messageDiv.textContent = "";
        gameGrid.innerHTML = "";
        hintButton.disabled = true;
        answerButton.disabled = true;
        nextButton.classList.add('hidden');
        nextButton.disabled = true;
        endButton.disabled = true;
        startButton.textContent = "üéÆ „Ç≤„Éº„É†ÈñãÂßã";
        showMessage("„Ç≤„Éº„É†„ÇíÂßã„ÇÅ„Çã„Å´„ÅØ„Äå„Ç≤„Éº„É†ÈñãÂßã„Äç„Éú„Çø„É≥„ÇíÊäº„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ", 'info');
        enableGridSelection(true); // Èõ£ÊòìÂ∫¶ÈÅ∏Êäû„ÇíË®±ÂèØ
    }
    
    // Èõ£ÊòìÂ∫¶ÈÅ∏Êäû„ÅÆ„É©„Ç∏„Ç™„Éú„Çø„É≥„ÇíÊúâÂäπ/ÁÑ°Âäπ„Å´„Åô„Çã
    function enableGridSelection(enable) {
        gridRadios.forEach(radio => {
            radio.disabled = !enable;
            // Ë¶™Ë¶ÅÁ¥†„ÅÆlabel„Å´ÂØæ„Åó„Å¶„Éù„Ç§„É≥„Çø„Éº„Ç§„Éô„É≥„Éà„Å®ÈÄèÊòéÂ∫¶„ÇíÂà∂Âæ°
            radio.parentElement.style.pointerEvents = enable ? 'auto' : 'none'; 
            radio.parentElement.style.opacity = enable ? '1' : '0.6'; 
        });
    }
    
    // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº
    startButton.addEventListener("click", () => {
      gameActive = true;
      round = 1; // „Ç≤„Éº„É†ÈñãÂßãÊôÇ„Å´„É©„Ç¶„É≥„Éâ„Çí1„Å´Ë®≠ÂÆö
      score = 0;
      streak = 0;
      updateStats();
      hintButton.disabled = false;
      answerButton.disabled = false;
      endButton.disabled = false;
      startButton.textContent = "üîÑ „É™„Çπ„Çø„Éº„Éà";
      enableGridSelection(false); // „Ç≤„Éº„É†‰∏≠„ÅØÈõ£ÊòìÂ∫¶ÈÅ∏Êäû„ÇíÁÑ°ÂäπÂåñ
      setupGame();
    });
    
    hintButton.addEventListener("click", () => {
      if (!hintUsed && currentCorrectCell) {
        currentCorrectCell.classList.add('hint-highlight');
        hintUsed = true;
        hintButton.disabled = true;
        showMessage("üí° „Éí„É≥„Éà: ÂÖâ„Å£„Å¶„ÅÑ„Çã„Çª„É´„Å´Ê≥®ÁõÆÔºÅ", 'info');
        score = Math.max(0, score - 5); // „Éí„É≥„Éà‰ΩøÁî®„ÅßÊ∏õÁÇπ
        updateStats();
      }
    });
    
    answerButton.addEventListener("click", () => {
        if (currentCorrectCell) {
            enableGameInteraction(false); // „ÇØ„É™„ÉÉ„ÇØ„ÇíÁÑ°ÂäπÂåñ
            currentCorrectCell.classList.add('correct'); // Ê≠£Ëß£„Çª„É´„Çí„Éè„Ç§„É©„Ç§„Éà
            const overlay = document.createElement("div");
            overlay.className = "diff-overlay";
            currentCorrectCell.appendChild(overlay);
            showMessage("üëÄ Á≠î„Åà„Åß„ÅôÔºÅÊ¨°È†ëÂºµ„Å£„Å¶„Å≠ÔºÅ", 'info');
            streak = 0;
            score = Math.max(0, score - 10); // Á≠î„Åà„ÇíË¶ã„Çã„Åì„Å®„Åß„Åï„Çâ„Å´Ê∏õÁÇπ
            updateStats();
            
            // Á≠î„Åà„ÇíË¶ã„ÅüÂæå„ÇÇ„ÄÅËá™ÂãïÁöÑ„Å´Ê¨°„ÅÆÂïèÈ°å„Å∏ÈÅ∑Áßª
            nextRoundTimeoutId = setTimeout(() => {
                if (gameActive) {
                    enableGameInteraction(true);
                    setupGame();
                }
            }, 2000); // 2ÁßíÂæå„Å´Ê¨°„ÅÆÂïèÈ°å„Å∏
            
            hintButton.disabled = true;
            answerButton.disabled = true;
        }
    });
    
    // nextButton„ÅØËá™ÂãïÈÅ∑Áßª„ÅÆ„Åü„ÇÅ„ÄÅ„ÇØ„É™„ÉÉ„ÇØ„Ç§„Éô„É≥„Éà„ÅØÂü∫Êú¨ÁöÑ„Å´‰ΩøÁî®„Åó„Å™„ÅÑ
    // nextButton.addEventListener("click", () => {
    //     if (!gameActive) return;
    //     enableGameInteraction(true);
    //     setupGame();
    //     nextButton.classList.add('hidden');
    //     nextButton.disabled = true;
    // });
    
    endButton.addEventListener("click", () => {
        gameActive = false;
        showMessage(`„Ç≤„Éº„É†ÁµÇ‰∫ÜÔºÅÊúÄÁµÇ„Çπ„Ç≥„Ç¢: ${score}ÁÇπ„ÄÇ„Åæ„ÅüÈÅä„Çì„Åß„Å≠ÔºÅ`, 'info');
        resetGame();
    });
    
    // „É≠„Éº„ÉâÊôÇ„Å´„Ç≤„Éº„É†„ÇíÂàùÊúüÂåñ
    document.addEventListener("DOMContentLoaded", () => {
        createBackgroundShapes();
        resetGame(); // ÂàùÊúüÁä∂ÊÖã„ÇíË®≠ÂÆö
    });
    
    // Èõ£ÊòìÂ∫¶Â§âÊõ¥„É©„Ç∏„Ç™„Éú„Çø„É≥„ÅÆÂá¶ÁêÜ
    gridRadios.forEach(radio => {
        radio.addEventListener('change', (event) => {
            gridCount = parseInt(event.target.value, 10);
            if (!gameActive) {
                // „Ç≤„Éº„É†‰∏≠„Åß„Å™„ÅÑÂ†¥Âêà„ÄÅ„Ç∞„É™„ÉÉ„Éâ„Çµ„Ç§„Ç∫„ÇíË¶ñË¶öÁöÑ„Å´Êõ¥Êñ∞ÔºàÂøÖË¶Å„Åß„ÅÇ„Çå„Å∞Ôºâ
                const nCols = Math.sqrt(gridCount);
                gameGrid.style.gridTemplateColumns = `repeat(${nCols}, 140px)`;
            }
        });
    });
  </script>
</body>
</html>
