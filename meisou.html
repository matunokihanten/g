<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒã‚¤ãƒ³ãƒ‰ãƒ•ãƒ«ãƒã‚¹ãƒ»ã‚¹ã‚­ãƒ£ãƒ³</title>
    <style>
        :root {
            --bg-grad-light: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --bg-grad-dark: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            --text-light: white;
            --text-dark: #333;
            --primary-accent: #feca57;
            --secondary-accent: #ff6b6b;
            --info-accent: #48dbfb;
            --component-bg-light: rgba(255, 255, 255, 0.1);
            --component-bg-dark: rgba(0, 0, 0, 0.2);
            --border-color-light: rgba(255, 255, 255, 0.2);
            --border-color-dark: rgba(255, 255, 255, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: var(--bg-grad-light);
            min-height: 100vh;
            color: var(--text-light);
            overflow-x: hidden;
            transition: background 0.5s ease;
        }

        body.dark-mode {
            background: var(--bg-grad-dark);
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            animation: fadeInDown 1s ease-out;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            margin-bottom: 30px;
            animation: fadeInUp 1s ease-out 0.3s both;
        }

        .control-group {
            background: var(--component-bg-light);
            padding: 15px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid var(--border-color-light);
            min-width: 200px;
            transition: background 0.3s, border-color 0.3s;
        }

        body.dark-mode .control-group {
            background: var(--component-bg-dark);
            border: 1px solid var(--border-color-dark);
        }

        .control-group h3 {
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .control-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        fieldset {
            border: none;
        }

        fieldset:disabled .control-row,
        fieldset:disabled button {
            opacity: 0.5;
            cursor: not-allowed;
        }

        button {
            background: linear-gradient(45deg, var(--secondary-accent), var(--primary-accent));
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1em;
        }

        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.2);
        }

        button:active:not(:disabled) {
            transform: translateY(0);
        }

        button.active {
            background: linear-gradient(45deg, var(--info-accent), #0abde3);
        }

        select, input[type="range"] {
            width: 100%;
            padding: 8px;
            border-radius: 10px;
            border: 1px solid transparent;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            font-size: 1em;
        }
        
        body.dark-mode select, body.dark-mode input[type="range"] {
             background: rgba(0, 0, 0, 0.3);
        }

        select option {
            background: #333;
            color: white;
        }

        .session-area {
            background: var(--component-bg-light);
            padding: 30px;
            border-radius: 20px;
            backdrop-filter: blur(15px);
            border: 1px solid var(--border-color-light);
            text-align: center;
            margin-bottom: 20px;
            animation: fadeIn 1s ease-out 0.6s both;
            transition: background 0.3s, border-color 0.3s;
        }
        
        body.dark-mode .session-area {
            background: var(--component-bg-dark);
            border: 1px solid var(--border-color-dark);
        }

        .timer-display {
            font-size: 3em;
            font-weight: bold;
            margin: 20px 0;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            margin: 20px 0;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--secondary-accent), var(--primary-accent));
            width: 0%;
            transition: width 1s ease;
            border-radius: 4px;
        }

        .guidance-text {
            font-size: 1.2em;
            line-height: 1.6;
            margin: 20px 0;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.5s ease;
        }

        .guidance-text.show {
            opacity: 1;
        }

        .body-parts {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin: 20px 0;
            transition: opacity 0.5s, max-height 0.5s;
            max-height: 500px;
            opacity: 1;
        }
        
        .body-parts.hidden {
            max-height: 0;
            opacity: 0;
            margin: 0;
            overflow: hidden;
        }

        .body-part {
            background: rgba(255, 255, 255, 0.1);
            padding: 10px;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .body-part:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.05);
        }

        .body-part.active {
            border-color: var(--primary-accent);
            background: rgba(254, 202, 87, 0.3);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .breathing-guide-container {
            position: relative;
            margin: 20px auto;
            width: 150px;
            height: 150px;
            display: none; /* Initially hidden */
        }
        
        .breathing-guide-container.active {
            display: block;
        }

        .breathing-guide {
            width: 100%;
            height: 100%;
            border: 3px solid rgba(255, 255, 255, 0.5);
            border-radius: 50%;
            position: relative;
            transition: all 4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .breathing-guide-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.2em;
            color: var(--text-light);
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }
        
        .breathing-guide-text.show {
            opacity: 1;
        }

        .breathing-guide.inhale {
            transform: scale(1.5);
            border-color: var(--info-accent);
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
            animation: fadeInUp 1s ease-out 0.9s both;
        }

        .stat-card {
            background: var(--component-bg-light);
            padding: 15px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            text-align: center;
            transition: background 0.3s;
        }
        
        body.dark-mode .stat-card {
            background: var(--component-bg-dark);
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: var(--primary-accent);
        }

        .floating-particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
        }

        .particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            animation: float 20s infinite linear;
        }

        @keyframes float {
            from { transform: translateY(100vh) rotate(0deg); opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            to { transform: translateY(-100px) rotate(360deg); opacity: 0; }
        }

        @keyframes fadeInDown {
            from { opacity: 0; transform: translateY(-50px); } to { opacity: 1; transform: translateY(0); }
        }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(50px); } to { opacity: 1; transform: translateY(0); }
        }
        @keyframes fadeIn {
            from { opacity: 0; } to { opacity: 1; }
        }

        .hidden { display: none !important; }

        @media (max-width: 768px) {
            .controls { flex-direction: column; }
            .control-group { min-width: auto; }
            .timer-display { font-size: 2.5em; }
        }
    </style>
</head>
<body>
    <audio id="bgm-rain" loop src="https://www.soundjay.com/nature/rain-07.mp3"></audio>
    <audio id="bgm-ocean" loop src="https://www.soundjay.com/nature/ocean-wave-1.mp3"></audio>
    <audio id="bgm-forest" loop src="https://www.soundjay.com/nature/forest-01.mp3"></audio>
    <audio id="bell-sound" src="https://www.soundjay.com/buttons/sounds/button-16.mp3"></audio>

    <div class="floating-particles" id="particles"></div>
    
    <div class="container">
        <div class="header">
            <h1>ğŸ§˜ ãƒã‚¤ãƒ³ãƒ‰ãƒ•ãƒ«ãƒã‚¹ãƒ»ã‚¹ã‚­ãƒ£ãƒ³</h1>
            <p>å¿ƒã¨èº«ä½“ã®èª¿å’Œã‚’è¦‹ã¤ã‘ã¾ã—ã‚‡ã†</p>
        </div>

        <div class="controls">
            <fieldset id="sessionSettings">
                <div class="control-group">
                    <h3>â° ã‚»ãƒƒã‚·ãƒ§ãƒ³è¨­å®š</h3>
                    <div class="control-row">
                        <label for="duration">æ™‚é–“:</label>
                        <select id="duration">
                            <option value="300">5åˆ†</option>
                            <option value="600" selected>10åˆ†</option>
                            <option value="900">15åˆ†</option>
                            <option value="1200">20åˆ†</option>
                            <option value="1800">30åˆ†</option>
                        </select>
                    </div>
                    <div class="control-row">
                        <label for="scanType">ã‚¿ã‚¤ãƒ—:</label>
                        <select id="scanType">
                            <option value="body">ãƒœãƒ‡ã‚£ã‚¹ã‚­ãƒ£ãƒ³</option>
                            <option value="breathing">å‘¼å¸ç‘æƒ³</option>
                            <option value="mindfulness">ãƒã‚¤ãƒ³ãƒ‰ãƒ•ãƒ«ãƒã‚¹</option>
                            <option value="gratitude">æ„Ÿè¬ã®ç‘æƒ³</option>
                        </select>
                    </div>
                </div>
            </fieldset>
            
            <fieldset id="audioSettings">
                 <div class="control-group">
                    <h3>ğŸµ éŸ³éŸ¿è¨­å®š</h3>
                    <div class="control-row">
                        <label for="backgroundMusic">BGM:</label>
                        <select id="backgroundMusic">
                            <option value="none" selected>ãªã—</option>
                            <option value="rain">é›¨éŸ³</option>
                            <option value="ocean">æµ·ã®éŸ³</option>
                            <option value="forest">æ£®æ—</option>
                        </select>
                    </div>
                    <div class="control-row">
                        <label for="volume">éŸ³é‡:</label>
                        <input type="range" id="volume" min="0" max="1" step="0.01" value="0.5">
                    </div>
                    <button id="bellToggle">ğŸ”” ãƒ™ãƒ«éŸ³: ã‚ªãƒ³</button>
                </div>
            </fieldset>

            <div class="control-group">
                <h3>ğŸ¨ ç’°å¢ƒè¨­å®š</h3>
                <button id="themeToggle">ğŸŒ™ ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰</button>
                <button id="particleToggle">âœ¨ ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«: ã‚ªãƒ³</button>
            </div>
        </div>

        <div class="session-area">
            <div class="timer-display" id="timerDisplay">10:00</div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            
            <div class="breathing-guide-container" id="breathingGuideContainer">
                <div class="breathing-guide" id="breathingCircle"></div>
                <div class="breathing-guide-text" id="breathingText"></div>
            </div>
            
            <div class="guidance-text show" id="guidanceText">
                ãƒªãƒ©ãƒƒã‚¯ã‚¹ã—ã¦ã€æº–å‚™ãŒã§ããŸã‚‰é–‹å§‹ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„
            </div>

            <button id="startBtn">â–¶ é–‹å§‹</button>
            <button id="pauseBtn" class="hidden">â¸ ä¸€æ™‚åœæ­¢</button>
            <button id="stopBtn" class="hidden">â¹ åœæ­¢</button>

            <div class="body-parts" id="bodyParts">
                <div class="body-part" data-part="é ­">é ­</div>
                <div class="body-part" data-part="é¡">é¡</div>
                <div class="body-part" data-part="ç›®">ç›®</div>
                <div class="body-part" data-part="é¼»">é¼»</div>
                <div class="body-part" data-part="å£">å£</div>
                <div class="body-part" data-part="é¦–">é¦–</div>
                <div class="body-part" data-part="è‚©">è‚©</div>
                <div class="body-part" data-part="è…•">è…•</div>
                <div class="body-part" data-part="æ‰‹">æ‰‹</div>
                <div class="body-part" data-part="èƒ¸">èƒ¸</div>
                <div class="body-part" data-part="èƒŒä¸­">èƒŒä¸­</div>
                <div class="body-part" data-part="è…¹">è…¹</div>
                <div class="body-part" data-part="è…°">è…°</div>
                <div class="body-part" data-part="å¤ªã‚‚ã‚‚">å¤ªã‚‚ã‚‚</div>
                <div class="body-part" data-part="è†">è†</div>
                <div class="body-part" data-part="ãµãã‚‰ã¯ã">ãµãã‚‰ã¯ã</div>
                <div class="body-part" data-part="è¶³">è¶³</div>
            </div>
        </div>

        <div class="stats">
            <div class="stat-card">
                <div class="stat-value" id="totalSessions">0</div>
                <div>ç·ã‚»ãƒƒã‚·ãƒ§ãƒ³æ•°</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalTime">0</div>
                <div>ç·ç‘æƒ³æ™‚é–“ï¼ˆåˆ†ï¼‰</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="streak">0</div>
                <div>é€£ç¶šæ—¥æ•°</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="todayTime">0</div>
                <div>ä»Šæ—¥ã®ç‘æƒ³æ™‚é–“ï¼ˆåˆ†ï¼‰</div>
            </div>
        </div>
    </div>

    <script>
        class MindfulnessApp {
            constructor() {
                // DOM Elements
                this.dom = {
                    timerDisplay: document.getElementById('timerDisplay'),
                    progressFill: document.getElementById('progressFill'),
                    guidanceText: document.getElementById('guidanceText'),
                    bodyPartsContainer: document.getElementById('bodyParts'),
                    bodyPartElements: document.querySelectorAll('.body-part'),
                    breathingGuideContainer: document.getElementById('breathingGuideContainer'),
                    breathingCircle: document.getElementById('breathingCircle'),
                    breathingText: document.getElementById('breathingText'),
                    durationSelect: document.getElementById('duration'),
                    scanTypeSelect: document.getElementById('scanType'),
                    startBtn: document.getElementById('startBtn'),
                    pauseBtn: document.getElementById('pauseBtn'),
                    stopBtn: document.getElementById('stopBtn'),
                    sessionSettings: document.getElementById('sessionSettings'),
                    audioSettings: document.getElementById('audioSettings'),
                    bellToggle: document.getElementById('bellToggle'),
                    themeToggle: document.getElementById('themeToggle'),
                    particleToggle: document.getElementById('particleToggle'),
                    // Audio
                    bgmRain: document.getElementById('bgm-rain'),
                    bgmOcean: document.getElementById('bgm-ocean'),
                    bgmForest: document.getElementById('bgm-forest'),
                    bellSound: document.getElementById('bell-sound'),
                    backgroundMusicSelect: document.getElementById('backgroundMusic'),
                    volumeSlider: document.getElementById('volume'),
                    // Stats
                    totalSessions: document.getElementById('totalSessions'),
                    totalTime: document.getElementById('totalTime'),
                    streak: document.getElementById('streak'),
                    todayTime: document.getElementById('todayTime'),
                };
                
                // State
                this.state = {
                    isRunning: false,
                    isPaused: false,
                    currentTime: 0,
                    totalTime: 0,
                    bellEnabled: true,
                    particlesEnabled: true,
                    isDarkMode: false,
                    stats: {},
                    timer: null,
                    guidanceInterval: null,
                    breathingTimeout: null,
                };
                
                this.bodyParts = [ 'é ­', 'é¡', 'ç›®', 'é¼»', 'å£', 'é¦–', 'è‚©', 'è…•', 'æ‰‹', 'èƒ¸', 'èƒŒä¸­', 'è…¹', 'è…°', 'å¤ªã‚‚ã‚‚', 'è†', 'ãµãã‚‰ã¯ã', 'è¶³' ];
                this.guidanceTexts = {
                    body: [
                        "ã¾ãšã€é ­ã®ã¦ã£ãºã‚“ã«æ„è­˜ã‚’å‘ã‘ã¾ã™", "é¡ã®ç­‹è‚‰ã®ç·Šå¼µã«æ°—ã¥ãã€ã‚†ã£ãã‚Šã¨è§£æ”¾ã—ã¾ã™", "ç›®ã®å‘¨ã‚Šã®ç­‹è‚‰ã‚’å„ªã—ããƒªãƒ©ãƒƒã‚¯ã‚¹ã•ã›ã¾ã™", "é¼»ã‚’é€šã‚‹ç©ºæ°—ã®æµã‚Œã‚’æ„Ÿã˜ã¾ã™", "å£ã¨é¡ã®åŠ›ã‚’æŠœãã€ãƒªãƒ©ãƒƒã‚¯ã‚¹ã•ã›ã¾ã™", "é¦–ã®ç·Šå¼µã‚’è§£æ”¾ã—ã€æ¥½ãªçŠ¶æ…‹ã«ã—ã¾ã™", "è‚©ã®åŠ›ã‚’æŠœãã€è‡ªç„¶ãªä½ç½®ã«ä¸‹ã‚ã—ã¾ã™", "è…•å…¨ä½“ã®é‡ã•ã‚’æ„Ÿã˜ã€å®Œå…¨ã«ãƒªãƒ©ãƒƒã‚¯ã‚¹ã•ã›ã¾ã™", "æ‰‹ã®ã²ã‚‰ã¨æŒ‡å…ˆã®æ„Ÿè¦šã«æ³¨æ„ã‚’å‘ã‘ã¾ã™", "èƒ¸ã®ç©ã‚„ã‹ãªå‹•ãã¨å‘¼å¸ã®ãƒªã‚ºãƒ ã‚’æ„Ÿã˜ã¾ã™", "èƒŒä¸­ã®ç­‹è‚‰ã‚’æ„è­˜ã—ã€ç·Šå¼µã‚’è§£æ”¾ã—ã¾ã™", "ãŠè…¹ã®è‡ªç„¶ãªãµãã‚‰ã¿ã¨ã¸ã“ã¿ã‚’æ„Ÿã˜ã¾ã™", "è…°å›ã‚Šã®ç­‹è‚‰ã‚’ç·©ã‚ã¦ã„ãã¾ã—ã‚‡ã†", "å¤ªã‚‚ã‚‚ã®é‡ã•ã¨æ¸©ã‹ã•ã‚’æ„Ÿã˜ã¾ã™", "è†å‘¨ã‚Šã®æ„Ÿè¦šã«æ°—ã¥ãã¾ã—ã‚‡ã†", "ãµãã‚‰ã¯ãã®ç­‹è‚‰ã‚’ãƒªãƒ©ãƒƒã‚¯ã‚¹ã•ã›ã¾ã™", "è¶³ã®è£ã€ãã—ã¦è¶³å…ˆã®æ„Ÿè¦šã¾ã§æ„è­˜ã‚’å‘ã‘ã¾ã™", "å…¨èº«ãŒæ·±ããƒªãƒ©ãƒƒã‚¯ã‚¹ã—ã¦ã„ã‚‹ã®ã‚’æ„Ÿã˜ã¾ã™"
                    ],
                    breathing: ["è‡ªç„¶ãªå‘¼å¸ã®ãƒªã‚ºãƒ ã‚’æ„Ÿã˜ã¾ã—ã‚‡ã†", "é¼»ã‹ã‚‰ã‚†ã£ãã‚Šã¨æ¯ã‚’å¸ã„è¾¼ã¿ã¾ã™", "æ¯ã‚’æ•°ç§’é–“ã€å¿ƒåœ°ã‚ˆãä¿æŒã—ã¾ã™", "å£ã‹ã‚‰ã‚†ã£ãã‚Šã¨æ¯ã‚’åãå‡ºã—ã¾ã™", "å‘¼å¸ã®éŸ³ã¨æ„Ÿè¦šã«é›†ä¸­ã—ã¾ã—ã‚‡ã†"],
                    mindfulness: ["ä»Šã“ã®ç¬é–“ã«æ„è­˜ã‚’å‘ã‘ã¾ã—ã‚‡ã†", "æ€è€ƒãŒæµ®ã‹ã‚“ã§ã‚‚ã€åˆ¤æ–­ã›ãšã«è¦³å¯Ÿã—ã¾ã™", "æ„Ÿæƒ…ã‚’é›²ã®ã‚ˆã†ã«ã€ãŸã æµã‚Œã¦ã„ãã®ã‚’è¦‹å®ˆã‚Šã¾ã™", "å‘¨å›²ã®éŸ³ã‚„ä½“ã®æ„Ÿè¦šã«æ°—ã¥ãã¾ã—ã‚‡ã†", "ç¾åœ¨ã®ç¬é–“ã«å®Œå…¨ã«å­˜åœ¨ã—ã¾ã™"],
                    gratitude: ["ä»Šæ—¥æ„Ÿè¬ã§ãã‚‹ã“ã¨ã‚’3ã¤æ€ã„æµ®ã‹ã¹ã¾ã—ã‚‡ã†", "ã‚ãªãŸã®äººç”Ÿã‚’è±Šã‹ã«ã—ã¦ãã‚Œã‚‹äººã€…ã¸æ„Ÿè¬ã—ã¾ã™", "è‡ªåˆ†è‡ªèº«ã®å­˜åœ¨ã¨å¥åº·ã«æ„Ÿè¬ã—ã¾ã—ã‚‡ã†", "ä»Šæ—¥ã‚ã£ãŸå°ã•ãªå–œã³ã‚’æ€ã„å‡ºã—ã¾ã™", "æ„Ÿè¬ã®æ°—æŒã¡ãŒå¿ƒã‚’æº€ãŸã™ã®ã‚’æ„Ÿã˜ã¾ã™"]
                };

                this.initializeApp();
            }

            initializeApp() {
                this.loadStats();
                this.bindEvents();
                this.createParticles();
                this.setDuration(this.dom.durationSelect.value);
                this.updateBodyPartVisibility();
            }

            bindEvents() {
                this.dom.startBtn.addEventListener('click', () => this.start());
                this.dom.pauseBtn.addEventListener('click', () => this.pause());
                this.dom.stopBtn.addEventListener('click', () => this.stop());
                this.dom.durationSelect.addEventListener('change', (e) => this.setDuration(e.target.value));
                this.dom.scanTypeSelect.addEventListener('change', () => this.updateBodyPartVisibility());
                this.dom.bellToggle.addEventListener('click', () => this.toggleBell());
                this.dom.particleToggle.addEventListener('click', () => this.toggleParticles());
                this.dom.themeToggle.addEventListener('click', () => this.toggleTheme());
                this.dom.backgroundMusicSelect.addEventListener('change', (e) => this.setBackgroundMusic(e.target.value));
                this.dom.volumeSlider.addEventListener('input', (e) => this.setVolume(e.target.value));
            }

            start() {
                this.state.isRunning = true;
                this.state.isPaused = false;
                this.setDuration(this.dom.durationSelect.value);
                
                this.toggleControls(true);
                this.dom.startBtn.classList.add('hidden');
                this.dom.pauseBtn.classList.remove('hidden');
                this.dom.stopBtn.classList.remove('hidden');

                if (this.state.bellEnabled) this.playBell();
                this.setBackgroundMusic(this.dom.backgroundMusicSelect.value);

                this.state.timer = setInterval(() => {
                    if (!this.state.isPaused) this.tick();
                }, 1000);

                this.startGuidance();
            }

            pause() {
                this.state.isPaused = !this.state.isPaused;
                this.dom.pauseBtn.textContent = this.state.isPaused ? 'â–¶ å†é–‹' : 'â¸ ä¸€æ™‚åœæ­¢';
                
                if (this.state.isPaused) {
                    this.stopBackgroundMusic();
                    clearTimeout(this.state.breathingTimeout);
                } else {
                    this.setBackgroundMusic(this.dom.backgroundMusicSelect.value);
                     if (this.dom.scanTypeSelect.value === 'breathing') this.startBreathingGuide();
                }
            }

            stop(completed = true) {
                if (completed && this.state.isRunning) {
                    const elapsedSeconds = this.state.totalTime - this.state.currentTime;
                    this.updateStats(elapsedSeconds);
                    if (this.state.bellEnabled) this.playBell();
                }

                this.state.isRunning = false;
                this.state.isPaused = false;
                clearInterval(this.state.timer);
                clearInterval(this.state.guidanceInterval);
                clearTimeout(this.state.breathingTimeout);
                
                this.stopBackgroundMusic();
                this.toggleControls(false);

                this.dom.startBtn.classList.remove('hidden');
                this.dom.pauseBtn.classList.add('hidden');
                this.dom.stopBtn.classList.add('hidden');
                this.dom.pauseBtn.textContent = 'â¸ ä¸€æ™‚åœæ­¢';

                this.setDuration(this.dom.durationSelect.value);
                this.resetVisuals();
                this.showGuidanceText(completed ? "ãŠç–²ã‚Œæ§˜ã§ã—ãŸã€‚ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒå®Œäº†ã—ã¾ã—ãŸã€‚" : "ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä¸­æ–­ã—ã¾ã—ãŸã€‚");
            }

            tick() {
                this.state.currentTime--;
                this.updateDisplay();

                if (this.state.currentTime <= 0) {
                    this.stop(true);
                }
            }

            updateDisplay() {
                const minutes = Math.floor(this.state.currentTime / 60);
                const seconds = this.state.currentTime % 60;
                this.dom.timerDisplay.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                const progress = ((this.state.totalTime - this.state.currentTime) / this.state.totalTime) * 100;
                this.dom.progressFill.style.width = `${progress}%`;
            }

            startGuidance() {
                const scanType = this.dom.scanTypeSelect.value;
                if (scanType === 'body') {
                    this.startBodyScanGuidance();
                } else if (scanType === 'breathing') {
                    this.startBreathingGuide();
                    this.startGenericGuidance(scanType);
                } else {
                    this.startGenericGuidance(scanType);
                }
            }
            
            startBodyScanGuidance() {
                const partDuration = this.state.totalTime / this.bodyParts.length;
                let currentPartIndex = -1;
                
                this.guidanceInterval = setInterval(() => {
                    if(this.state.isPaused) return;
                    
                    const elapsed = this.state.totalTime - this.state.currentTime;
                    const newPartIndex = Math.min(Math.floor(elapsed / partDuration), this.bodyParts.length - 1);
                    
                    if (newPartIndex !== currentPartIndex) {
                        currentPartIndex = newPartIndex;
                        this.highlightBodyPart(currentPartIndex);
                    }
                }, 1000);
            }
            
            startGenericGuidance(scanType) {
                const texts = this.guidanceTexts[scanType];
                let textIndex = 0;
                this.showGuidanceText(texts[0]);
                
                const interval = Math.max(10000, (this.state.totalTime / texts.length) * 1000);

                this.state.guidanceInterval = setInterval(() => {
                    if (!this.state.isPaused) {
                        textIndex = (textIndex + 1) % texts.length;
                        this.showGuidanceText(texts[textIndex]);
                    }
                }, interval);
            }
            
            highlightBodyPart(index) {
                this.dom.bodyPartElements.forEach(el => el.classList.remove('active'));
                if (index < this.dom.bodyPartElements.length) {
                    this.dom.bodyPartElements[index].classList.add('active');
                    this.showGuidanceText(this.guidanceTexts.body[index]);
                }
            }

            showGuidanceText(text) {
                this.dom.guidanceText.classList.remove('show');
                setTimeout(() => {
                    this.dom.guidanceText.textContent = text;
                    this.dom.guidanceText.classList.add('show');
                }, 250);
            }
            
            startBreathingGuide() {
                const cycle = { inhale: 4000, hold: 4000, exhale: 6000 };
                let phase = 'inhale';

                const runPhase = () => {
                    if (!this.state.isRunning || this.state.isPaused) return;

                    switch (phase) {
                        case 'inhale':
                            this.updateBreathingVisuals('å¸ã£ã¦', 'inhale');
                            phase = 'hold';
                            this.state.breathingTimeout = setTimeout(runPhase, cycle.inhale);
                            break;
                        case 'hold':
                            this.updateBreathingVisuals('æ­¢ã‚ã¦');
                            phase = 'exhale';
                            this.state.breathingTimeout = setTimeout(runPhase, cycle.hold);
                            break;
                        case 'exhale':
                            this.updateBreathingVisuals('åã„ã¦', 'exhale');
                            phase = 'inhale';
                            this.state.breathingTimeout = setTimeout(runPhase, cycle.exhale);
                            break;
                    }
                };
                runPhase();
            }
            
            updateBreathingVisuals(text, state) {
                this.dom.breathingText.textContent = text;
                this.dom.breathingText.classList.add('show');

                if(state === 'inhale') {
                    this.dom.breathingCircle.classList.add('inhale');
                } else if (state === 'exhale') {
                    this.dom.breathingCircle.classList.remove('inhale');
                }
            }
            
            setDuration(seconds) {
                if (this.state.isRunning) return;
                this.state.currentTime = parseInt(seconds, 10);
                this.state.totalTime = this.state.currentTime;
                this.updateDisplay();
            }

            toggleControls(disabled) {
                this.dom.sessionSettings.disabled = disabled;
                this.dom.audioSettings.disabled = disabled;
            }
            
            updateBodyPartVisibility() {
                const show = this.dom.scanTypeSelect.value === 'body';
                this.dom.bodyPartsContainer.classList.toggle('hidden', !show);
                this.dom.breathingGuideContainer.classList.toggle('active', this.dom.scanTypeSelect.value === 'breathing');
            }

            resetVisuals() {
                this.dom.bodyPartElements.forEach(el => el.classList.remove('active'));
                this.dom.progressFill.style.width = '0%';
                this.dom.breathingCircle.classList.remove('inhale');
                this.dom.breathingText.classList.remove('show');
            }
            
            // --- Settings ---
            toggleBell() {
                this.state.bellEnabled = !this.state.bellEnabled;
                this.dom.bellToggle.textContent = `ğŸ”” ãƒ™ãƒ«éŸ³: ${this.state.bellEnabled ? 'ã‚ªãƒ³' : 'ã‚ªãƒ•'}`;
                this.dom.bellToggle.classList.toggle('active', this.state.bellEnabled);
            }

            toggleParticles() {
                this.state.particlesEnabled = !this.state.particlesEnabled;
                this.dom.particleToggle.textContent = `âœ¨ ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«: ${this.state.particlesEnabled ? 'ã‚ªãƒ³' : 'ã‚ªãƒ•'}`;
                document.getElementById('particles').style.display = this.state.particlesEnabled ? 'block' : 'none';
                this.dom.particleToggle.classList.toggle('active', this.state.particlesEnabled);
            }

            toggleTheme() {
                this.state.isDarkMode = !this.state.isDarkMode;
                document.body.classList.toggle('dark-mode', this.state.isDarkMode);
                this.dom.themeToggle.textContent = `${this.state.isDarkMode ? 'â˜€ï¸ ãƒ©ã‚¤ãƒˆ' : 'ğŸŒ™ ãƒ€ãƒ¼ã‚¯'}`;
                this.dom.themeToggle.classList.toggle('active', this.state.isDarkMode);
            }

            // --- Audio ---
            playBell() {
                this.dom.bellSound.currentTime = 0;
                this.dom.bellSound.play().catch(e => console.error("Bell sound failed:", e));
            }
            
            setBackgroundMusic(type) {
                this.stopBackgroundMusic();
                if (type !== 'none' && !this.state.isPaused) {
                    const bgm = this.dom[`bgm${type.charAt(0).toUpperCase() + type.slice(1)}`];
                    if (bgm) {
                        bgm.play().catch(e => console.error("BGM failed:", e));
                    }
                }
            }
            
            stopBackgroundMusic() {
                this.dom.bgmRain.pause();
                this.dom.bgmOcean.pause();
                this.dom.bgmForest.pause();
            }

            setVolume(volume) {
                const vol = parseFloat(volume);
                this.dom.bgmRain.volume = vol;
                this.dom.bgmOcean.volume = vol;
                this.dom.bgmForest.volume = vol;
                this.dom.bellSound.volume = vol;
            }

            // --- Particles ---
            createParticles() {
                const container = document.getElementById('particles');
                if (!container) return;
                for (let i = 0; i < 50; i++) {
                    const p = document.createElement('div');
                    p.classList.add('particle');
                    p.style.left = `${Math.random() * 100}%`;
                    p.style.animationDelay = `${Math.random() * 20}s`;
                    p.style.animationDuration = `${15 + Math.random() * 10}s`;
                    container.appendChild(p);
                }
            }

            // --- Stats Persistence ---
            loadStats() {
                const stats = localStorage.getItem('mindfulnessStats');
                this.state.stats = stats ? JSON.parse(stats) : {
                    totalSessions: 0, totalTime: 0, streak: 0,
                    todayTime: 0, lastSessionDate: null
                };
                
                const today = new Date().toDateString();
                if (this.state.stats.lastSessionDate !== today) {
                    this.state.stats.todayTime = 0;
                }
                
                this.updateStatsDisplay();
            }
            
            saveStats() {
                localStorage.setItem('mindfulnessStats', JSON.stringify(this.state.stats));
            }

            updateStats(completedSeconds) {
                const completedMinutes = Math.round(completedSeconds / 60);
                if (completedMinutes < 1) return; // Ignore sessions less than a minute

                this.state.stats.totalSessions++;
                this.state.stats.totalTime += completedMinutes;
                this.state.stats.todayTime += completedMinutes;

                const today = new Date();
                const yesterday = new Date();
                yesterday.setDate(today.getDate() - 1);
                
                if (this.state.stats.lastSessionDate !== today.toDateString()) {
                     if (this.state.stats.lastSessionDate === yesterday.toDateString()) {
                        this.state.stats.streak++;
                    } else {
                        this.state.stats.streak = 1;
                    }
                }
                
                this.state.stats.lastSessionDate = today.toDateString();
                this.saveStats();
                this.updateStatsDisplay();
            }
            
            updateStatsDisplay() {
                this.dom.totalSessions.textContent = this.state.stats.totalSessions;
                this.dom.totalTime.textContent = this.state.stats.totalTime;
                this.dom.streak.textContent = this.state.stats.streak;
                this.dom.todayTime.textContent = this.state.stats.todayTime;
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            new MindfulnessApp();
        });
    </script>
</body>
</html>

