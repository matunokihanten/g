<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>CSV エディター（機能拡張版）</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 20px;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 20px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: left;
      vertical-align: middle;
    }
    th {
      background: #f4f4f4;
    }
    td[contenteditable="true"] {
      background-color: #fffdd0;
    }
    button {
      cursor: pointer;
      padding: 4px 8px;
      margin-right: 4px;
      margin-bottom: 4px;
    }
    input[type="text"] {
      padding: 4px;
      font-size: 14px;
      margin-right: 4px;
    }
    /* ドラッグ中の行のスタイル */
    .dragging {
      opacity: 0.5;
    }
  </style>
</head>
<body>
  <h1>CSV エディター（機能拡張版）</h1>
  <p>
    Google パスワードからエクスポートした CSV を読み込み、データの編集・削除・検索・リンク切れチェック・備考一括入力、<br>
    さらにアンドゥ／リドゥおよびドラッグ＆ドロップによる行並び替えが可能なサンプルです。
  </p>
  <!-- 各種操作ボタン・検索欄 -->
  <input type="file" id="csvFileInput" accept=".csv" />
  <input type="text" id="searchInput" placeholder="検索…" />
  <label><input type="checkbox" id="regexToggle"> 正規表現検索</label>
  <button id="toggleLanguage">名前列を英語に切替</button>
  <button id="bulkNoteInput">備考一括入力</button>
  <button id="checkBrokenLinks">リンク切れチェック</button>
  <button id="undoBtn">アンドゥ</button>
  <button id="redoBtn">リドゥ</button>
  <button id="exportCsv">CSV エクスポート</button>
  
  <div id="tableContainer"></div>
  
  <script>
    /* グローバル変数 */
    let useEnglish = false;  // false: 日本語（名前）, true: 英語 (Name)
    let tableData = [];      // CSV ファイルから読み込んだデータ（各行の配列）
    let undoStack = [];
    let redoStack = [];

    // 固定ヘッダー（日本語／英語）
    const headersJP = ["名前", "URL", "ユーザー名", "パスワード", "備考"];
    const headersEN = ["Name", "URL", "Username", "Password", "Note"];

    // 深いコピー
    function deepCopy(data) {
      return JSON.parse(JSON.stringify(data));
    }

    // 状態保存
    function pushState() {
      undoStack.push(deepCopy(tableData));
      // 状態変更したら、redoスタックはクリア
      redoStack = [];
    }

    // CSV 各フィールドのエスケープ
    function escapeCSV(value) {
      if (value.indexOf(',') !== -1 || value.indexOf('"') !== -1 || value.indexOf('\n') !== -1) {
        value = value.replace(/"/g, '""');
        return `"${value}"`;
      }
      return value;
    }

    // 簡易的なCSVパーサー（引用符内のカンマ・改行は考慮していませんが基本ケースに対応）
    function parseCSV(text) {
      const rows = [];
      const lines = text.trim().split('\n');
      for (let line of lines) {
        let row = [];
        let current = "";
        let inQuotes = false;
        for (let i = 0; i < line.length; i++) {
          const char = line[i];
          if (char === '"') {
            if (inQuotes && line[i+1] === '"') {
              current += '"';
              i++;
            } else {
              inQuotes = !inQuotes;
            }
          } else if (char === ',' && !inQuotes) {
            row.push(current);
            current = "";
          } else {
            current += char;
          }
        }
        row.push(current);
        rows.push(row);
      }
      return rows;
    }

    // 正規表現または単純文字列を用いて文字列中の一致部分を赤くハイライトする
    function highlightText(text, query, useRegex) {
      if (!query) return text;
      try {
        let regExp;
        if (useRegex) {
          regExp = new RegExp(query, "gi");
        } else {
          // 特殊文字をエスケープして文字列検索にする
          regExp = new RegExp(query.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&'), "gi");
        }
        return text.replace(regExp, '<span style="color:red;">$&</span>');
      } catch (e) {
        // 無効な正規表現の場合はそのまま返す
        return text;
      }
    }

    // 行が検索クエリに一致するかチェック（各セルに対して）
    function rowMatchesQuery(row, query, useRegex) {
      if (!query) return true;
      for (let cell of row) {
        try {
          let regExp;
          if (useRegex) {
            regExp = new RegExp(query, "i");
          } else {
            regExp = new RegExp(query.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&'), "i");
          }
          if (regExp.test(cell)) return true;
        } catch(e) {
          if (cell.toLowerCase().indexOf(query.toLowerCase()) >= 0) return true;
        }
      }
      return false;
    }

    // テーブル描画（検索フィルター、ハイライト、ドラッグ＆ドロップ、URLクリック）
    function renderTable() {
      const container = document.getElementById("tableContainer");
      container.innerHTML = "";
      const table = document.createElement("table");

      // ヘッダー作成
      const headerRow = document.createElement("tr");
      const headerLabels = useEnglish ? headersEN : headersJP;
      headerLabels.forEach(label => {
        const th = document.createElement("th");
        th.textContent = label;
        headerRow.appendChild(th);
      });
      // 操作用列ヘッダー
      const actionTh = document.createElement("th");
      actionTh.textContent = "操作";
      headerRow.appendChild(actionTh);

      const thead = document.createElement("thead");
      thead.appendChild(headerRow);
      table.appendChild(thead);

      // 検索情報を取得
      const query = document.getElementById("searchInput").value.trim();
      const useRegex = document.getElementById("regexToggle").checked;

      // tbody を生成。各行は、tableData の全行から「検索に一致するもののみ」
      const tbody = document.createElement("tbody");
      tableData.forEach((row, originalIndex) => {
        if (!rowMatchesQuery(row, query, useRegex)) return; // 検索に一致しない行はスキップ

        const tr = document.createElement("tr");
        // 元の行番号を data-index に保持する（ドラッグ＆ドロップ用）
        tr.dataset.index = originalIndex;
        
        // 各セルを生成
        row.forEach((cell, colIndex) => {
          const td = document.createElement("td");

          // URL列（index==1）はリンクとして表示し、クリックで新タブで開く
          if (colIndex === 1) {
            // URLの値をハイライト付きで表示
            const a = document.createElement("a");
            a.href = cell;
            a.target = "_blank";
            a.innerHTML = highlightText(cell, query, useRegex);
            // URL列は編集不可
            td.appendChild(a);
          } else {
            // その他のセルは編集可能
            td.contentEditable = "true";
            td.innerHTML = highlightText(cell, query, useRegex);
            // セル編集完了後（blur）に状態を保存（※更新後のテキストを tableData に反映）
            td.onblur = function() {
              // 更新後の値を反映
              tableData[originalIndex][colIndex] = td.textContent;
              // 状態保存（アンドゥ用）
              pushState();
            }
          }
          tr.appendChild(td);
        });

        // 操作列：行削除ボタン
        const deleteTd = document.createElement("td");
        const delBtn = document.createElement("button");
        delBtn.textContent = "削除";
        delBtn.addEventListener("click", function(){
          tableData.splice(originalIndex, 1);
          pushState();
          renderTable();
        });
        deleteTd.appendChild(delBtn);
        tr.appendChild(deleteTd);

        // ドラッグ＆ドロップによる行並び替え（検索フィルターがクリアの場合のみ有効）
        if (query === "") {
          tr.draggable = true;
          tr.addEventListener("dragstart", function(e) {
            tr.classList.add("dragging");
            e.dataTransfer.setData("text/plain", tr.dataset.index);
          });
          tr.addEventListener("dragend", function(e) {
            tr.classList.remove("dragging");
          });
          tr.addEventListener("dragover", function(e) {
            e.preventDefault();
          });
          tr.addEventListener("drop", function(e) {
            e.preventDefault();
            const sourceIndex = Number(e.dataTransfer.getData("text/plain"));
            const targetIndex = Number(tr.dataset.index);
            // 両方のindexは tableData の元インデックスであるので、移動実施
            if (sourceIndex === targetIndex) return;
            const movedRow = tableData.splice(sourceIndex, 1)[0];
            // 挿入位置の補正（source が上なら targetIndex が変わる）
            tableData.splice(targetIndex, 0, movedRow);
            pushState();
            renderTable();
          });
        }
        tbody.appendChild(tr);
      });
      table.appendChild(tbody);
      container.appendChild(table);
    }

    // CSVファイルの読み込み
    document.getElementById("csvFileInput").addEventListener("change", function(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(e) {
        const text = e.target.result;
        const csvData = parseCSV(text);
        // 先頭行はヘッダーとみなすため、データとしては2行目以降を使用
        tableData = csvData.slice(1);
        pushState();
        renderTable();
      };
      reader.readAsText(file, 'UTF-8');
    });

    // 検索入力時に再描画（フィルタ＋ハイライト）
    document.getElementById("searchInput").addEventListener("input", renderTable);
    document.getElementById("regexToggle").addEventListener("change", renderTable);

    // 名前列の言語切替ボタン
    document.getElementById("toggleLanguage").addEventListener("click", function() {
      useEnglish = !useEnglish;
      this.textContent = useEnglish ? "名前列を日本語に切替" : "名前列を英語に切替";
      renderTable();
    });

    // 備考一括入力ボタン
    document.getElementById("bulkNoteInput").addEventListener("click", function() {
      const siteName = prompt("備考欄に入力するサイト名を入力してください。");
      if (siteName === null) return;
      tableData.forEach(row => {
        // 備考列は index==4（※存在しない場合は追加）
        row[4] = siteName;
      });
      pushState();
      renderTable();
    });

    // リンク切れチェックボタン
    document.getElementById("checkBrokenLinks").addEventListener("click", function() {
      const rows = document.querySelectorAll("#tableContainer table tbody tr");
      rows.forEach(tr => {
        // URL列は2番目（td:nth-child(2)）内の a 要素の href を取得
        const a = tr.querySelector("td:nth-child(2) a");
        if (!a) return;
        const url = a.href;
        // HEAD リクエストでチェック。CORS等の制約によりエラーとなるケースもあるので、例外的には失敗とみなす。
        fetch(url, { method: "HEAD" })
          .then(response => {
            // 200番台ならOKとする
            if (!response.ok) throw new Error("Non 200");
          })
          .catch(e => {
            // リンク切れとみなし、行全体の背景を紫に
            tr.style.backgroundColor = "purple";
          });
      });
    });

    // CSV エクスポート
    document.getElementById("exportCsv").addEventListener("click", function() {
      const headerLabels = useEnglish ? headersEN : headersJP;
      let csvContent = "";
      csvContent += headerLabels.map(escapeCSV).join(",") + "\n";
      tableData.forEach(row => {
        const escapedRow = row.map(escapeCSV);
        csvContent += escapedRow.join(",") + "\n";
      });
      const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "modified_passwords.csv";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    });

    // アンドゥ、リドゥ機能
    document.getElementById("undoBtn").addEventListener("click", function() {
      if (undoStack.length > 0) {
        redoStack.push(deepCopy(tableData));
        tableData = undoStack.pop();
        renderTable();
      } else {
        alert("これ以上アンドゥできません。");
      }
    });
    document.getElementById("redoBtn").addEventListener("click", function() {
      if (redoStack.length > 0) {
        undoStack.push(deepCopy(tableData));
        tableData = redoStack.pop();
        renderTable();
      } else {
        alert("これ以上リドゥできません。");
      }
    });
  </script>
</body>
</html>