
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>究極のCSV/Excelエディター</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f0f2f5;
    }

    .container {
      max-width: 1200px;
      margin: auto;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    h1 {
      color: #333;
      border-bottom: 2px solid #007BFF;
      padding-bottom: 10px;
      margin-bottom: 20px;
    }

    .controls, .export-controls, .column-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 20px;
      align-items: center;
    }

    button {
      background-color: #007BFF;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 5px;
      cursor: pointer;
      transition: background-color 0.3s ease;
      font-size: 14px;
    }

    button:hover {
      background-color: #0056b3;
    }

    button#printPreview {
      background-color: #6c757d;
    }

    button#printPreview:hover {
      background-color: #5a6268;
    }

    button#exportPDF {
      background-color: #dc3545;
    }

    button#exportPDF:hover {
      background-color: #c82333;
    }

    button#undoBtn, button#redoBtn {
      background-color: #ffc107;
      color: #333;
    }

    button#undoBtn:hover, button#redoBtn:hover {
      background-color: #e0a800;
    }
    
    input[type="file"], input[type="text"] {
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }

    input[type="checkbox"] {
      margin-right: 5px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      table-layout: fixed;
    }

    th, td {
      border: 1px solid #ddd;
      padding: 12px;
      text-align: left;
      vertical-align: middle;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    th {
      background: #e9ecef;
      color: #333;
      cursor: pointer;
      position: relative;
    }

    th:hover {
      background-color: #dee2e6;
    }

    td[contenteditable="true"] {
      background-color: #fffdd0;
      transition: background-color 0.3s ease;
    }

    td[contenteditable="true"]:focus {
      outline: 2px solid #007BFF;
    }

    .row-number {
      width: 50px;
      text-align: center;
      background: #f8f9fa;
      font-weight: bold;
    }

    .highlight {
      color: red;
      font-weight: bold;
      background-color: #ffebcc;
    }

    .invalid-url {
      border: 2px solid red;
    }

    .dragging {
      opacity: 0.5;
      border: 2px dashed #007BFF;
    }

    .sort-icon {
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 10px;
    }

    /* Print styles */
    @media print {
      body {
        margin: 0;
        padding: 0;
        background: none;
      }
      .container, .controls, .export-controls, .column-controls, h1, p {
        display: none;
      }
      #tableContainer {
        visibility: visible;
        display: block;
        position: static;
        width: auto;
      }
      table {
        box-shadow: none;
        table-layout: auto;
      }
      th, td {
        border: 1px solid #000;
        white-space: normal;
        overflow: visible;
      }
      .row-number, .action-column {
        display: none;
      }
    }
  </style>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.5.21/dist/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-yui-font/1.0.0/jspdf-yui-font.min.js"></script>
  <script>
    // jsPDFの日本語フォント設定
    jsPDF.API.events.push([
      'addFonts',
      function() {
        this.addFileToVFS('yui-light-normal.ttf', yuiFont);
        this.addFont('yui-light-normal.ttf', 'yui', 'normal');
      }
    ]);
  </script>
</head>
<body>

<div class="container">
  <h1>究極のCSV/Excelエディター</h1>
  <p>CSV/Excelファイルの読み込み、編集、検索、ソート、ドラッグ＆ドロップ、アンドゥ/リドゥ、そして多彩なエクスポート機能を備えた高機能エディターです。</p>

  <div class="controls">
    <input type="file" id="fileInput" accept=".csv, .xlsx" />
    <button id="addRowBtn">行を追加</button>
    <button id="clearTableBtn">全削除</button>
    <button id="toggleLanguage">名前列を英語に切替</button>
    <button id="insertFavicon">アイコン取得</button>
    <button id="undoBtn">アンドゥ ↩️</button>
    <button id="redoBtn">リドゥ ↪️</button>
  </div>

  <div class="controls">
    <input type="text" id="searchInput" placeholder="検索..." />
    <label><input type="checkbox" id="regexToggle"> 正規表現検索</label>
    <label><input type="checkbox" id="caseSensitiveToggle"> 大文字/小文字を区別</label>
  </div>

  <div class="export-controls">
    <button id="exportCsv">CSV エクスポート</button>
    <button id="exportExcel">Excel エクスポート</button>
    <button id="exportPDF">PDF エクスポート</button>
    <button id="exportHTML">HTML ファイルで保存</button>
    <button id="printPreview">印刷プレビュー</button>
  </div>

  <div class="column-controls">
    <strong>列表示切替: </strong>
    <label><input type="checkbox" class="colToggle" data-col="0" checked> <span class="colLabel" data-col="0">名前</span></label>
    <label><input type="checkbox" class="colToggle" data-col="1" checked> <span class="colLabel" data-col="1">URL</span></label>
    <label><input type="checkbox" class="colToggle" data-col="2" checked> <span class="colLabel" data-col="2">ユーザー名</span></label>
    <label><input type="checkbox" class="colToggle" data-col="3" checked> <span class="colLabel" data-col="3">パスワード</span></label>
    <label><input type="checkbox" class="colToggle" data-col="4" checked> <span class="colLabel" data-col="4">備考</span></label>
  </div>

  <div id="tableContainer"></div>
</div>

<script>
// ==================== グローバル変数と初期設定 ====================
let tableData = [];
let undoStack = [];
let redoStack = [];
let useEnglish = false;
let showIcons = false;
let sortColumn = -1;
let sortDirection = 'asc';
let visibleColumns = [true, true, true, true, true];

const headersJP = ["名前", "URL", "ユーザー名", "パスワード", "備考"];
const headersEN = ["Name", "URL", "Username", "Password", "Note"];
const localStorageKey = "csvEditorData";

// ==================== ヘルパー関数 ====================
function deepCopy(data) {
  return JSON.parse(JSON.stringify(data));
}

function pushState() {
  undoStack.push(deepCopy(tableData));
  redoStack = [];
  if (undoStack.length > 50) { // Keep stack size reasonable
    undoStack.shift();
  }
  saveToLocalStorage();
}

function saveToLocalStorage() {
  localStorage.setItem(localStorageKey, JSON.stringify(tableData));
}

function loadFromLocalStorage() {
  const storedData = localStorage.getItem(localStorageKey);
  if (storedData) {
    tableData = JSON.parse(storedData);
    pushState(); // Save initial state for undo
    renderTable();
  }
}

function escapeCSV(value) {
  if (typeof value !== 'string') value = String(value);
  if (value.indexOf(',') !== -1 || value.indexOf('"') !== -1 || value.indexOf('\n') !== -1) {
    value = value.replace(/"/g, '""');
    return `"${value}"`;
  }
  return value;
}

function parseCSV(text) {
  const rows = [];
  const lines = text.trim().split(/\r?\n/);
  for (const line of lines) {
    const row = [];
    let current = "";
    let inQuotes = false;
    for (let i = 0; i < line.length; i++) {
      const char = line[i];
      if (char === '"') {
        if (inQuotes && line[i + 1] === '"') {
          current += '"';
          i++;
        } else {
          inQuotes = !inQuotes;
        }
      } else if (char === ',' && !inQuotes) {
        row.push(current);
        current = "";
      } else {
        current += char;
      }
    }
    row.push(current);
    rows.push(row);
  }
  return rows;
}

function highlightText(text, query, useRegex, caseSensitive) {
  if (!query) return text;
  try {
    const flags = useRegex ? (caseSensitive ? "g" : "gi") : (caseSensitive ? "g" : "gi");
    let regExp;
    if (useRegex) {
      regExp = new RegExp(query, flags);
    } else {
      regExp = new RegExp(query.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&'), flags);
    }
    return text.replace(regExp, '<span class="highlight">$&</span>');
  } catch (e) {
    return text; // Return original text on regex error
  }
}

function rowMatchesQuery(row, query, useRegex, caseSensitive) {
  if (!query) return true;
  for (const cell of row) {
    try {
      const flags = useRegex ? (caseSensitive ? "i" : "") : (caseSensitive ? "i" : "");
      let regExp;
      if (useRegex) {
        regExp = new RegExp(query, flags);
      } else {
        const escapedQuery = query.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&');
        regExp = new RegExp(escapedQuery, flags);
      }
      if (regExp.test(cell)) return true;
    } catch(e) {
      // Fallback for simple search
      if (caseSensitive) {
        if (cell.indexOf(query) >= 0) return true;
      } else {
        if (cell.toLowerCase().indexOf(query.toLowerCase()) >= 0) return true;
      }
    }
  }
  return false;
}

function isValidURL(string) {
  try {
    new URL(string);
    return true;
  } catch (_) {
    return false;
  }
}

// ==================== メイン描画関数 ====================
function renderTable() {
  const container = document.getElementById("tableContainer");
  container.innerHTML = "";
  const table = document.createElement("table");

  // Header
  const headerRow = document.createElement("tr");
  const headerLabels = useEnglish ? headersEN : headersJP;
  
  // Row number header
  const thRowNumber = document.createElement("th");
  thRowNumber.textContent = "#";
  thRowNumber.style.width = "50px";
  headerRow.appendChild(thRowNumber);

  // Column headers with sorting
  headerLabels.forEach((label, index) => {
    if (!visibleColumns[index]) return;
    const th = document.createElement("th");
    th.textContent = label;
    th.dataset.colIndex = index;
    th.addEventListener("click", () => handleSort(index));
    const sortIcon = document.createElement("span");
    sortIcon.className = 'sort-icon';
    if (sortColumn === index) {
      sortIcon.textContent = sortDirection === 'asc' ? '▲' : '▼';
    }
    th.appendChild(sortIcon);
    headerRow.appendChild(th);
  });

  // Action header
  const actionTh = document.createElement("th");
  actionTh.textContent = "操作";
  actionTh.className = 'action-column';
  headerRow.appendChild(actionTh);
  const thead = document.createElement("thead");
  thead.appendChild(headerRow);
  table.appendChild(thead);

  // Body
  const query = document.getElementById("searchInput").value.trim();
  const useRegex = document.getElementById("regexToggle").checked;
  const caseSensitive = document.getElementById("caseSensitiveToggle").checked;
  
  // Apply sorting
  const sortedData = deepCopy(tableData);
  if (sortColumn !== -1) {
    sortedData.sort((a, b) => {
      const valA = a[sortColumn];
      const valB = b[sortColumn];
      let comparison = 0;
      if (valA > valB) comparison = 1;
      else if (valA < valB) comparison = -1;
      return sortDirection === 'asc' ? comparison : -comparison;
    });
  }

  const tbody = document.createElement("tbody");
  let rowIndex = 1;
  sortedData.forEach(row => {
    if (!rowMatchesQuery(row, query, useRegex, caseSensitive)) return;
    const tr = document.createElement("tr");
    tr.dataset.index = tableData.findIndex(d => JSON.stringify(d) === JSON.stringify(row));

    // Row number cell
    const rowNumberTd = document.createElement("td");
    rowNumberTd.textContent = rowIndex++;
    rowNumberTd.className = "row-number";
    tr.appendChild(rowNumberTd);

    row.forEach((cell, colIndex) => {
      if (!visibleColumns[colIndex]) return;
      const td = document.createElement("td");
      if (colIndex === 1) { // URL column
        if (showIcons) {
          try {
            const urlObj = new URL(cell);
            const faviconUrl = urlObj.origin + "/favicon.ico";
            const img = document.createElement("img");
            img.src = faviconUrl;
            img.style.width = "16px";
            img.style.height = "16px";
            img.style.marginRight = "8px";
            img.onerror = () => img.style.display = 'none'; // Hide if not found
            td.appendChild(img);
          } catch(e) { }
        }
        const a = document.createElement("a");
        a.href = cell;
        a.target = "_blank";
        a.innerHTML = highlightText(cell, query, useRegex, caseSensitive);
        td.appendChild(a);
        if (!isValidURL(cell)) {
          td.classList.add('invalid-url');
        }
      } else {
        td.contentEditable = "true";
        td.innerHTML = highlightText(cell, query, useRegex, caseSensitive);
        td.onblur = function() {
          const originalIndex = tr.dataset.index;
          if (tableData[originalIndex][colIndex] !== td.textContent) {
            tableData[originalIndex][colIndex] = td.textContent;
            pushState();
          }
        }
      }
      tr.appendChild(td);
    });

    // Action column
    const deleteTd = document.createElement("td");
    deleteTd.className = 'action-column';
    const delBtn = document.createElement("button");
    delBtn.textContent = "削除";
    delBtn.style.backgroundColor = '#dc3545';
    delBtn.style.color = 'white';
    delBtn.style.padding = '4px 8px';
    delBtn.addEventListener("click", function(){
      const originalIndex = tr.dataset.index;
      tableData.splice(originalIndex, 1);
      pushState();
      renderTable();
    });
    deleteTd.appendChild(delBtn);
    tr.appendChild(deleteTd);

    // Drag & Drop
    if (query === "") {
      tr.draggable = true;
      tr.addEventListener("dragstart", function(e) {
        tr.classList.add("dragging");
        e.dataTransfer.setData("text/plain", tr.dataset.index);
      });
      tr.addEventListener("dragend", function() {
        tr.classList.remove("dragging");
      });
      tr.addEventListener("dragover", function(e) {
        e.preventDefault();
        const dropTarget = e.target.closest("tr");
        if (dropTarget && dropTarget.draggable) {
          const bounding = dropTarget.getBoundingClientRect();
          const offset = bounding.y + bounding.height / 2;
          if (e.clientY < offset) {
            dropTarget.style.borderTop = "2px solid #007BFF";
            dropTarget.style.borderBottom = "none";
          } else {
            dropTarget.style.borderBottom = "2px solid #007BFF";
            dropTarget.style.borderTop = "none";
          }
        }
      });
      tr.addEventListener("dragleave", function(e) {
        e.target.style.borderTop = "none";
        e.target.style.borderBottom = "none";
      });
      tr.addEventListener("drop", function(e) {
        e.preventDefault();
        e.target.style.borderTop = "none";
        e.target.style.borderBottom = "none";
        const sourceIndex = Number(e.dataTransfer.getData("text/plain"));
        const targetIndex = Number(tr.dataset.index);
        if (sourceIndex === targetIndex) return;

        const movedRow = tableData.splice(sourceIndex, 1)[0];
        const insertIndex = targetIndex > sourceIndex ? targetIndex : targetIndex;
        tableData.splice(insertIndex, 0, movedRow);
        pushState();
        renderTable();
      });
    }
    tbody.appendChild(tr);
  });
  table.appendChild(tbody);
  container.appendChild(table);
}

// ==================== イベントハンドラ ====================
// File Input Handler
document.getElementById("fileInput").addEventListener("change", function(event) {
  const file = event.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = function(e) {
    const data = e.target.result;
    let parsedData = [];
    if (file.name.endsWith('.csv')) {
      parsedData = parseCSV(data);
    } else if (file.name.endsWith('.xlsx')) {
      const workbook = XLSX.read(data, { type: 'binary' });
      const sheetName = workbook.SheetNames[0];
      parsedData = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName], { header: 1 });
    } else {
      alert("サポートされていないファイル形式です。CSVまたはExcel（.xlsx）ファイルをアップロードしてください。");
      return;
    }
    
    // Assume first row is header
    tableData = parsedData.slice(1);
    pushState();
    renderTable();
  };
  reader.readAsBinaryString(file);
});

// Search & Language & Visibility Toggles
document.getElementById("searchInput").addEventListener("input", renderTable);
document.getElementById("regexToggle").addEventListener("change", renderTable);
document.getElementById("caseSensitiveToggle").addEventListener("change", renderTable);

document.getElementById("toggleLanguage").addEventListener("click", function() {
  useEnglish = !useEnglish;
  this.textContent = useEnglish ? "名前列を日本語に切替" : "名前列を英語に切替";
  updateColumnToggleLabels();
  renderTable();
});

document.querySelectorAll(".colToggle").forEach(checkbox => {
  checkbox.addEventListener("change", function() {
    const col = Number(this.getAttribute("data-col"));
    visibleColumns[col] = this.checked;
    renderTable();
  });
});

function updateColumnToggleLabels() {
  const labels = useEnglish ? headersEN : headersJP;
  document.querySelectorAll(".colLabel").forEach(labelElem => {
    const col = Number(labelElem.getAttribute("data-col"));
    labelElem.textContent = labels[col];
  });
}

// Data Manipulation
document.getElementById("addRowBtn").addEventListener("click", function() {
  const newRow = Array(headersJP.length).fill("");
  tableData.push(newRow);
  pushState();
  renderTable();
});

document.getElementById("clearTableBtn").addEventListener("click", function() {
  if (confirm("テーブルのデータをすべて削除してもよろしいですか？")) {
    tableData = [];
    pushState();
    renderTable();
  }
});

// Undo/Redo
document.getElementById("undoBtn").addEventListener("click", function() {
  if (undoStack.length > 1) {
    redoStack.push(undoStack.pop());
    tableData = deepCopy(undoStack[undoStack.length - 1]);
    renderTable();
  } else {
    alert("これ以上アンドゥできません。");
  }
});

document.getElementById("redoBtn").addEventListener("click", function() {
  if (redoStack.length > 0) {
    undoStack.push(redoStack.pop());
    tableData = deepCopy(undoStack[undoStack.length - 1]);
    renderTable();
  } else {
    alert("これ以上リドゥできません。");
  }
});

function handleSort(colIndex) {
  if (sortColumn === colIndex) {
    sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
  } else {
    sortColumn = colIndex;
    sortDirection = 'asc';
  }
  renderTable();
}

// Export Functions
document.getElementById("exportCsv").addEventListener("click", function() {
  const headerLabels = useEnglish ? headersEN : headersJP;
  const visibleHeaders = headerLabels.filter((_, index) => visibleColumns[index]);
  let csvContent = visibleHeaders.map(escapeCSV).join(",") + "\n";
  tableData.forEach(row => {
    const filteredRow = row.filter((_, index) => visibleColumns[index]);
    csvContent += filteredRow.map(escapeCSV).join(",") + "\n";
  });
  const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "data.csv";
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
});

document.getElementById("exportExcel").addEventListener("click", function() {
  const headerLabels = useEnglish ? headersEN : headersJP;
  const visibleHeaders = headerLabels.filter((_, index) => visibleColumns[index]);
  const data = [visibleHeaders, ...tableData.map(row => row.filter((_, index) => visibleColumns[index]))];
  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.aoa_to_sheet(data);
  XLSX.utils.book_append_sheet(wb, ws, "データ");
  XLSX.writeFile(wb, "data.xlsx");
});

document.getElementById("exportPDF").addEventListener("click", function() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF('landscape');
  doc.setFont('yui'); // Set Japanese font

  const headerLabels = useEnglish ? headersEN : headersJP;
  const visibleHeaders = headerLabels.filter((_, index) => visibleColumns[index]);
  const data = tableData.map(row => row.filter((_, index) => visibleColumns[index]));
  
  doc.autoTable({
    head: [visibleHeaders],
    body: data,
    theme: 'grid',
    styles: { font: 'yui', fontStyle: 'normal' }
  });

  doc.save("data.pdf");
});

document.getElementById("exportHTML").addEventListener("click", function() {
  const content = document.getElementById("tableContainer").innerHTML;
  const htmlDocument = `<!DOCTYPE html><html lang="ja"><head>
  <meta charset="UTF-8"><title>Exported Table</title>
  <style>
    body { font-family: sans-serif; margin: 20px; }
    table { border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background: #f4f4f4; }
  </style>
</head>
<body>${content}</body></html>`;
  const blob = new Blob([htmlDocument], { type: "text/html;charset=utf-8;" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "exported_table.html";
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
});

document.getElementById("printPreview").addEventListener("click", function() {
  window.print();
});

document.getElementById("insertFavicon").addEventListener("click", function() {
  showIcons = true;
  renderTable();
  alert("URL列の各行からfavicon（アイコン）を取得しました。");
});

// Initial load
loadFromLocalStorage();
</script>

</body>
</html>
