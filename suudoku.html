<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>数独ゲーム with キーパッド & ランダム生成</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 20px;
    }
    h1 {
      text-align: center;
      color: #333;
    }
    #game-container {
      max-width: 400px;
      margin: 0 auto;
    }
    table {
      border-collapse: collapse;
      margin: 10px auto;
    }
    td {
      width: 40px;
      height: 40px;
      border: 1px solid #333;
      text-align: center;
      vertical-align: middle;
      font-size: 18px;
    }
    input {
      width: 38px;
      height: 38px;
      border: none;
      outline: none;
      text-align: center;
      font-size: 18px;
    }
    .prefilled {
      background-color: #eee;
      font-weight: bold;
    }
    .error {
      background-color: #f99;
    }
    button {
      padding: 10px;
      font-size: 16px;
      cursor: pointer;
    }
    /* 数字キーパッド用 */
    #keypad-container {
      margin: 20px auto;
      text-align: center;
    }
    #keypad-table td {
      border: none;
      padding: 5px;
    }
    /* 通常の数字ボタン */
    #keypad-table button.num-btn {
      width: 60px;
      height: 60px;
      font-size: 20px;
    }
    /* クリアボタンは横長に */
    #keypad-table #clearBtn {
      width: 100%;
      height: 60px;
      font-size: 20px;
    }
    /* チェック・解答表示ボタン */
    #control-buttons {
      text-align: center;
      margin-top: 10px;
    }
    #message {
      text-align: center;
      font-size: 18px;
      margin-top: 10px;
      min-height: 24px;
    }
  </style>
</head>
<body>
  <h1>数独ゲーム</h1>
  <div id="game-container">
    <!-- 数独盤 -->
    <div id="sudoku-board"></div>
    <!-- 数字キーパッド -->
    <div id="keypad-container"></div>
    <!-- 操作用ボタン -->
    <div id="control-buttons">
      <button id="checkBtn">答えをチェック</button>
      <button id="solveBtn">答えを表示</button>
    </div>
    <div id="message"></div>
  </div>

  <script>
    // グローバル変数：選択中のセル
    let activeCell = null;
    let puzzleBoard, solvedBoard;

    // --- 数独盤面生成用ヘルパー関数 --- //

    // 配列のシャッフルを行う関数（フィッシャー–イェーツアルゴリズム）
    function shuffleArray(arr) {
      for (let i = arr.length - 1; i > 0; i--) {
        let j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    // 盤面内の (row, col) 位置に num を配置できるかチェック
    function isValid(board, row, col, num) {
      for (let i = 0; i < 9; i++) {
        if (board[row][i] === num) return false;
      }
      for (let i = 0; i < 9; i++) {
        if (board[i][col] === num) return false;
      }
      const startRow = Math.floor(row / 3) * 3;
      const startCol = Math.floor(col / 3) * 3;
      for (let r = 0; r < 3; r++) {
        for (let c = 0; c < 3; c++) {
          if (board[startRow + r][startCol + c] === num) return false;
        }
      }
      return true;
    }

    // 再帰的に盤面をランダムな順番で埋める（完全な解答盤面を生成）
    function fillBoard(board) {
      for (let row = 0; row < 9; row++) {
        for (let col = 0; col < 9; col++) {
          if (board[row][col] === 0) {
            let numbers = shuffleArray([1, 2, 3, 4, 5, 6, 7, 8, 9]);
            for (let num of numbers) {
              if (isValid(board, row, col, num)) {
                board[row][col] = num;
                if (fillBoard(board)) {
                  return true;
                }
                board[row][col] = 0;
              }
            }
            return false;
          }
        }
      }
      return true;
    }

    // 完全な解答盤面を生成して返す関数
    function generateCompleteBoard() {
      let board = [];
      for (let i = 0; i < 9; i++) {
        board.push(new Array(9).fill(0));
      }
      fillBoard(board);
      return board;
    }

    // 完全解答盤から指定数のセルを空にしてパズルを作成する
    function generatePuzzle(solvedBoard, removalCount) {
      let puzzle = solvedBoard.map(row => row.slice());
      let removed = 0;
      while (removed < removalCount) {
        let r = Math.floor(Math.random() * 9);
        let c = Math.floor(Math.random() * 9);
        if (puzzle[r][c] !== 0) {
          puzzle[r][c] = 0;
          removed++;
        }
      }
      return puzzle;
    }

    // --- ゲーム盤表示・操作用関数 --- //

    // 初期化：ランダムに生成したパズルとその解答を設定
    function initializeGame() {
      solvedBoard = generateCompleteBoard();
      // 例：40個のセルを除去してパズルを作成（難易度調整可）
      puzzleBoard = generatePuzzle(solvedBoard, 40);
    }

    // 数独盤を HTML テーブルとして表示する
    function displayBoard() {
      const boardDiv = document.getElementById("sudoku-board");
      let html = "<table>";
      for (let row = 0; row < 9; row++) {
        html += "<tr>";
        for (let col = 0; col < 9; col++) {
          const cellId = "cell-" + row + "-" + col;
          if (puzzleBoard[row][col] !== 0) {
            html += `<td class="prefilled">${puzzleBoard[row][col]}</td>`;
          } else {
            html += `<td><input type="text" id="${cellId}" maxlength="1" onfocus="activeCell = this" oninput="this.value = this.value.replace(/[^1-9]/g, '')"></td>`;
          }
        }
        html += "</tr>";
      }
      html += "</table>";
      boardDiv.innerHTML = html;
    }

    // 数字キーパッド（電卓レイアウト）を生成して設置
    function createKeypad() {
      const keypadContainer = document.getElementById("keypad-container");
      let keypadHTML = '<table id="keypad-table">';
      keypadHTML += "<tr>";
      keypadHTML += '<td><button class="num-btn" data-value="7">7</button></td>';
      keypadHTML += '<td><button class="num-btn" data-value="8">8</button></td>';
      keypadHTML += '<td><button class="num-btn" data-value="9">9</button></td>';
      keypadHTML += "</tr>";
      keypadHTML += "<tr>";
      keypadHTML += '<td><button class="num-btn" data-value="4">4</button></td>';
      keypadHTML += '<td><button class="num-btn" data-value="5">5</button></td>';
      keypadHTML += '<td><button class="num-btn" data-value="6">6</button></td>';
      keypadHTML += "</tr>";
      keypadHTML += "<tr>";
      keypadHTML += '<td><button class="num-btn" data-value="1">1</button></td>';
      keypadHTML += '<td><button class="num-btn" data-value="2">2</button></td>';
      keypadHTML += '<td><button class="num-btn" data-value="3">3</button></td>';
      keypadHTML += "</tr>";
      // 0 のボタンは削除し、クリアボタンを横いっぱいに配置
      keypadHTML += "<tr>";
      keypadHTML += '<td colspan="3"><button id="clearBtn">クリア</button></td>';
      keypadHTML += "</tr>";
      keypadHTML += "</table>";
      keypadContainer.innerHTML = keypadHTML;

      const numButtons = document.querySelectorAll(".num-btn");
      numButtons.forEach(button => {
        button.addEventListener("click", function () {
          if (activeCell) {
            activeCell.value = this.getAttribute("data-value");
            activeCell.classList.remove("error");
          }
        });
      });

      document.getElementById("clearBtn").addEventListener("click", function () {
        if (activeCell) {
          activeCell.value = "";
          activeCell.classList.remove("error");
        }
      });
    }

    // ユーザーの入力をチェック（正解と照合）
    function checkAnswer() {
      const messageDiv = document.getElementById("message");
      let correct = true;
      for (let row = 0; row < 9; row++) {
        for (let col = 0; col < 9; col++) {
          const cellId = "cell-" + row + "-" + col;
          const input = document.getElementById(cellId);
          if (input) {
            input.classList.remove("error");
          }
        }
      }
      for (let row = 0; row < 9; row++) {
        for (let col = 0; col < 9; col++) {
          if (puzzleBoard[row][col] === 0) {
            const cellId = "cell-" + row + "-" + col;
            const input = document.getElementById(cellId);
            const userVal = parseInt(input.value);
            if (userVal !== solvedBoard[row][col]) {
              correct = false;
              input.classList.add("error");
            }
          }
        }
      }
      messageDiv.textContent = correct ? "おめでとうございます！正解です。" : "入力に誤りがあります。再度挑戦してください。";
    }

    // 「答えを表示」ボタンで解答を盤面に反映
    function showSolution() {
      for (let row = 0; row < 9; row++) {
        for (let col = 0; col < 9; col++) {
          if (puzzleBoard[row][col] === 0) {
            const cellId = "cell-" + row + "-" + col;
            const input = document.getElementById(cellId);
            input.value = solvedBoard[row][col];
            input.classList.remove("error");
          }
        }
      }
      document.getElementById("message").textContent = "解答が表示されました。";
    }

    // --- 初期化処理 --- //
    initializeGame();
    displayBoard();
    createKeypad();
    document.getElementById("checkBtn").addEventListener("click", checkAnswer);
    document.getElementById("solveBtn").addEventListener("click", showSolution);
  </script>
</body>
</html>