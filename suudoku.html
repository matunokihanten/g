<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ•°ç‹¬ã‚²ãƒ¼ãƒ  - PCã¯ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã€ã‚¹ãƒãƒ›ã¯ã‚­ãƒ¼ãƒ‘ãƒƒãƒ‰å…¥åŠ›</title>
  <style>
    :root {
      --main-bg-color: #f5f5f5;
      --container-bg-color: #ffffff;
      --sudoku-border-color: #000000;
      --block-border-color: #000000;
      --cell-border-color: #999999;
      --prefilled-bg-color: #e9ecef;
      --prefilled-text-color: #333333;
      --editable-bg-color: #ffffff;
      --editable-text-color: #000000;
      --selected-bg-color: #cce5ff;
      --selected-border-color: #007bff;
      --highlight-same-bg-color: #fff3cd;
      --highlight-related-bg-color: #f8f9fa;
      --error-bg-color: #ffcccc;
      --error-text-color: #cc0000;
      --note-color: #888888;
      --primary-btn-bg: #007bff;
      --primary-btn-hover-bg: #0056b3;
      --primary-btn-text: #ffffff;
      --keypad-btn-bg: #f8f9fa;
      --keypad-btn-hover-bg: #e2e6ea;
      --keypad-btn-active-bg: #cce5ff;
      --keypad-btn-border: #cccccc;
    }
    
    body {
      font-family: 'Arial', sans-serif;
      margin: 20px;
      background-color: var(--main-bg-color);
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
    }
    h1 {
      text-align: center;
      color: #333;
      margin-bottom: 20px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
      font-size: 2.5rem;
    }
    #game-container {
      max-width: 550px;
      width: 100%;
      margin: 0 auto;
      background-color: var(--container-bg-color);
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    /* ã‚²ãƒ¼ãƒ ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¨çµ±è¨ˆ */
    #game-info {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      margin-bottom: 15px;
    }
    #game-options {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    #game-options select,
    #game-options button {
      padding: 8px 15px;
      font-size: 16px;
      border: 2px solid var(--primary-btn-bg);
      border-radius: 5px;
      background-color: white;
      cursor: pointer;
      transition: all 0.2s ease-in-out;
    }
    #game-options button {
      background-color: var(--primary-btn-bg);
      color: var(--primary-btn-text);
      border-color: var(--primary-btn-bg);
    }
    #game-options button:hover {
      background-color: var(--primary-btn-hover-bg);
    }
    #stats {
      font-size: 1.1rem;
      color: #666;
      display: flex;
      gap: 15px;
      white-space: nowrap;
    }

    /* æ•°ç‹¬ç›¤ã®ãƒ†ãƒ¼ãƒ–ãƒ« */
    #sudoku-board {
      margin-bottom: 15px;
    }
    table {
      border-collapse: collapse;
      margin: 0 auto;
      background-color: var(--editable-bg-color);
      border: 4px solid var(--sudoku-border-color);
      width: 100%;
      aspect-ratio: 1 / 1;
    }
    
    /* åŸºæœ¬ã®ã‚»ãƒ«ã‚¹ã‚¿ã‚¤ãƒ« */
    td {
      width: calc(100% / 9);
      height: calc(100% / 9);
      text-align: center;
      vertical-align: middle;
      font-size: 24px;
      font-weight: bold;
      border: 1px solid var(--cell-border-color);
      position: relative;
    }
    
    /* 3Ã—3ãƒ–ãƒ­ãƒƒã‚¯ã®å¢ƒç•Œç·šã‚’å¤ªãã™ã‚‹ */
    td:nth-child(3n) { border-right: 3px solid var(--block-border-color); }
    tr:nth-child(3n) td { border-bottom: 3px solid var(--block-border-color); }
    td:nth-child(9) { border-right: 1px solid var(--cell-border-color); }
    tr:nth-child(9) td { border-bottom: 1px solid var(--cell-border-color); }
    td:nth-child(3), td:nth-child(6) { border-right-width: 3px; }
    tr:nth-child(3) td, tr:nth-child(6) td { border-bottom-width: 3px; }

    /* å›ºå®šã‚»ãƒ«ï¼ˆåˆæœŸé…ç½®ã®æ•°å­—ï¼‰ */
    .prefilled {
      background-color: var(--prefilled-bg-color);
      color: var(--prefilled-text-color);
    }
    
    /* å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ */
    input {
      width: 95%;
      height: 95%;
      border: none;
      outline: none;
      text-align: center;
      font-size: 24px;
      font-weight: bold;
      cursor: pointer;
      background-color: transparent;
      box-sizing: border-box;
      color: var(--editable-text-color);
    }
    
    /* ã‚¨ãƒ©ãƒ¼è¡¨ç¤º */
    .error {
      background-color: var(--error-bg-color) !important;
      color: var(--error-text-color) !important;
    }
    
    /* é¸æŠã•ã‚ŒãŸã‚»ãƒ« */
    td.selected {
      background-color: var(--selected-bg-color) !important;
      outline: 3px solid var(--selected-border-color);
      outline-offset: -3px;
    }
    
    /* åŒã˜æ•°å­—ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆ */
    .highlight-same {
      background-color: var(--highlight-same-bg-color) !important;
    }
    
    /* é–¢é€£ã™ã‚‹è¡Œãƒ»åˆ—ãƒ»ãƒ–ãƒ­ãƒƒã‚¯ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆ */
    .highlight-related {
      background-color: var(--highlight-related-bg-color) !important;
    }

    /* ãƒ¡ãƒ¢ï¼ˆé‰›ç­†æ›¸ãï¼‰æ©Ÿèƒ½ */
    .notes-container {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      grid-template-rows: repeat(3, 1fr);
      padding: 3px;
      box-sizing: border-box;
      pointer-events: none;
    }
    .note {
      font-size: 10px;
      color: var(--note-color);
      display: flex;
      justify-content: center;
      align-items: center;
    }

    /* æ“ä½œç”¨ãƒœã‚¿ãƒ³ */
    #control-buttons {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
      margin-top: 20px;
      margin-bottom: 20px;
    }
    #control-buttons button {
      padding: 12px 18px;
      font-size: 16px;
      border-radius: 6px;
      cursor: pointer;
      border: 2px solid #28a745;
      background-color: #f8f9fa;
      transition: all 0.3s;
      flex-grow: 1;
      min-width: 80px;
    }
    #control-buttons button:hover {
      background-color: #28a745;
      color: white;
    }
    #control-buttons button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    #control-buttons button.toggle-active {
        background-color: #28a745;
        color: white;
    }
    #checkBtn, #solveBtn {
      background-color: #17a2b8;
      border-color: #17a2b8;
      color: white;
    }
    #checkBtn:hover, #solveBtn:hover {
      background-color: #138496;
    }

    /* æ•°å­—ã‚­ãƒ¼ãƒ‘ãƒƒãƒ‰ */
    #keypad-container {
      margin: 10px auto;
      text-align: center;
    }
    #keypad-table {
      margin: 0 auto;
      border: none;
    }
    #keypad-table td {
      border: none;
      padding: 5px;
      width: auto;
      height: auto;
    }
    .num-btn {
      width: 50px;
      height: 50px;
      font-size: 20px;
      font-weight: bold;
      border: 1px solid var(--keypad-btn-border);
      border-radius: 8px;
      background-color: var(--keypad-btn-bg);
      cursor: pointer;
      transition: all 0.2s;
    }
    .num-btn:hover {
      background-color: var(--keypad-btn-hover-bg);
    }
    .num-btn:active {
      background-color: var(--keypad-btn-active-bg);
      transform: scale(0.95);
    }
    #clearBtn {
      width: 100%;
      height: 50px;
      font-size: 18px;
      background-color: #dc3545;
      color: white;
      border: none;
    }
    #clearBtn:hover {
      background-color: #c82333;
    }

    /* ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º */
    #message {
      text-align: center;
      font-size: 1.1rem;
      font-weight: bold;
      margin-top: 15px;
      min-height: 40px;
      padding: 10px;
      border-radius: 5px;
    }
    .success {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .error-message {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .info {
      background-color: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }

    /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãƒ‡ã‚¶ã‚¤ãƒ³ */
    @media (max-width: 600px) {
      body { margin: 10px; }
      h1 { font-size: 1.8rem; margin-bottom: 15px; }
      #game-container { padding: 15px; }
      td { font-size: 18px; }
      input { font-size: 18px; }
      .note { font-size: 8px; }
      #stats { font-size: 0.9rem; gap: 10px; }
      #game-info { flex-direction: column; align-items: stretch; gap: 10px; }
      #game-options { justify-content: center; }
      #control-buttons button { padding: 10px; font-size: 14px; flex-basis: 30%; }
      .num-btn { width: 40px; height: 40px; font-size: 18px; }
      #clearBtn { height: 40px; font-size: 16px; }
    }
  </style>
</head>
<body>
  <h1>ğŸ¯ å®Œç’§ãªæ•°ç‹¬ã‚²ãƒ¼ãƒ </h1>
  <div id="game-container">
    <div id="game-info">
      <div id="game-options">
        <label for="difficultySelect">é›£æ˜“åº¦ï¼š</label>
        <select id="difficultySelect">
          <option value="20">è¶…æ˜“ã—ã„ (20å€‹å‰Šé™¤)</option>
          <option value="35">æ˜“ã—ã„ (35å€‹å‰Šé™¤)</option>
          <option value="45" selected>æ™®é€š (45å€‹å‰Šé™¤)</option>
          <option value="55">é›£ã—ã„ (55å€‹å‰Šé™¤)</option>
          <option value="65">è¶…é›£ã—ã„ (65å€‹å‰Šé™¤)</option>
        </select>
        <button id="newGameBtn">ğŸ® æ–°ã—ã„ã‚²ãƒ¼ãƒ </button>
      </div>

      <div id="stats">
        <span id="filled-count">å…¥åŠ›æ¸ˆã¿: 0/81</span>
        <span id="timer">æ™‚é–“: 00:00</span>
      </div>
    </div>

    <div id="sudoku-board"></div>
    
    <div id="control-buttons">
      <button id="undoBtn" title="å‰ã®æ“ä½œã«æˆ»ã‚‹">â†¶ Undo</button>
      <button id="redoBtn" title="å¾Œã®æ“ä½œã«é€²ã‚€">â†· Redo</button>
      <button id="notesToggleBtn" title="ãƒ¡ãƒ¢æ©Ÿèƒ½ã®ã‚ªãƒ³/ã‚ªãƒ•">âœï¸ ãƒ¡ãƒ¢</button>
      <button id="hintBtn" title="é¸æŠä¸­ã®ã‚»ãƒ«ã®ãƒ’ãƒ³ãƒˆã‚’è¡¨ç¤º">ğŸ’¡ ãƒ’ãƒ³ãƒˆ</button>
      <button id="validateBtn" title="ç¾åœ¨ã®å…¥åŠ›ãƒŸã‚¹ã‚’æ¤œè¨¼">âœ“ æ¤œè¨¼</button>
      <button id="solveBtn" title="è§£ç­”ã‚’è¡¨ç¤ºã—ã¦çµ‚äº†">ğŸ“‹ ç­”ãˆã‚’è¡¨ç¤º</button>
    </div>
    
    <div id="keypad-container"></div>
    
    <div id="message"></div>
  </div>

  <script>
    // ãƒ‡ãƒã‚¤ã‚¹åˆ¤å®š
    const isMobile = /Mobi|Android/i.test(navigator.userAgent);
    
    // ã‚²ãƒ¼ãƒ çŠ¶æ…‹ç®¡ç†
    let activeCell = null;
    let puzzleBoard, solvedBoard, initialBoard;
    let undoStack = [];
    let redoStack = [];
    let gameStartTime = null;
    let timerInterval = null;
    let isGameComplete = false;
    let isPaused = false;
    let notesMode = false;
    let boardStateHistory = [];
    let historyIndex = -1;

    // --- æ•°ç‹¬ç”Ÿæˆç”¨ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•° --- //
    /**
     * é…åˆ—ã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã™ã‚‹
     * @param {Array} arr - ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã™ã‚‹é…åˆ—
     * @returns {Array} - ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã•ã‚ŒãŸæ–°ã—ã„é…åˆ—
     */
    function shuffleArray(arr) {
      const newArr = [...arr];
      for (let i = newArr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [newArr[i], newArr[j]] = [newArr[j], newArr[i]];
      }
      return newArr;
    }

    /**
     * æŒ‡å®šã•ã‚ŒãŸä½ç½®ã«æ•°å­—ãŒé…ç½®å¯èƒ½ã‹ãƒã‚§ãƒƒã‚¯ã™ã‚‹
     * @param {Array<Array<number>>} board - ç¾åœ¨ã®ç›¤é¢
     * @param {number} row - è¡Œã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
     * @param {number} col - åˆ—ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
     * @param {number} num - é…ç½®ã™ã‚‹æ•°å­—
     * @returns {boolean} - é…ç½®å¯èƒ½ã§ã‚ã‚Œã°true
     */
    function isValidPlacement(board, row, col, num) {
      // è¡Œãƒ»åˆ—ãƒã‚§ãƒƒã‚¯
      for (let i = 0; i < 9; i++) {
        if (board[row][i] === num || board[i][col] === num) return false;
      }
      
      // 3Ã—3ãƒ–ãƒ­ãƒƒã‚¯ãƒã‚§ãƒƒã‚¯
      const startRow = Math.floor(row / 3) * 3;
      const startCol = Math.floor(col / 3) * 3;
      for (let r = 0; r < 3; r++) {
        for (let c = 0; c < 3; c++) {
          if (board[startRow + r][startCol + c] === num) return false;
        }
      }
      return true;
    }

    /**
     * ãƒãƒƒã‚¯ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ã§æ•°ç‹¬ã‚’è§£ãï¼ˆè§£ã®ä¸€æ„æ€§ãƒã‚§ãƒƒã‚¯ç”¨ï¼‰
     * @param {Array<Array<number>>} board - è§£ãç›¤é¢
     * @param {number} solutionsCount - è¦‹ã¤ã‹ã£ãŸè§£ã®æ•°
     * @returns {number} - è§£ã®æ•°
     */
    function solveSudokuWithCount(board, solutionsCount = 0) {
      for (let row = 0; row < 9; row++) {
        for (let col = 0; col < 9; col++) {
          if (board[row][col] === 0) {
            const numbers = shuffleArray([1, 2, 3, 4, 5, 6, 7, 8, 9]);
            for (let num of numbers) {
              if (isValidPlacement(board, row, col, num)) {
                board[row][col] = num;
                solutionsCount = solveSudokuWithCount(board, solutionsCount);
                if (solutionsCount > 1) return solutionsCount;
                board[row][col] = 0;
              }
            }
            return solutionsCount;
          }
        }
      }
      return solutionsCount + 1;
    }

    /**
     * å®Œå…¨ãªæ•°ç‹¬ç›¤é¢ã‚’ç”Ÿæˆã™ã‚‹
     * @returns {Array<Array<number>>} - å®Œæˆã—ãŸç›¤é¢
     */
    function generateCompleteBoard() {
      const board = Array(9).fill().map(() => Array(9).fill(0));
      function solve(b) {
        for (let row = 0; row < 9; row++) {
          for (let col = 0; col < 9; col++) {
            if (b[row][col] === 0) {
              const numbers = shuffleArray([1, 2, 3, 4, 5, 6, 7, 8, 9]);
              for (let num of numbers) {
                if (isValidPlacement(b, row, col, num)) {
                  b[row][col] = num;
                  if (solve(b)) return true;
                  b[row][col] = 0;
                }
              }
              return false;
            }
          }
        }
        return true;
      }
      solve(board);
      return board;
    }

    /**
     * é›£æ˜“åº¦ã«å¿œã˜ã¦ãƒã‚¹ã‚’å‰Šé™¤ã—ã€ãƒ‘ã‚ºãƒ«ã‚’ç”Ÿæˆã™ã‚‹
     * @param {Array<Array<number>>} solvedBoard - å®Œæˆã—ãŸç›¤é¢
     * @param {number} removalCount - å‰Šé™¤ã™ã‚‹ãƒã‚¹ã®æ•°
     * @returns {Array<Array<number>>} - ãƒ‘ã‚ºãƒ«ç›¤é¢
     */
    function generatePuzzle(solvedBoard, removalCount) {
      const puzzle = solvedBoard.map(row => [...row]);
      let removedCount = 0;
      const allCells = shuffleArray(Array.from({ length: 81 }, (_, i) => i));

      for (const cellIndex of allCells) {
        if (removedCount >= removalCount) break;

        const row = Math.floor(cellIndex / 9);
        const col = cellIndex % 9;
        
        if (puzzle[row][col] === 0) continue;
        
        const temp = puzzle[row][col];
        puzzle[row][col] = 0;

        // è§£ã®ä¸€æ„æ€§ã‚’ãƒã‚§ãƒƒã‚¯ (é«˜è² è·ã®ãŸã‚ç°¡ç•¥åŒ–)
        const tempBoard = puzzle.map(r => [...r]);
        if (solveSudokuWithCount(tempBoard) !== 1) {
          puzzle[row][col] = temp;
        } else {
          removedCount++;
        }
      }
      return puzzle;
    }
    
    // --- ã‚»ãƒ«é¸æŠãƒ»ãƒã‚¤ãƒ©ã‚¤ãƒˆæ©Ÿèƒ½ --- //
    /**
     * ã‚»ãƒ«ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸæ™‚ã®å‡¦ç†
     * @param {HTMLElement} element - ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸtdè¦ç´ 
     */
    function selectCell(element) {
      if (isGameComplete) return;

      const input = element.querySelector('input');
      const row = parseInt(element.dataset.row);
      const col = parseInt(element.dataset.col);
      
      clearHighlights();
      
      // å›ºå®šã‚»ãƒ«ã¯é¸æŠä¸å¯
      if (element.classList.contains('prefilled')) {
        activeCell = null;
        return;
      }
      
      activeCell = { element: element, input: input, row: row, col: col };
      element.classList.add('selected');
      
      // åŒã˜æ•°å­—ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
      const value = input.value;
      if (value) {
        highlightSameNumbers(value);
      }
      
      // é–¢é€£ã™ã‚‹è¡Œãƒ»åˆ—ãƒ»ãƒ–ãƒ­ãƒƒã‚¯ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
      highlightRelated(row, col);
      
      // ã‚¹ãƒãƒ›ã§ã¯ã‚­ãƒ¼ãƒ‘ãƒƒãƒ‰è¡¨ç¤º
      if (isMobile) {
        document.getElementById('keypad-container').style.display = 'block';
      }
    }

    /**
     * ã™ã¹ã¦ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’ã‚¯ãƒªã‚¢ã™ã‚‹
     */
    function clearHighlights() {
      document.querySelectorAll('td.selected, td.highlight-same, td.highlight-related, td.error').forEach(td => {
        td.classList.remove('selected', 'highlight-same', 'highlight-related', 'error');
      });
    }

    /**
     * åŒã˜æ•°å­—ã‚’æŒã¤ã‚»ãƒ«ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆã™ã‚‹
     * @param {string} num - ãƒã‚¤ãƒ©ã‚¤ãƒˆã™ã‚‹æ•°å­—
     */
    function highlightSameNumbers(num) {
      document.querySelectorAll('input').forEach(input => {
        if (input.value === num) {
          input.closest('td').classList.add('highlight-same');
        }
      });
    }

    /**
     * æŒ‡å®šã•ã‚ŒãŸã‚»ãƒ«ã«é–¢é€£ã™ã‚‹è¡Œãƒ»åˆ—ãƒ»ãƒ–ãƒ­ãƒƒã‚¯ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆã™ã‚‹
     * @param {number} row - è¡Œã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
     * @param {number} col - åˆ—ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
     */
    function highlightRelated(row, col) {
      for (let i = 0; i < 9; i++) {
        document.querySelector(`[data-row='${row}'][data-col='${i}']`).classList.add('highlight-related');
        document.querySelector(`[data-row='${i}'][data-col='${col}']`).classList.add('highlight-related');
      }
      const startRow = Math.floor(row / 3) * 3;
      const startCol = Math.floor(col / 3) * 3;
      for (let r = 0; r < 3; r++) {
        for (let c = 0; c < 3; c++) {
          document.querySelector(`[data-row='${startRow + r}'][data-col='${startCol + c}']`).classList.add('highlight-related');
        }
      }
    }
    
    // --- ãƒ¡ãƒ¢ï¼ˆé‰›ç­†æ›¸ãï¼‰æ©Ÿèƒ½ --- //
    function toggleNotesMode() {
        notesMode = !notesMode;
        const notesBtn = document.getElementById('notesToggleBtn');
        if (notesMode) {
            notesBtn.classList.add('toggle-active');
            showMessage("ãƒ¡ãƒ¢æ©Ÿèƒ½ãŒONã«ãªã‚Šã¾ã—ãŸã€‚è¤‡æ•°ã®æ•°å­—ã‚’å€™è£œã¨ã—ã¦å…¥åŠ›ã§ãã¾ã™ã€‚", "info");
        } else {
            notesBtn.classList.remove('toggle-active');
            showMessage("ãƒ¡ãƒ¢æ©Ÿèƒ½ãŒOFFã«ãªã‚Šã¾ã—ãŸã€‚", "info");
        }
    }
    
    function toggleNote(number) {
        if (!activeCell || activeCell.element.classList.contains('prefilled')) return;
        
        const cell = activeCell.element;
        const notesContainer = cell.querySelector('.notes-container');
        if (!notesContainer) return;
        
        const noteElement = notesContainer.querySelector(`.note[data-note='${number}']`);
        
        if (noteElement) {
            // ãƒ¡ãƒ¢ãŒå­˜åœ¨ã™ã‚Œã°å‰Šé™¤
            notesContainer.removeChild(noteElement);
            if (notesContainer.children.length === 0) {
                notesContainer.style.display = 'none';
            }
        } else {
            // ãƒ¡ãƒ¢ãŒå­˜åœ¨ã—ãªã‘ã‚Œã°è¿½åŠ 
            notesContainer.style.display = 'grid';
            const newNote = document.createElement('div');
            newNote.className = 'note';
            newNote.dataset.note = number;
            newNote.textContent = number;
            notesContainer.appendChild(newNote);
        }
        
        // å±¥æ­´ã«ä¿å­˜
        saveState();
    }
    
    // --- å…¥åŠ›å‡¦ç† --- //
    /**
     * æ•°å­—ã‚’å…¥åŠ›ã™ã‚‹
     * @param {string} value - å…¥åŠ›ã™ã‚‹æ•°å­— ('1'~'9')ã¾ãŸã¯ç©ºæ–‡å­—åˆ—
     */
    function inputNumber(value) {
        if (!activeCell || activeCell.element.classList.contains('prefilled') || isGameComplete) return;

        const cell = activeCell.element;
        const input = activeCell.input;
        const notesContainer = cell.querySelector('.notes-container');

        if (notesMode) {
            if (value === "") {
                 // ãƒ¡ãƒ¢ãƒ¢ãƒ¼ãƒ‰ã§ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸå ´åˆã€ãƒ¡ãƒ¢ã‚’å…¨æ¶ˆå»
                if (notesContainer) {
                    notesContainer.innerHTML = '';
                    notesContainer.style.display = 'none';
                }
            } else {
                // ãƒ¡ãƒ¢ãƒ¢ãƒ¼ãƒ‰ã§æ•°å­—ã‚’å…¥åŠ›
                input.value = '';
                toggleNote(value);
                clearHighlights();
                selectCell(cell);
            }
        } else {
            // é€šå¸¸ã®æ•°å­—å…¥åŠ›
            const oldValue = input.value;
            input.value = value;
            if (notesContainer) {
                notesContainer.innerHTML = '';
                notesContainer.style.display = 'none';
            }
            
            // å±¥æ­´ã«ä¿å­˜
            if (oldValue !== value) {
                saveState();
            }

            // ãƒã‚¤ãƒ©ã‚¤ãƒˆæ›´æ–°
            validateAll();
            clearHighlights();
            selectCell(cell);
            
            // å®Œæˆãƒã‚§ãƒƒã‚¯
            if (isBoardCompleteAndCorrect()) {
                completeGame();
            }
        }
        updateStats();
    }

    /**
     * PCç”¨ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰å…¥åŠ›å‡¦ç†
     * @param {Event} e - ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚¤ãƒ™ãƒ³ãƒˆ
     */
    function handleKeyboardInput(e) {
      if (!activeCell || isGameComplete) return;
      const key = e.key;
      const cell = activeCell.element;

      if (key >= '1' && key <= '9') {
        e.preventDefault();
        inputNumber(key);
      } else if (key === 'Backspace' || key === 'Delete' || key === '0') {
        e.preventDefault();
        inputNumber('');
      } else if (key === 'ArrowUp') {
        e.preventDefault();
        if (activeCell.row > 0) selectCell(document.querySelector(`[data-row='${activeCell.row - 1}'][data-col='${activeCell.col}']`));
      } else if (key === 'ArrowDown') {
        e.preventDefault();
        if (activeCell.row < 8) selectCell(document.querySelector(`[data-row='${activeCell.row + 1}'][data-col='${activeCell.col}']`));
      } else if (key === 'ArrowLeft') {
        e.preventDefault();
        if (activeCell.col > 0) selectCell(document.querySelector(`[data-row='${activeCell.row}'][data-col='${activeCell.col - 1}']`));
      } else if (key === 'ArrowRight') {
        e.preventDefault();
        if (activeCell.col < 8) selectCell(document.querySelector(`[data-row='${activeCell.row}'][data-col='${activeCell.col + 1}']`));
      }
    }
    
    // --- ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³æ©Ÿèƒ½ --- //
    /**
     * ã™ã¹ã¦ã®å…¥åŠ›ãƒŸã‚¹ã‚’æ¤œè¨¼ã—ã€ãƒã‚¤ãƒ©ã‚¤ãƒˆã™ã‚‹
     * @returns {boolean} - ã‚¨ãƒ©ãƒ¼ãŒãªã‘ã‚Œã°true
     */
    function validateAll() {
      let hasError = false;
      const currentBoard = getCurrentBoard();
      
      // å…¨ã¦ã®ã‚¨ãƒ©ãƒ¼ã‚¯ãƒ©ã‚¹ã‚’ã‚¯ãƒªã‚¢
      document.querySelectorAll('.error').forEach(el => el.classList.remove('error'));
      
      document.querySelectorAll('td.editable').forEach(cell => {
        const row = parseInt(cell.dataset.row);
        const col = parseInt(cell.dataset.col);
        const value = currentBoard[row][col];
        
        if (value !== 0) {
          const tempBoard = getCurrentBoard();
          tempBoard[row][col] = 0; // ç¾åœ¨ã®ã‚»ãƒ«ã‚’ä¸€æ™‚çš„ã«ç©ºã«ã—ã¦æ¤œè¨¼
          if (!isValidPlacement(tempBoard, row, col, value)) {
            cell.classList.add('error');
            hasError = true;
          }
        }
      });
      return !hasError;
    }

    /**
     * ç¾åœ¨ã®ç›¤é¢çŠ¶æ…‹ã‚’å–å¾—ã™ã‚‹
     * @returns {Array<Array<number>>} - ç›¤é¢çŠ¶æ…‹
     */
    function getCurrentBoard() {
      const board = Array(9).fill().map(() => Array(9).fill(0));
      document.querySelectorAll('td').forEach(cell => {
        const row = parseInt(cell.dataset.row);
        const col = parseInt(cell.dataset.col);
        const input = cell.querySelector('input');
        if (input && input.value) {
          board[row][col] = parseInt(input.value);
        } else if (cell.classList.contains('prefilled')) {
          board[row][col] = parseInt(cell.textContent);
        }
      });
      return board;
    }

    // --- ã‚²ãƒ¼ãƒ åˆæœŸåŒ–ãƒ»è¡¨ç¤º --- //
    /**
     * æ–°ã—ã„ã‚²ãƒ¼ãƒ ã‚’é–‹å§‹ã™ã‚‹
     */
    function newGame() {
      stopTimer();
      clearHighlights();
      activeCell = null;
      isGameComplete = false;
      isPaused = false;
      notesMode = false;
      document.getElementById('notesToggleBtn').classList.remove('toggle-active');
      
      showMessage("ãƒ‘ã‚ºãƒ«ã‚’ç”Ÿæˆä¸­...", "info");
      
      setTimeout(() => {
        const removalCount = parseInt(document.getElementById("difficultySelect").value);
        solvedBoard = generateCompleteBoard();
        initialBoard = generatePuzzle(solvedBoard, removalCount);
        
        displayBoard();
        createKeypad();
        updateStats();
        
        gameStartTime = new Date();
        startTimer();
        clearMessage();
        saveState(); // åˆæœŸçŠ¶æ…‹ã‚’å±¥æ­´ã«ä¿å­˜
      }, 100);
    }

    /**
     * ç›¤é¢ã‚’HTMLã«æç”»ã™ã‚‹
     */
    function displayBoard() {
      const boardDiv = document.getElementById("sudoku-board");
      let html = "<table><tbody>";
      
      for (let row = 0; row < 9; row++) {
        html += "<tr>";
        for (let col = 0; col < 9; col++) {
          const value = initialBoard[row][col];
          const isPrefilled = value !== 0;
          const cellClass = isPrefilled ? 'prefilled' : 'editable';
          
          html += `<td class="${cellClass}" data-row="${row}" data-col="${col}" tabindex="${isPrefilled ? -1 : 0}">`;
          if (isPrefilled) {
            html += value;
          } else {
            html += `<input type="text" maxlength="1" readonly>`;
            html += `<div class="notes-container" style="display: none;"></div>`;
          }
          html += "</td>";
        }
        html += "</tr>";
      }
      html += "</tbody></table>";
      boardDiv.innerHTML = html;
      
      document.querySelectorAll('td.editable').forEach(td => {
        td.addEventListener('click', () => selectCell(td));
      });
    }

    /**
     * ã‚­ãƒ¼ãƒ‘ãƒƒãƒ‰ã‚’ç”Ÿæˆã™ã‚‹
     */
    function createKeypad() {
      const keypadContainer = document.getElementById("keypad-container");
      let html = '<table id="keypad-table"><tbody>';
      
      const numbers = [
        [1, 2, 3],
        [4, 5, 6],
        [7, 8, 9]
      ];
      
      numbers.forEach(row => {
        html += "<tr>";
        row.forEach(num => {
          html += `<td><button class="num-btn" data-value="${num}">${num}</button></td>`;
        });
        html += "</tr>";
      });
      
      html += '<tr><td colspan="3"><button id="clearBtn">ğŸ—‘ï¸ ã‚¯ãƒªã‚¢</button></td></tr>';
      html += "</tbody></table>";
      
      if (isMobile) {
        keypadContainer.innerHTML = html;
        keypadContainer.style.display = 'none'; // é¸æŠã™ã‚‹ã¾ã§éè¡¨ç¤º
        
        document.querySelectorAll(".num-btn").forEach(button => {
          button.addEventListener("click", () => {
            if (activeCell) {
              inputNumber(button.dataset.value);
            }
          });
        });
        document.getElementById("clearBtn").addEventListener("click", () => {
          if (activeCell) {
            inputNumber("");
          }
        });
      } else {
        keypadContainer.innerHTML = '';
        keypadContainer.style.display = 'none';
      }
    }
    
    // --- å±¥æ­´ç®¡ç†ï¼ˆUndo/Redoï¼‰æ©Ÿèƒ½ --- //
    /**
     * ç¾åœ¨ã®ç›¤é¢çŠ¶æ…‹ã‚’å±¥æ­´ã«ä¿å­˜ã™ã‚‹
     */
    function saveState() {
        if (historyIndex < boardStateHistory.length - 1) {
            boardStateHistory = boardStateHistory.slice(0, historyIndex + 1);
        }
        const state = {
            values: [],
            notes: []
        };
        document.querySelectorAll('td.editable').forEach(cell => {
            const input = cell.querySelector('input');
            const notes = cell.querySelector('.notes-container');
            const row = parseInt(cell.dataset.row);
            const col = parseInt(cell.dataset.col);
            state.values.push({ row, col, value: input.value });
            if (notes) {
                const noteValues = Array.from(notes.children).map(note => note.textContent);
                if (noteValues.length > 0) {
                    state.notes.push({ row, col, notes: noteValues });
                }
            }
        });
        boardStateHistory.push(state);
        historyIndex++;
        updateUndoRedoButtons();
    }

    /**
     * å±¥æ­´ã‹ã‚‰ä¸€ã¤æˆ»ã‚‹
     */
    function doUndo() {
        if (historyIndex <= 0) return;
        historyIndex--;
        restoreState(boardStateHistory[historyIndex]);
    }

    /**
     * å±¥æ­´ã‹ã‚‰ä¸€ã¤é€²ã‚€
     */
    function doRedo() {
        if (historyIndex >= boardStateHistory.length - 1) return;
        historyIndex++;
        restoreState(boardStateHistory[historyIndex]);
    }

    /**
     * æŒ‡å®šã•ã‚ŒãŸå±¥æ­´ã®çŠ¶æ…‹ã‚’ç›¤é¢ã«å¾©å…ƒã™ã‚‹
     * @param {object} state - å¾©å…ƒã™ã‚‹çŠ¶æ…‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
     */
    function restoreState(state) {
        // ã™ã¹ã¦ã®å…¥åŠ›ã‚’ã‚¯ãƒªã‚¢
        document.querySelectorAll('td.editable input').forEach(input => input.value = '');
        document.querySelectorAll('.notes-container').forEach(notes => {
            notes.innerHTML = '';
            notes.style.display = 'none';
        });

        // å€¤ã‚’å¾©å…ƒ
        state.values.forEach(item => {
            const cell = document.querySelector(`[data-row='${item.row}'][data-col='${item.col}']`);
            if (cell) {
                cell.querySelector('input').value = item.value;
            }
        });

        // ãƒãƒ¼ãƒˆã‚’å¾©å…ƒ
        state.notes.forEach(item => {
            const cell = document.querySelector(`[data-row='${item.row}'][data-col='${item.col}']`);
            if (cell) {
                const notesContainer = cell.querySelector('.notes-container');
                notesContainer.style.display = 'grid';
                item.notes.forEach(noteVal => {
                    const newNote = document.createElement('div');
                    newNote.className = 'note';
                    newNote.dataset.note = noteVal;
                    newNote.textContent = noteVal;
                    notesContainer.appendChild(newNote);
                });
            }
        });
        
        validateAll();
        updateStats();
        updateUndoRedoButtons();
    }

    /**
     * Undo/Redoãƒœã‚¿ãƒ³ã®æœ‰åŠ¹/ç„¡åŠ¹çŠ¶æ…‹ã‚’æ›´æ–°ã™ã‚‹
     */
    function updateUndoRedoButtons() {
        document.getElementById('undoBtn').disabled = historyIndex <= 0;
        document.getElementById('redoBtn').disabled = historyIndex >= boardStateHistory.length - 1;
    }

    // --- ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«æ©Ÿèƒ½ --- //
    /**
     * é¸æŠä¸­ã®ã‚»ãƒ«ã«ãƒ’ãƒ³ãƒˆã‚’é©ç”¨ã™ã‚‹
     */
    function provideHint() {
      if (!activeCell || isGameComplete) {
        showMessage("ãƒ’ãƒ³ãƒˆã‚’é©ç”¨ã™ã‚‹ã‚»ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„", "error-message");
        return;
      }
      const hintVal = String(solvedBoard[activeCell.row][activeCell.col]);
      
      // ãƒ’ãƒ³ãƒˆã‚’é©ç”¨
      inputNumber(hintVal);
      showMessage("ãƒ’ãƒ³ãƒˆã‚’é©ç”¨ã—ã¾ã—ãŸ", "info");
    }

    /**
     * ç­”ãˆã‚’è¡¨ç¤ºã—ã¦ã‚²ãƒ¼ãƒ ã‚’çµ‚äº†ã™ã‚‹
     */
    function showSolution() {
      if (confirm("ç­”ãˆã‚’è¡¨ç¤ºã—ã¾ã™ã‹ï¼Ÿï¼ˆã‚²ãƒ¼ãƒ ãŒçµ‚äº†ã—ã¾ã™ï¼‰")) {
        for (let row = 0; row < 9; row++) {
          for (let col = 0; col < 9; col++) {
            if (initialBoard[row][col] === 0) {
              const cell = document.querySelector(`[data-row='${row}'][data-col='${col}']`);
              if (cell) {
                cell.querySelector('input').value = solvedBoard[row][col];
                const notesContainer = cell.querySelector('.notes-container');
                if (notesContainer) {
                    notesContainer.innerHTML = '';
                    notesContainer.style.display = 'none';
                }
              }
            }
          }
        }
        
        saveState();
        stopTimer();
        isGameComplete = true;
        validateAll();
        showMessage("è§£ç­”ãŒè¡¨ç¤ºã•ã‚Œã¾ã—ãŸ", "info");
      }
    }

    // --- ã‚²ãƒ¼ãƒ å®Œæˆå‡¦ç† --- //
    /**
     * ç›¤é¢ãŒå®Œæˆã—ã€ã‹ã¤æ­£è§£ã—ã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯ã™ã‚‹
     * @returns {boolean} - å®Œæˆã—ã¦ã„ã‚Œã°true
     */
    function isBoardCompleteAndCorrect() {
      const currentBoard = getCurrentBoard();
      for (let row = 0; row < 9; row++) {
        for (let col = 0; col < 9; col++) {
          if (currentBoard[row][col] !== solvedBoard[row][col]) {
            return false;
          }
        }
      }
      return true;
    }

    /**
     * ã‚²ãƒ¼ãƒ å®Œäº†æ™‚ã®å‡¦ç†
     */
    function completeGame() {
      if (isGameComplete) return;
      
      isGameComplete = true;
      stopTimer();
      
      const timeStr = document.getElementById("timer").textContent;
      showMessage(`ğŸ‰ ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼å®Œæˆã§ã™ï¼ ${timeStr}`, "success");
      
      // å®Œæˆå¾Œã¯æ“ä½œã‚’ç„¡åŠ¹åŒ–
      document.querySelectorAll('td.editable input').forEach(input => input.setAttribute('readonly', true));
      
      // èŠ±ç«ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
      let blinkCount = 0;
      const blinkInterval = setInterval(() => {
        document.querySelectorAll('td').forEach(td => {
          td.style.backgroundColor = blinkCount % 2 === 0 ? '#90EE90' : '';
        });
        blinkCount++;
        if (blinkCount > 6) {
          clearInterval(blinkInterval);
          document.querySelectorAll('td').forEach(td => {
            td.style.backgroundColor = '';
          });
        }
      }, 200);
    }

    // --- çµ±è¨ˆãƒ»ã‚¿ã‚¤ãƒãƒ¼ --- //
    /**
     * çµ±è¨ˆæƒ…å ±ã‚’æ›´æ–°ã™ã‚‹
     */
    function updateStats() {
      const filledCount = getFilledCellsCount();
      document.getElementById("filled-count").textContent = `å…¥åŠ›æ¸ˆã¿: ${filledCount}/81`;
    }

    /**
     * åŸ‹ã¾ã£ã¦ã„ã‚‹ã‚»ãƒ«ã®æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆã™ã‚‹
     * @returns {number} - åŸ‹ã¾ã£ã¦ã„ã‚‹ã‚»ãƒ«ã®æ•°
     */
    function getFilledCellsCount() {
      let count = 0;
      document.querySelectorAll('td').forEach(cell => {
        const input = cell.querySelector('input');
        if (cell.classList.contains('prefilled') || (input && input.value)) {
          count++;
        }
      });
      return count;
    }

    /**
     * ã‚¿ã‚¤ãƒãƒ¼ã‚’é–‹å§‹ã™ã‚‹
     */
    function startTimer() {
      stopTimer();
      timerInterval = setInterval(updateTimer, 1000);
    }

    /**
     * ã‚¿ã‚¤ãƒãƒ¼ã‚’åœæ­¢ã™ã‚‹
     */
    function stopTimer() {
      if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
      }
    }

    /**
     * ã‚¿ã‚¤ãƒãƒ¼ã‚’æ›´æ–°ã™ã‚‹
     */
    function updateTimer() {
      if (!gameStartTime || isPaused) return;
      
      const elapsed = Math.floor((new Date() - gameStartTime) / 1000);
      const minutes = Math.floor(elapsed / 60);
      const seconds = elapsed % 60;
      
      document.getElementById("timer").textContent = 
        `æ™‚é–“: ${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }

    // --- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º --- //
    /**
     * ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã™ã‚‹
     * @param {string} text - è¡¨ç¤ºã™ã‚‹ãƒ†ã‚­ã‚¹ãƒˆ
     * @param {string} className - ã‚¹ã‚¿ã‚¤ãƒ«ã‚¯ãƒ©ã‚¹
     */
    function showMessage(text, className = "") {
      const messageDiv = document.getElementById("message");
      messageDiv.textContent = text;
      messageDiv.className = className;
    }

    /**
     * ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚¯ãƒªã‚¢ã™ã‚‹
     */
    function clearMessage() {
      document.getElementById("message").textContent = "";
      document.getElementById("message").className = "";
    }

    // --- åˆæœŸåŒ–ãƒ»ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š --- //
    document.addEventListener("DOMContentLoaded", () => {
      newGame();
      
      // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
      document.addEventListener('keydown', handleKeyboardInput);
      document.addEventListener('click', (e) => {
          // ç›¤é¢å¤–ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã‚‰é¸æŠè§£é™¤
          if (!e.target.closest('#sudoku-board') && !e.target.closest('#keypad-container')) {
              clearHighlights();
              activeCell = null;
              if (isMobile) {
                  document.getElementById('keypad-container').style.display = 'none';
              }
          }
      });

      // ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
      document.getElementById("newGameBtn").addEventListener("click", newGame);
      document.getElementById("undoBtn").addEventListener("click", doUndo);
      document.getElementById("redoBtn").addEventListener("click", doRedo);
      document.getElementById("notesToggleBtn").addEventListener("click", toggleNotesMode);
      document.getElementById("hintBtn").addEventListener("click", provideHint);
      document.getElementById("validateBtn").addEventListener("click", () => {
          const isValid = validateAll();
          showMessage(isValid ? "ç¾åœ¨ã®å…¥åŠ›ã«ã‚¨ãƒ©ãƒ¼ã¯ã‚ã‚Šã¾ã›ã‚“ï¼" : "å…¥åŠ›ã«èª¤ã‚ŠãŒã‚ã‚Šã¾ã™ï¼ˆèµ¤è‰²ã®ã‚»ãƒ«ï¼‰", isValid ? "success" : "error-message");
      });
      document.getElementById("solveBtn").addEventListener("click", showSolution);
      
      // ã‚­ãƒ¼ãƒ‘ãƒƒãƒ‰ã®ã‚¤ãƒ™ãƒ³ãƒˆã¯createKeypadã§è¨­å®š
    });
  </script>
</body>
</html>
