<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>æ•°å­—ãƒ‘ã‚ºãƒ«è„³ãƒˆãƒ¬</title>
    <style>
        :root {
            /* ãƒ¢ãƒã‚¤ãƒ«ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ãƒãƒ¼è¡¨ç¤º/éè¡¨ç¤ºã«å¯¾å¿œã™ã‚‹ãŸã‚ã€å‹•çš„ãªãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆé«˜ã•ã‚’å®šç¾© */
            --app-height: 100vh;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            /* --app-height ã‚’ä½¿ç”¨ã—ã¦é«˜ã•ã‚’è¨­å®š */
            height: var(--app-height);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            padding: 10px;
            gap: 8px; /* å„UIè¦ç´ é–“ã®ã‚¹ãƒšãƒ¼ã‚¹ã‚’ç¢ºä¿ */
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 10px 15px;
            color: white;
            font-weight: bold;
            flex-shrink: 0; /* ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãŒç¸®ã¾ãªã„ã‚ˆã†ã«è¨­å®š */
        }

        .score-info {
            display: flex;
            gap: 15px;
            font-size: 14px;
        }

        .level-info {
            font-size: 16px;
            color: #ffd700;
        }

        .game-container {
            flex: 1; /* åˆ©ç”¨å¯èƒ½ãªã‚¹ãƒšãƒ¼ã‚¹ã‚’æœ€å¤§é™ä½¿ç”¨ */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 0; /* flexã‚¢ã‚¤ãƒ†ãƒ ãŒç¸®å°ã§ãã‚‹ã‚ˆã†ã«è¨­å®š */
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(10, 1fr);
            gap: 3px; /* å°‘ã—åºƒã’ã¦è¦–èªæ€§ã‚’å‘ä¸Š */
            background: rgba(255, 255, 255, 0.1);
            padding: 8px;
            border-radius: 12px;
            backdrop-filter: blur(5px);
            
            /* UI/UXæ”¹å–„ã®æ ¸ã¨ãªã‚‹éƒ¨åˆ†: ç”»é¢ã‚µã‚¤ã‚ºã«å¿œã˜ã¦ã‚°ãƒªãƒƒãƒ‰ã‚µã‚¤ã‚ºã‚’æœ€é©åŒ– */
            /* ç”»é¢ã®å¹…ã¨ã€ãƒ˜ãƒƒãƒ€ãƒ¼ãªã©ã‚’é™¤ã„ãŸé«˜ã•ã®ã†ã¡ã€å°ã•ã„æ–¹ã«åˆã‚ã›ã‚‹ */
            width: min(95vw, calc(var(--app-height) - 160px));
            aspect-ratio: 1; /* æ­£æ–¹å½¢ã‚’ç¶­æŒ */
            max-width: 600px; /* PCãªã©å¤§ç”»é¢ã§åºƒãŒã‚Šã™ããªã„ã‚ˆã†ã«åˆ¶é™ */
        }

        .cell {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(145deg, #ffffff, #e6e6e6);
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
            /* UI/UXæ”¹å–„: ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã‚‚ç”»é¢ã«å¿œã˜ã¦ã‚¹ã‚±ãƒ¼ãƒ«ã•ã›ã‚‹ */
            font-size: clamp(14px, 5vmin, 32px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
            touch-action: none; /* ã‚¿ãƒƒãƒæ“ä½œæ™‚ã®æ„å›³ã—ãªã„ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚„ã‚ºãƒ¼ãƒ ã‚’é˜²æ­¢ */
            border-radius: 4px; /* è§’ã‚’å°‘ã—ä¸¸ã‚ã‚‹ */
        }

        .cell:hover {
            transform: scale(1.05);
        }

        .cell.selected {
            background: linear-gradient(145deg, #ffd700, #ffed4e);
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.8);
            animation: pulse 0.5s ease-in-out;
        }

        .cell.matched {
            background: linear-gradient(145deg, #4CAF50, #66BB6A);
            color: white;
            animation: match-effect 0.6s ease-in-out forwards;
        }

        .cell.empty {
            background: transparent;
            box-shadow: none;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        @keyframes match-effect {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); background: #4CAF50; }
            100% { transform: scale(0); opacity: 0; }
        }

        .cell-content {
            animation: cell-appear 0.5s ease-out;
        }

        @keyframes cell-appear {
            from { transform: scale(0.5); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .combo-display {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 69, 0, 0.9);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 18px;
            font-weight: bold;
            z-index: 1000;
            animation: combo-popup 1s ease-out forwards;
            pointer-events: none;
            white-space: nowrap;
        }

        @keyframes combo-popup {
            0% { transform: translate(-50%, -50%) scale(0); opacity: 0; }
            50% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 0; }
        }

        .controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-shrink: 0; /* ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãŒç¸®ã¾ãªã„ã‚ˆã†ã«è¨­å®š */
        }

        .btn {
            padding: 8px 16px;
            background: linear-gradient(145deg, #4CAF50, #45a049);
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s ease;
            font-size: 14px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
            position: relative;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.3);
        }

        .btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .hint-btn {
            background: linear-gradient(145deg, #ff9800, #f57c00);
        }
        
        .shuffle-btn {
             background: linear-gradient(145deg, #03a9f4, #0288d1);
        }
        
        .shuffle-count {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #e74c3c;
            color: white;
            border-radius: 50%;
            font-size: 10px;
            width: 20px;
            height: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .special-effect {
            position: absolute;
            pointer-events: none;
            font-size: 20px;
            font-weight: bold;
            color: #ffd700;
            animation: float-up 1s ease-out forwards;
            z-index: 1000;
            text-shadow: 1px 1px 2px black;
        }

        @keyframes float-up {
            0% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-50px); }
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 3px;
            overflow: hidden;
            flex-shrink: 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #8BC34A);
            transition: width 0.3s ease;
            border-radius: 3px;
        }
        
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            animation: fade-in 0.5s;
        }

        .popup {
            background: white;
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
            animation: slide-up 0.5s;
            max-width: 90%;
        }

        .popup h2 {
            font-size: 24px;
            margin-bottom: 10px;
            color: #764ba2;
        }

        .popup p {
            font-size: 18px;
            margin-bottom: 20px;
            color: #555;
        }

        .popup-buttons .btn {
            margin: 0 5px;
        }
        
        @keyframes fade-in {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slide-up {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        @media (max-width: 400px) {
            .header { padding: 8px 12px; }
            .score-info { gap: 10px; font-size: 12px; }
            .level-info { font-size: 14px; }
            .btn { padding: 6px 12px; font-size: 12px; }
            .popup h2 { font-size: 20px; }
            .popup p { font-size: 16px; }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="score-info">
            <span>ã‚¹ã‚³ã‚¢: <span id="score">0</span></span>
            <span>ã‚³ãƒ³ãƒœ: <span id="combo">0</span></span>
            <span id="high-score-display">ãƒã‚¤ã‚¹ã‚³ã‚¢: 0</span>
        </div>
        <div class="level-info">
            Lv.<span id="level">1</span>
        </div>
    </div>
    
    <div class="progress-bar">
        <div class="progress-fill" id="progress"></div>
    </div>

    <div class="game-container">
        <div class="grid" id="grid"></div>
    </div>

    <div class="controls">
        <button class="btn shuffle-btn" id="shuffle-btn" onclick="requestShuffle()">ã‚·ãƒ£ãƒƒãƒ•ãƒ« (<span id="shuffle-count">3</span>)</button>
        <button class="btn hint-btn" onclick="showHint()">ãƒ’ãƒ³ãƒˆ</button>
        <button class="btn" onclick="requestReset()">ãƒªã‚»ãƒƒãƒˆ</button>
    </div>

    <div class="overlay" id="overlay">
        <div class="popup" id="popup">
            <h2 id="popup-title"></h2>
            <p id="popup-message"></p>
            <div class="popup-buttons" id="popup-buttons">
                <button class="btn" onclick="closePopup()">OK</button>
            </div>
        </div>
    </div>

    <script>
        let grid = [];
        let selectedCells = [];
        let score = 0;
        let combo = 0;
        let level = 1;
        let totalClears = 0;
        let shuffleCount = 3;
        const GRID_SIZE = 10;
        let isProcessing = false;
        let isSelecting = false;
        let highScore = localStorage.getItem('highScore') || 0;

        // UI/UXæ”¹å–„: ãƒ¢ãƒã‚¤ãƒ«ãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆã®é«˜ã•ã‚’å‹•çš„ã«è¨­å®š
        function setAppHeight() {
            const doc = document.documentElement;
            doc.style.setProperty('--app-height', `${window.innerHeight}px`);
        }
        window.addEventListener('resize', setAppHeight);
        setAppHeight(); // åˆæœŸãƒ­ãƒ¼ãƒ‰æ™‚ã«ã‚‚å®Ÿè¡Œ

        document.getElementById('high-score-display').textContent = `ãƒã‚¤ã‚¹ã‚³ã‚¢: ${highScore}`;

        function initializeGrid() {
            grid = [];
            for (let i = 0; i < GRID_SIZE; i++) {
                grid[i] = [];
                for (let j = 0; j < GRID_SIZE; j++) {
                    grid[i][j] = Math.floor(Math.random() * 10);
                }
            }
            renderGrid();
            updateDisplay();
            checkAndShuffleIfNoMatch();
        }

        function renderGrid() {
            const gridElement = document.getElementById('grid');
            gridElement.innerHTML = '';
            
            for (let i = 0; i < GRID_SIZE; i++) {
                for (let j = 0; j < GRID_SIZE; j++) {
                    const cell = document.createElement('div');
                    cell.className = 'cell';
                    cell.dataset.row = i;
                    cell.dataset.col = j;
                    
                    if (grid[i][j] !== null) {
                        const content = document.createElement('span');
                        content.className = 'cell-content';
                        content.textContent = grid[i][j];
                        content.style.color = getNumberColor(grid[i][j]);
                        cell.appendChild(content);
                    } else {
                        cell.classList.add('empty');
                    }
                    
                    setupCellEvents(cell);
                    gridElement.appendChild(cell);
                }
            }
        }

        function getNumberColor(num) {
            const colors = [
                '#e74c3c', '#3498db', '#2ecc71', '#f39c12', '#9b59b6',
                '#1abc9c', '#34495e', '#e67e22', '#95a5a6', '#c0392b'
            ];
            return colors[num];
        }

        function setupCellEvents(cell) {
            cell.addEventListener('mousedown', startSelection);
            cell.addEventListener('mouseenter', continueSelection);
            cell.addEventListener('touchstart', handleTouch, { passive: false });
            cell.addEventListener('touchmove', handleTouchMove, { passive: false });
        }
        
        function handleTouch(e) {
            e.preventDefault();
            startSelection(e);
        }

        function handleTouchMove(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const element = document.elementFromPoint(touch.clientX, touch.clientY);
            if (element && element.closest('.cell')) {
                continueSelection({ target: element.closest('.cell') });
            }
        }
        
        // ãƒã‚°ä¿®æ­£: touchend/touchcancelç”¨ã®ãƒãƒ³ãƒ‰ãƒ©ã‚’è¿½åŠ ã—ã¦ã‚¤ãƒ™ãƒ³ãƒˆã®äºŒé‡ç™ºç«ãªã©ã‚’é˜²ã
        function handleTouchEnd(e) {
            e.preventDefault();
            endSelection();
        }

        function startSelection(e) {
            const cell = e.target.closest('.cell');
            if (!cell || isProcessing || cell.classList.contains('empty')) return;
            
            isSelecting = true;
            clearSelection();
            selectCell(cell);
        }

        function continueSelection(e) {
            if (!isSelecting || isProcessing) return;
            
            const cell = e.target.closest('.cell');
            if (!cell || cell.classList.contains('empty')) return;
            
            if (!selectedCells.includes(cell)) {
                selectCell(cell);
            }
        }

        function selectCell(cell) {
            if (selectedCells.includes(cell)) {
                const index = selectedCells.indexOf(cell);
                if (index > -1 && index < selectedCells.length - 1) {
                    for (let i = selectedCells.length - 1; i > index; i--) {
                        selectedCells[i].classList.remove('selected');
                    }
                    selectedCells.splice(index + 1);
                }
            } else {
                selectedCells.push(cell);
                cell.classList.add('selected');
            }
        }

        function endSelection() {
            if (!isSelecting) return;

            if (selectedCells.length < 2 || isProcessing) {
                clearSelection();
                isSelecting = false;
                return;
            }
            
            if (isValidMatch()) {
                isProcessing = true;
                processMatch();
            } else {
                clearSelection();
            }
            
            isSelecting = false;
        }

        function isValidMatch() {
            if (selectedCells.length < 2) return false;
            
            const firstNum = parseInt(selectedCells[0].textContent);
            const allSame = selectedCells.every(cell => parseInt(cell.textContent) === firstNum);
            
            if (allSame) return true;
            
            if (selectedCells.length === 2) {
                const num1 = parseInt(selectedCells[0].textContent);
                const num2 = parseInt(selectedCells[1].textContent);
                return num1 + num2 === 10;
            }
            
            return false;
        }

        function processMatch() {
            const cellsToClear = [...selectedCells];
            
            const basePoints = cellsToClear.length * 10;
            const comboBonus = combo * 10;
            const levelBonus = level * 5;
            const points = basePoints + comboBonus + levelBonus;
            
            score += points;
            combo++;
            totalClears += cellsToClear.length;
            
            showSpecialEffect(`+${points}`, cellsToClear[0]);
            
            if (combo >= 3) {
                showComboEffect();
            }
            
            cellsToClear.forEach(cell => {
                cell.classList.add('matched');
            });
            
            setTimeout(() => {
                cellsToClear.forEach(cell => {
                    const row = parseInt(cell.dataset.row);
                    const col = parseInt(cell.dataset.col);
                    grid[row][col] = null;
                });
                
                applyGravity();
                selectedCells = [];
                updateDisplay();
                checkLevelUp();
                
                // Gravityã¨Fillã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³æ™‚é–“ã‚’è€ƒæ…®ã—ã¦ãƒ­ãƒƒã‚¯è§£é™¤ã‚’é…ã‚‰ã›ã‚‹
                setTimeout(() => {
                    isProcessing = false;
                    checkAndShuffleIfNoMatch();
                }, 600);
            }, 600);
        }

        function applyGravity() {
            for (let col = 0; col < GRID_SIZE; col++) {
                let emptyRow = -1;
                for (let row = GRID_SIZE - 1; row >= 0; row--) {
                    if (grid[row][col] === null) {
                        if (emptyRow === -1) emptyRow = row;
                    } else if (emptyRow !== -1) {
                        grid[emptyRow][col] = grid[row][col];
                        grid[row][col] = null;
                        emptyRow--;
                    }
                }
            }
            
            // ãƒ‡ãƒ¼ã‚¿æ›´æ–°å¾Œã€å°‘ã—é…ã‚Œã¦æç”»ã‚’æ›´æ–°ã—ã¦ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¦‹ã›ã‚‹
            setTimeout(() => {
                fillEmptySpaces();
            }, 300);
        }

        function fillEmptySpaces() {
            for (let col = 0; col < GRID_SIZE; col++) {
                for (let row = 0; row < GRID_SIZE; row++) {
                    if (grid[row][col] === null) {
                        grid[row][col] = Math.floor(Math.random() * 10);
                    }
                }
            }
            
            setTimeout(() => {
                renderGrid();
            }, 100);
        }

        function showSpecialEffect(text, element) {
            const effect = document.createElement('div');
            effect.className = 'special-effect';
            effect.textContent = text;
            document.body.appendChild(effect);
            
            const rect = element.getBoundingClientRect();
            effect.style.left = `${rect.left + rect.width / 2}px`;
            effect.style.top = `${rect.top}px`;
            
            setTimeout(() => {
                document.body.removeChild(effect);
            }, 1000);
        }

        function showComboEffect() {
            const comboDiv = document.createElement('div');
            comboDiv.className = 'combo-display';
            comboDiv.textContent = `${combo} ã‚³ãƒ³ãƒœ!`;
            document.body.appendChild(comboDiv);
            
            setTimeout(() => {
                document.body.removeChild(comboDiv);
            }, 1000);
        }
        
        function showGamePopup(title, message, buttons) {
            document.getElementById('popup-title').textContent = title;
            document.getElementById('popup-message').innerHTML = message.replace(/\n/g, '<br>'); // æ”¹è¡Œã‚’<br>ã«å¤‰æ›
            const popupButtons = document.getElementById('popup-buttons');
            popupButtons.innerHTML = '';
            buttons.forEach(btn => {
                const button = document.createElement('button');
                button.className = 'btn';
                button.textContent = btn.text;
                button.onclick = btn.action;
                popupButtons.appendChild(button);
            });
            document.getElementById('overlay').style.display = 'flex';
        }

        function closePopup() {
            document.getElementById('overlay').style.display = 'none';
        }

        function clearSelection() {
            selectedCells.forEach(cell => {
                cell.classList.remove('selected');
            });
            selectedCells = [];
            combo = 0;
            updateDisplay();
        }

        function updateDisplay() {
            document.getElementById('score').textContent = score;
            document.getElementById('combo').textContent = combo;
            document.getElementById('level').textContent = level;
            document.getElementById('shuffle-count').textContent = shuffleCount;
            
            const requiredClears = level * 50;
            const progress = (totalClears / requiredClears) * 100;
            document.getElementById('progress').style.width = Math.min(progress, 100) + '%';
            
            if (score > highScore) {
                highScore = score;
                localStorage.setItem('highScore', highScore);
                document.getElementById('high-score-display').textContent = `ãƒã‚¤ã‚¹ã‚³ã‚¢: ${highScore}`;
            }
        }

        function checkLevelUp() {
            const requiredClears = level * 50;
            if (totalClears >= requiredClears) {
                level++;
                totalClears = 0;
                shuffleCount = Math.min(5, shuffleCount + 1); // ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ã§ã‚·ãƒ£ãƒƒãƒ•ãƒ«å›æ•°ã‚’1å¢—ã‚„ã™ï¼ˆä¸Šé™5ï¼‰
                showSpecialEffect('LEVEL UP!ğŸ‰', document.querySelector('.header'));
                updateDisplay();
            }
        }
        
        function requestShuffle() {
            if (isProcessing) return;
            if (shuffleCount > 0) {
                showGamePopup(
                    'ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã—ã¾ã™ã‹ï¼Ÿ',
                    'ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã™ã‚‹ã¨ã‚¹ã‚³ã‚¢ãŒ20ç‚¹æ¸›ã‚Šã¾ã™ã€‚',
                    [
                        { text: 'ã¯ã„', action: () => shuffleGrid(true) },
                        { text: 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«', action: closePopup }
                    ]
                );
            } else {
                showGamePopup(
                    'ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã§ãã¾ã›ã‚“',
                    'ã‚·ãƒ£ãƒƒãƒ•ãƒ«å›æ•°ãŒæ®‹ã£ã¦ã„ã¾ã›ã‚“ã€‚',
                    [{ text: 'OK', action: closePopup }]
                );
            }
        }
        
        function shuffleGrid(isManual = false) {
            closePopup();
            if (isManual) {
                score = Math.max(0, score - 20);
            }
            combo = 0;
            shuffleCount--;
            
            const numbers = [];
            for (let i = 0; i < GRID_SIZE; i++) {
                for (let j = 0; j < GRID_SIZE; j++) {
                    if (grid[i][j] !== null) {
                        numbers.push(grid[i][j]);
                    }
                }
            }
            // Fisher-Yates shuffle
            for (let i = numbers.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [numbers[i], numbers[j]] = [numbers[j], numbers[i]];
            }

            let k = 0;
            for (let i = 0; i < GRID_SIZE; i++) {
                for (let j = 0; j < GRID_SIZE; j++) {
                    if (grid[i][j] !== null) {
                        grid[i][j] = numbers[k++];
                    }
                }
            }

            renderGrid();
            updateDisplay();
            isProcessing = true;
            setTimeout(() => {
                isProcessing = false;
                checkAndShuffleIfNoMatch();
            }, 500);
        }
        
        function showHint() {
            // ãƒã‚°ä¿®æ­£: isProcessingãƒ•ãƒ©ã‚°ã§ãƒ’ãƒ³ãƒˆè¡¨ç¤ºä¸­ã®å¤šé‡æ“ä½œã‚’é˜²æ­¢
            if (isProcessing) return;
            isProcessing = true;
            
            const match = findAnyMatch();
            if (match) {
                score = Math.max(0, score - 10);
                updateDisplay();
                const cell1 = document.querySelector(`[data-row="${match[0].row}"][data-col="${match[0].col}"]`);
                const cell2 = document.querySelector(`[data-row="${match[1].row}"][data-col="${match[1].col}"]`);
                
                if (cell1) cell1.style.background = 'linear-gradient(145deg, #ffeb3b, #ffc107)';
                if (cell2) cell2.style.background = 'linear-gradient(145deg, #ffeb3b, #ffc107)';
                
                setTimeout(() => {
                    renderGrid(); // å†æç”»ã—ã¦ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’æ¶ˆã™
                    isProcessing = false; // å‡¦ç†å®Œäº†
                }, 1500);
            } else {
                 showGamePopup(
                    'ãƒ’ãƒ³ãƒˆãªã—',
                    'ç¾åœ¨ã€ãƒãƒƒãƒã§ãã‚‹çµ„ã¿åˆã‚ã›ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚',
                    [{ text: 'OK', action: closePopup }]
                );
                isProcessing = false; // å‡¦ç†å®Œäº†
            }
        }

        function findAnyMatch() {
            for (let i = 0; i < GRID_SIZE; i++) {
                for (let j = 0; j < GRID_SIZE; j++) {
                    if (grid[i][j] === null) continue;
                    
                    const directions = [[-1,-1],[-1,0],[-1,1],[0,-1],[0,1],[1,-1],[1,0],[1,1]];
                    
                    for (let [di, dj] of directions) {
                        const ni = i + di, nj = j + dj;
                        if (ni >= 0 && ni < GRID_SIZE && nj >= 0 && nj < GRID_SIZE && grid[ni][nj] !== null) {
                            if (grid[i][j] === grid[ni][nj] || grid[i][j] + grid[ni][nj] === 10) {
                                return [{ row: i, col: j }, { row: ni, col: nj }];
                            }
                        }
                    }
                }
            }
            return null;
        }
        
        function checkAndShuffleIfNoMatch() {
            if (isProcessing) return;

            if (!findAnyMatch()) {
                if (shuffleCount > 0) {
                    showGamePopup(
                        'ãƒãƒƒãƒãŒã‚ã‚Šã¾ã›ã‚“ï¼',
                        'ç›¤é¢ã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã—ã¾ã™ã€‚<br>(ã‚·ãƒ£ãƒƒãƒ•ãƒ«å›æ•°ã‚’1æ¶ˆè²»)',
                        [{ text: 'OK', action: () => shuffleGrid(false) }]
                    );
                } else {
                    showGamePopup(
                        'ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼...',
                        `ã™ã¹ã¦ã®ã‚·ãƒ£ãƒƒãƒ•ãƒ«å›æ•°ã‚’ä½¿ã„æœãŸã—ã¾ã—ãŸã€‚\nã‚¹ã‚³ã‚¢: ${score}\nãƒã‚¤ã‚¹ã‚³ã‚¢: ${highScore}`,
                        [{ text: 'ãƒªãƒˆãƒ©ã‚¤', action: resetGame }]
                    );
                }
            }
        }

        function requestReset() {
            if (isProcessing) return;
            showGamePopup(
                'ã‚²ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ',
                'ç¾åœ¨ã®ã‚¹ã‚³ã‚¢ã¯å¤±ã‚ã‚Œã¾ã™ã€‚',
                [
                    { text: 'ã¯ã„', action: resetGame },
                    { text: 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«', action: closePopup }
                ]
            );
        }

        function resetGame() {
            closePopup();
            score = 0;
            combo = 0;
            level = 1;
            totalClears = 0;
            shuffleCount = 3;
            isProcessing = false;
            isSelecting = false;
            initializeGrid();
        }

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®ç™»éŒ²
        document.addEventListener('mouseup', endSelection);
        document.addEventListener('touchend', handleTouchEnd);
        document.addEventListener('touchcancel', handleTouchEnd);

        // ã‚²ãƒ¼ãƒ é–‹å§‹
        initializeGrid();
    </script>
</body>
</html>
