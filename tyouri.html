<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>注文記憶ゲーム - 色分け＆グループ分け（行配置）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      font-size: 18px;
      line-height: 1.6;
      background-color: #f4f7f6;
      color: #333;
    }
    h1 {
      text-align: center;
      color: #333;
      font-size: 2.2em;
      margin-bottom: 25px;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
    }
    .hidden {
      display: none;
    }
    /* モーダル共通スタイル */
    #settingsModal, #gameOverModal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: #fff;
      border: 1px solid #ccc;
      border-radius: 12px;
      padding: 30px;
      box-shadow: 0 6px 30px rgba(0,0,0,0.25);
      z-index: 100;
      width: 90%;
      max-width: 500px;
      box-sizing: border-box;
      text-align: center;
    }
    #settingsModal h2, #gameOverModal h2 {
        font-size: 1.8em;
        margin-bottom: 20px;
        color: #333;
        font-weight: bold;
    }
    #settingsModal label {
      margin-bottom: 12px;
      display: block;
      text-align: left;
      font-size: 1.1em;
      color: #555;
    }
    #settingsModal input[type="checkbox"] {
      margin-right: 8px;
      cursor: pointer;
      transform: scale(1.2);
    }
    #settingsModal input[type="file"] {
      width: calc(100% - 20px);
      margin-top: 8px;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
      background-color: #f9f9f9;
      cursor: pointer;
    }
    #settingsModal button, #gameOverModal button {
      width: auto;
      padding: 12px 25px;
      font-size: 1.1em;
      margin: 15px 10px 0;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      background-color: #007bff;
      color: white;
      transition: background-color 0.2s ease, transform 0.1s ease, box-shadow 0.2s ease;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    #settingsModal button:hover, #gameOverModal button:hover {
      background-color: #0056b3;
      transform: translateY(-2px);
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    }
    #settingsModal button:active, #gameOverModal button:active {
      transform: translateY(1px);
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    #settingsModal #closeSettingsBtn, #gameOverModal #closeGameOverBtn {
      background-color: #6c757d;
    }
    #settingsModal #closeSettingsBtn:hover, #gameOverModal #closeGameOverBtn:hover {
      background-color: #5a6268;
    }
    #saveMenuBtn {
      background-color: #28a745;
    }
    #saveMenuBtn:hover {
      background-color: #218838;
    }
    #modalOverlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.6);
      z-index: 50;
    }
    /* レベルコントロール */
    #levelControls {
      text-align: center;
      margin: 25px 0 35px;
      padding: 15px;
      background-color: #e9ecef;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    #levelIndicator {
      font-size: 1.3em;
      font-weight: bold;
      color: #444;
      display: block;
      margin-bottom: 10px;
    }
    /* ボタン全般 */
    button {
      font-size: 1.2em;
      padding: 12px 20px;
      margin: 10px;
      cursor: pointer;
      border: 1px solid #b0b0b0;
      border-radius: 8px;
      background-color: #e9ecef;
      color: #333;
      transition: background-color 0.2s, transform 0.1s, box-shadow 0.2s ease;
      white-space: nowrap;
      flex-shrink: 0;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    button:hover:not(:disabled) {
      background-color: #dee2e6;
      transform: translateY(-2px);
      box-shadow: 0 4px 10px rgba(0,0,0,0.15);
    }
    button:active:not(:disabled) {
      transform: translateY(1px);
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      box-shadow: none;
    }
    button.selected {
      background-color: #ffda6a;
      border-color: #ffc107;
      box-shadow: 0 0 12px rgba(255, 193, 7, 0.7);
      transform: translateY(-2px);
    }
    button.correct-answer {
        background-color: #28a745;
        color: white;
        border-color: #218838;
        box-shadow: 0 0 12px rgba(40, 167, 69, 0.7);
    }
    button.wrong-answer {
        background-color: #dc3545;
        color: white;
        border-color: #c82333;
        box-shadow: 0 0 12px rgba(220, 53, 69, 0.7);
    }

    /* 出題（覚える注文）表示エリア */
    #orderDisplay {
      font-size: 2.0em;
      margin: 30px auto;
      padding: 20px;
      background-color: #fff;
      border-radius: 12px;
      width: 90%;
      max-width: 900px;
      min-height: 100px;
      display: flex; /* flexboxに変更 */
      flex-wrap: wrap; /* 折り返しを有効に */
      gap: 20px;
      text-align: center;
      align-items: center;
      justify-content: center;
      word-break: break-word;
      font-weight: bold;
      color: #222;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      border: 1px solid #e0e0e0;
    }
    #orderDisplay .item-container {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      justify-content: center;
      margin-bottom: 10px;
    }
    #orderDisplay .item-container.hidden {
      display: none;
    }
    #orderDisplay div {
        flex: 1 1 auto; /* flexアイテムのサイズ調整 */
        padding: 10px 8px;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        background-color: #f8f9fa;
        min-height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background-color 0.2s ease;
        min-width: 100px; /* 最小幅を確保 */
    }
    /* 色分けモード用クラス */
    .color-group-0 { background-color: #e1f5fe; } /* Light Blue */
    .color-group-1 { background-color: #e8f5e9; } /* Light Green */
    .color-group-2 { background-color: #fff3e0; } /* Light Orange */
    .color-group-3 { background-color: #f3e5f5; } /* Light Purple */
    .color-group-4 { background-color: #ffebee; } /* Light Red */
    #menuButtons button.color-group-0 { background-color: #e1f5fe; }
    #menuButtons button.color-group-1 { background-color: #e8f5e9; }
    #menuButtons button.color-group-2 { background-color: #fff3e0; }
    #menuButtons button.color-group-3 { background-color: #f3e5f5; }
    #menuButtons button.color-group-4 { background-color: #ffebee; }
    
    #instruction {
      text-align: center;
      font-size: 1.5em;
      margin: 25px;
      font-weight: bold;
      color: #007bff;
    }
    #answerProgress {
        text-align: center;
        font-size: 1.2em;
        margin-top: -15px;
        margin-bottom: 10px;
        color: #666;
        font-style: italic;
    }
    #menuButtons {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      margin: 20px auto;
      max-width: 1000px;
    }
    #menuButtons button {
      min-width: 130px;
      height: 60px;
      font-size: 1.05em;
      margin: 8px;
    }
    #result {
      text-align: center;
      font-size: 1.8em;
      margin: 40px;
      font-weight: bold;
      color: #dc3545;
      padding: 15px;
      background-color: #fff;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.08);
    }
    #result.correct {
        color: #28a745;
    }
    #gameOverText {
        font-size: 1.5em;
        margin-bottom: 20px;
        color: #dc3545;
        font-weight: bold;
    }
    #gameOverScore {
        font-size: 1.2em;
        margin-bottom: 30px;
        color: #555;
    }
    /* スマートフォン向け調整 */
    @media (max-width: 768px) {
      body {
        font-size: 15px;
        margin: 15px;
      }
      h1 {
        font-size: 1.8em;
        margin-bottom: 20px;
      }
      button {
        font-size: 1em;
        padding: 10px 15px;
        margin: 6px;
      }
      #levelIndicator {
        font-size: 1.1em;
      }
      #orderDisplay {
        font-size: 1.6em;
        flex-direction: column; /* スマートフォンでは縦並び */
        gap: 12px;
        min-height: 80px;
        padding: 15px;
      }
      #orderDisplay .item-container {
        flex-direction: row; /* 行の中は横並び */
        gap: 8px;
      }
      #orderDisplay div {
          min-height: 35px;
          padding: 6px;
          flex: 1 1 auto;
      }
      #instruction {
        font-size: 1.2em;
        margin: 20px;
      }
      #answerProgress {
        font-size: 1.0em;
      }
      #menuButtons button {
        min-width: 90px;
        height: 50px;
        font-size: 0.9em;
        margin: 5px;
      }
      #result {
        font-size: 1.4em;
        margin: 25px;
        padding: 10px;
      }
      #settingsModal, #gameOverModal {
        padding: 20px;
      }
      #settingsModal button, #gameOverModal button {
        padding: 10px 20px;
        font-size: 1em;
        margin: 10px 8px 0;
      }
      #settingsModal input[type="file"] {
        padding: 6px;
      }
    }
  </style>
</head>
<body>
  <h1>注文記憶ゲーム</h1>
  
  <div style="text-align:center;">
    <button id="settingsBtn">設定</button>
  </div>
  
  <div id="modalOverlay" class="hidden"></div>
  <div id="settingsModal" class="hidden">
    <h2>設定</h2>
    <label>
      <input type="checkbox" id="roundModeCheckbox" checked>
      ラウンドモード (出題数 = レベル)
    </label><br>
    <label>
      <input type="checkbox" id="colorModeCheckbox">
      色分け＆グループ分けモード
    </label><br>
    <label>
      メニューファイル読み込み (JSON):
      <input type="file" id="jsonFileInput" accept=".json">
    </label><br>
    <button id="applySettingsBtn">設定を適用</button>
    <button id="closeSettingsBtn">閉じる</button>
    <button id="saveMenuBtn">メニューをJSONとして保存</button>
  </div>

  <div id="gameOverModal" class="hidden">
    <h2>ゲームオーバー</h2>
    <p id="gameOverText"></p>
    <p id="gameOverScore"></p>
    <button id="restartGameBtn">もう一度プレイ</button>
    <button id="closeGameOverBtn">閉じる</button>
  </div>
  
  <div id="levelControls">
    <span id="levelIndicator">レベル: 1 (あと3回ミスでゲームオーバー)</span><br>
    <button id="levelUpBtn">レベルアップ</button>
    <button id="levelDownBtn">レベルダウン</button>
  </div>
  
  <div id="gameControls" style="text-align: center;">
    <button id="startBtn">スタート</button>
  </div>
  
  <div id="orderDisplay"></div>
  
  <div id="instruction" class="hidden">
    覚えた料理をクリックして回答してください。
  </div>
  
  <div id="answerProgress"></div>
  
  <div id="menuButtons" class="hidden"></div>
  
  <div id="result"></div>
  
  <script>
    let menuItems = [
      "台湾ラーメン", "陳麻婆豆腐", "紅油鶏片", "古老肉", "回鍋肉片",
      "蒜苔肉絲", "魚香肉片", "蠣油肉片", "青椒肉絲", "青椒牛肉絲（大）",
      "水煮肉片", "牛筋と豆腐辛子煮込み", "四川回鍋肉", "杏鮑肉片", "糖醋丸子",
      "乾焼蝦仁", "生炒蝦仁", "宮保魷花", "乾焼明蝦", "中華えびマヨ",
      "腰果鶏丁", "辣子鶏丁", "炸子鶏", "油淋鶏（鶏もも）", "（骨あり）油淋鶏",
      "蛋花湯(小)", "蛋花湯(大)", "栗米湯(小)", "栗米湯(大)", "ﾜﾝﾀﾝ(6個)",
      "ﾜﾝﾀﾝ(12個)", "酸辣湯", "魚翅湯", "蛋花湯(小)", "チャーハン",
      "蝦仁炒飯", "中華丼", "麻婆丼", "天津飯", "ライス(小)",
      "ライス（中）", "ライス(並)", "ライス(大)", "カニ炒飯", "担々雑炊",
      "ラーメン(小)", "ザーサイ", "メンマ", "蒸し鶏入りサラダ", "１００円サラダ",
      "白菜キムチ", "カシュナッツ", "えびとかにの塩味中華丼", "棒々鶏（小）",
      "青椒牛肉絲（小）", "古老肉（小）", "回鍋肉片（小）", "魚香肉片（小）",
      "杏鮑肉片（小）", "東坡肉（小）", "蒜苔肉絲（小）", "八宝菜（小）",
      "乾焼蝦仁（小）", "天津飯 S", "にらレバー（小）", "金醤肉片（小）"
    ];
    
    let roundMode = true;
    let colorMode = false;
    let currentLevel = 1;
    let sequence = [];
    let userSelections = [];
    let consecutiveCorrects = 0;
    const MAX_MISTAKES = 3;
    let mistakesCount = 0;
    let menuGroups = {};

    const settingsBtn = document.getElementById("settingsBtn");
    const settingsModal = document.getElementById("settingsModal");
    const modalOverlay = document.getElementById("modalOverlay");
    const roundModeCheckbox = document.getElementById("roundModeCheckbox");
    const colorModeCheckbox = document.getElementById("colorModeCheckbox");
    const jsonFileInput = document.getElementById("jsonFileInput");
    const applySettingsBtn = document.getElementById("applySettingsBtn");
    const closeSettingsBtn = document.getElementById("closeSettingsBtn");
    const saveMenuBtn = document.getElementById("saveMenuBtn");
    const gameOverModal = document.getElementById("gameOverModal");
    const gameOverText = document.getElementById("gameOverText");
    const gameOverScore = document.getElementById("gameOverScore");
    const restartGameBtn = document.getElementById("restartGameBtn");
    const closeGameOverBtn = document.getElementById("closeGameOverBtn");
    const levelIndicator = document.getElementById("levelIndicator");
    const levelUpBtn = document.getElementById("levelUpBtn");
    const levelDownBtn = document.getElementById("levelDownBtn");
    const startBtn = document.getElementById("startBtn");
    const orderDisplay = document.getElementById("orderDisplay");
    const instructionDiv = document.getElementById("instruction");
    const answerProgressDiv = document.getElementById("answerProgress");
    const menuButtonsDiv = document.getElementById("menuButtons");
    const resultDiv = document.getElementById("result");

    const correctSound = new Audio('sounds/correct.mp3'); 
    const incorrectSound = new Audio('sounds/incorrect.mp3');

    // メニューをランダムにグループ分け
    function assignRandomGroups() {
      menuGroups = {};
      const numGroups = Math.min(5, Math.ceil(menuItems.length / 15));
      const shuffledItems = [...menuItems].sort(() => Math.random() - 0.5);
      
      shuffledItems.forEach((item, index) => {
        const group = index % numGroups;
        menuGroups[item] = group;
      });
    }

    settingsBtn.addEventListener("click", () => {
      modalOverlay.classList.remove("hidden");
      settingsModal.classList.remove("hidden");
      roundModeCheckbox.checked = roundMode;
      colorModeCheckbox.checked = colorMode;
      jsonFileInput.value = '';
    });

    closeSettingsBtn.addEventListener("click", () => {
      modalOverlay.classList.add("hidden");
      settingsModal.classList.add("hidden");
    });

    applySettingsBtn.addEventListener("click", () => {
      roundMode = roundModeCheckbox.checked;
      const prevColorMode = colorMode;
      colorMode = colorModeCheckbox.checked;
      
      if (jsonFileInput.files.length > 0) {
        const file = jsonFileInput.files[0];
        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const jsonMenu = JSON.parse(e.target.result);
            if (Array.isArray(jsonMenu) && jsonMenu.length > 0) {
              menuItems = jsonMenu;
              assignRandomGroups();
              initMenuButtons();
              alert("メニューが更新されました！");
              if (currentLevel > menuItems.length) {
                currentLevel = menuItems.length > 0 ? menuItems.length : 1;
                updateLevelIndicator();
              }
            } else {
              alert("JSON形式が正しくありません。配列で、かつ1つ以上の要素が必要です。");
            }
          } catch (err) {
            alert("JSONの読み込みに失敗しました。ファイルが破損しているか、形式が間違っています。");
            console.error("JSON parse error:", err);
          }
        };
        reader.readAsText(file);
      }
      
      if (colorMode !== prevColorMode) {
        initMenuButtons();
      }
      
      modalOverlay.classList.add("hidden");
      settingsModal.classList.add("hidden");
    });

    saveMenuBtn.addEventListener("click", () => {
      const jsonStr = JSON.stringify(menuItems, null, 2);
      const blob = new Blob([jsonStr], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "menu.json";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });

    restartGameBtn.addEventListener("click", () => {
      gameOverModal.classList.add("hidden");
      modalOverlay.classList.add("hidden");
      resetGame();
    });

    closeGameOverBtn.addEventListener("click", () => {
      gameOverModal.classList.add("hidden");
      modalOverlay.classList.add("hidden");
      resetGame(false);
      startBtn.disabled = false;
    });

    levelUpBtn.addEventListener("click", () => {
      if (currentLevel < menuItems.length) {
        currentLevel++;
        updateLevelIndicator();
      } else {
        alert("これ以上レベルを上げられません。登録されているメニューの数が上限です。");
      }
    });

    levelDownBtn.addEventListener("click", () => {
      if (currentLevel > 1) {
        currentLevel--;
        updateLevelIndicator();
      }
    });

    function updateLevelIndicator() {
      levelIndicator.textContent = `レベル: ${currentLevel} (あと${MAX_MISTAKES - mistakesCount}回ミスでゲームオーバー)`;
    }

    function initMenuButtons() {
      menuButtonsDiv.innerHTML = "";
      const shuffledMenuItems = menuItems.slice().sort(() => Math.random() - 0.5);
      shuffledMenuItems.forEach(item => {
        const btn = document.createElement("button");
        btn.textContent = item;
        btn.addEventListener("click", function() {
          onAnswerClick(item, this);
        });
        if (colorMode && menuGroups[item] !== undefined) {
          btn.classList.add(`color-group-${menuGroups[item]}`);
        }
        menuButtonsDiv.appendChild(btn);
      });
    }
    assignRandomGroups();
    initMenuButtons();

    function resetAnswerButtons() {
      Array.from(menuButtonsDiv.children).forEach(btn => {
        btn.classList.remove("selected", "correct-answer", "wrong-answer");
        btn.disabled = false;
        if (colorMode) {
          const groupClass = Array.from(btn.classList).find(cls => cls.startsWith('color-group-'));
          if (groupClass) {
            btn.style.backgroundColor = '';
          }
        }
      });
    }

    function resetGame(shouldStartGame = true) {
        currentLevel = 1;
        consecutiveCorrects = 0;
        mistakesCount = 0;
        updateLevelIndicator();
        resultDiv.textContent = "";
        resultDiv.classList.remove("correct");
        menuButtonsDiv.classList.add("hidden");
        instructionDiv.classList.add("hidden");
        answerProgressDiv.classList.add("hidden");
        orderDisplay.innerHTML = "";
        startBtn.disabled = false;
        assignRandomGroups();
        initMenuButtons();
        if (shouldStartGame) {
            startGame();
        }
    }

    function startGame() {
      resultDiv.textContent = "";
      resultDiv.classList.remove("correct");
      menuButtonsDiv.classList.add("hidden");
      instructionDiv.classList.add("hidden");
      answerProgressDiv.classList.add("hidden");
      resetAnswerButtons();
      userSelections = [];
      orderDisplay.innerHTML = "";
      startBtn.disabled = true;
      
      let numItemsToDisplay = roundMode ? currentLevel : 1;

      if (numItemsToDisplay > menuItems.length) {
        alert(`現在のレベル (${currentLevel} 品) は登録されているメニュー数 (${menuItems.length} 品) を超えています。レベルを下げてください。`);
        startBtn.disabled = false;
        return;
      }
      
      let availableMenuItems = [...menuItems];
      sequence = [];
      for (let i = 0; i < numItemsToDisplay; i++) {
        const randomIndex = Math.floor(Math.random() * availableMenuItems.length);
        sequence.push(availableMenuItems[randomIndex]);
        availableMenuItems.splice(randomIndex, 1);
      }
      
      // グループごとにアイテムを分類
      const groupedItems = {};
      sequence.forEach(item => {
        const group = colorMode ? menuGroups[item] : 'default';
        if (!groupedItems[group]) {
          groupedItems[group] = [];
        }
        groupedItems[group].push(item);
      });

      // グループごとにまとめて表示
      for (const group in groupedItems) {
        const container = document.createElement("div");
        container.classList.add("item-container");
        groupedItems[group].forEach(item => {
          const cell = document.createElement("div");
          cell.textContent = item;
          if (colorMode && menuGroups[item] !== undefined) {
            cell.classList.add(`color-group-${menuGroups[item]}`);
          }
          container.appendChild(cell);
        });
        orderDisplay.appendChild(container);
      }
      
      setTimeout(() => {
        const clickHandler = () => {
          document.removeEventListener("click", clickHandler);
          onScreenClick();
        };
        document.addEventListener("click", clickHandler, { once: true });
      }, 1500);
    }

    function onScreenClick() {
      // 全てのコンテナを非表示に
      Array.from(orderDisplay.children).forEach(container => container.classList.add("hidden"));
      instructionDiv.classList.remove("hidden");
      answerProgressDiv.classList.remove("hidden");
      menuButtonsDiv.classList.remove("hidden");
      startBtn.disabled = false;
      updateAnswerProgress();
    }

    function onAnswerClick(clickedItem, btn) {
        if (btn.classList.contains("correct-answer") || btn.classList.contains("wrong-answer")) {
            return;
        }

        if (btn.classList.contains("selected")) {
            btn.classList.remove("selected");
            const index = userSelections.indexOf(clickedItem);
            if (index > -1) {
                userSelections.splice(index, 1);
            }
        } else {
            if (userSelections.length < sequence.length) {
                btn.classList.add("selected");
                userSelections.push(clickedItem);
            } else {
                btn.animate([{ transform: 'translateX(-5px)' }, { transform: 'translateX(5px)' }, { transform: 'translateX(0px)' }], {
                    duration: 100,
                    iterations: 3
                });
                return;
            }
        }
        
        updateAnswerProgress();
        if (userSelections.length === sequence.length) {
            setTimeout(checkAnswer, 300);
        }
    }

    function updateAnswerProgress() {
        answerProgressDiv.textContent = `選択数: ${userSelections.length} / ${sequence.length}`;
    }

    function checkAnswer() {
      let correct = arraysEqualIgnoreOrder(userSelections, sequence);
      
      Array.from(menuButtonsDiv.children).forEach(btn => btn.disabled = true);

      if (correct) {
        resultDiv.innerHTML = "正解！記憶力抜群です！";
        resultDiv.classList.add("correct");
        consecutiveCorrects++;
        correctSound.play().catch(e => console.warn("Audio playback failed:", e));
        
        userSelections.forEach(item => {
            const btn = Array.from(menuButtonsDiv.children).find(b => b.textContent === item);
            if (btn) {
                btn.classList.add("correct-answer");
                btn.classList.remove("selected");
            }
        });
      } else {
        resultDiv.innerHTML = `不正解…<br>正解は:<br>${sequence.join(" ・ ")}`;
        resultDiv.classList.remove("correct");
        consecutiveCorrects = 0;
        mistakesCount++;
        incorrectSound.play().catch(e => console.warn("Audio playback failed:", e));

        const correctItemsSet = new Set(sequence);
        Array.from(menuButtonsDiv.children).forEach(btn => {
            const btnText = btn.textContent;
            if (userSelections.includes(btnText) && !correctItemsSet.has(btnText)) {
                btn.classList.add("wrong-answer");
                btn.classList.remove("selected");
            } else if (!userSelections.includes(btnText) && correctItemsSet.has(btnText)) {
                btn.classList.add("correct-answer");
            }
        });
      }
      updateLevelIndicator();

      if (mistakesCount >= MAX_MISTAKES) {
        setTimeout(showGameOver, 2000);
      } else {
        setTimeout(nextQuestion, 2000);
      }
    }
    
    function arraysEqualIgnoreOrder(arr1, arr2) {
      if (arr1.length !== arr2.length) return false;
      const sorted1 = arr1.slice().sort();
      const sorted2 = arr2.slice().sort();
      for (let i = 0; i < sorted1.length; i++) {
        if (sorted1[i] !== sorted2[i]) return false;
      }
      return true;
    }

    function showGameOver() {
        gameOverText.textContent = `残念！${MAX_MISTAKES}回間違えてしまいました。`;
        gameOverScore.textContent = `あなたの連続正解数は ${consecutiveCorrects} 回でした。`;
        modalOverlay.classList.remove("hidden");
        gameOverModal.classList.remove("hidden");
        startBtn.disabled = true;
        answerProgressDiv.classList.add("hidden");
    }

    function nextQuestion() {
      menuButtonsDiv.classList.add("hidden");
      instructionDiv.classList.add("hidden");
      answerProgressDiv.classList.add("hidden");
      resetAnswerButtons();
      userSelections = [];
      resultDiv.textContent = "";
      resultDiv.classList.remove("correct");
      startGame();
    }

    startBtn.addEventListener("click", startGame);

    updateLevelIndicator();
  </script>
</body>


<a href="https://px.a8.net/svt/ejp?a8mat=35UE1S+6V2WTU+CO4+6L9O1" rel="nofollow">
<img border="0" width="728" height="90" alt="" src="https://www25.a8.net/svt/bgt?aid=191214496415&wid=001&eno=01&mid=s00000001642001107000&mc=1"></a>
<img border="0" width="1" height="1" src="https://www14.a8.net/0.gif?a8mat=35UE1S+6V2WTU+CO
4+6L9O1" alt="">


</html>
